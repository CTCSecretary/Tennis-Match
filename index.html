<!DOCTYPE html><meta charset="UTF-8"><title>Social Tennis Match Maker</title><script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script><script src="Member Master List.js"></script><style>body{font-family:Arial,sans-serif;padding:20px;background:#f4f4f4}.logo-section{text-align:center;margin-bottom:20px;padding:15px;background:#fff;box-shadow:0 2px 4px rgba(0,0,0,.1)}.step-header{background:linear-gradient(135deg,#1e40af 0,#3b82f6 100%);color:#fff;font-size:24px;font-weight:700;padding:20px 30px;margin:-15px -15px 20px -15px;border-radius:8px 8px 0 0;text-align:left;box-shadow:0 2px 8px rgba(30,64,175,.3)}.logo{max-height:80px;max-width:100%;height:auto;border-radius:8px;transition:all .3s ease}.logo:hover{transform:scale(1.02);box-shadow:0 4px 12px rgba(0,0,0,.15)}h1{text-align:center;color:#333}.section{background:#fff;margin:15px 0;padding:15px;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,.1)}.error{color:red;font-weight:700}.success{color:green;font-weight:700}.warning{color:orange;font-weight:700}button{padding:10px 20px;margin:10px 5px;border:none;border-radius:5px;cursor:pointer}.primary{background:#007acc;color:#fff}.secondary{background:#6c757d;color:#fff}.danger{background:#dc3545;color:#fff}.court-pool{display:grid;grid-template-columns:repeat(auto-fill,minmax(80px,1fr));gap:8px;margin:15px 0;padding:15px;border:2px dashed #ddd;border-radius:8px;background:#fafafa;min-height:120px}.court-item{background:#007acc;color:#fff;padding:10px;text-align:center;border-radius:5px;cursor:move;user-select:none;font-weight:700;transition:all .2s}.court-item.grass-court{background:#28a745!important}.court-item.grass-court:hover{background:#1e7e34!important}.court-item.hard-court{background:#007acc!important}.court-item.hard-court:hover{background:#005a99!important}.available-courts .court-item.grass-court{background:#28a745!important}.available-courts .court-item.grass-court:hover{background:#1e7e34!important}.available-courts .court-item.hard-court{background:#007acc!important}.available-courts .court-item.hard-court:hover{background:#005a99!important}.court-item:hover{background:#005a99;transform:scale(1.05)}.court-item:hover{background:#005a99;transform:scale(1.05)}.court-item.dragging{opacity:.5}.available-courts{min-height:80px;padding:15px;border:2px dashed #28a745;border-radius:8px;background:#f8fff8;margin:15px 0}.available-courts.drag-over{border-color:#007acc;background:#e3f2fd}.available-courts .court-item{background:#28a745;margin:5px;display:inline-block}.available-courts .court-item:hover{background:#1e7e34}.player-table{width:100%;border-collapse:collapse;margin:15px 0}.player-table td,.player-table th{border:1px solid #ddd;padding:8px;text-align:left}.player-table th{background:#f8f9fa;font-weight:700}.player-table tr:nth-child(2n){background:#f9f9f9}.player-table tr:hover{background:#e8f4fd}.name-input{width:100%;padding:5px;border:1px solid #ddd;border-radius:3px;font-size:16px}.name-input:focus{border-color:#007acc;outline:0}.autocomplete-suggestions{position:absolute;background:#fff;border:1px solid #ddd;border-top:none;max-height:200px;overflow-y:auto;z-index:1000;width:100%}.autocomplete-suggestion{padding:8px;cursor:pointer;border-bottom:1px solid #eee;font-size:16px}.autocomplete-suggestion:hover{background:#e8f4fd}.autocomplete-suggestion.selected{background:#007acc;color:#fff}.checkbox-cell{text-align:center;width:60px}.status-checkbox{width:18px;height:18px;cursor:pointer}.gender-select,.grade-select{width:100%;padding:4px;border:1px solid #ddd;border-radius:3px;font-size:14px;background:#fff}.gender-select:focus,.grade-select:focus{border-color:#007acc;outline:0}.sit-off-calculator{background:#fff3cd;border:1px solid #ffc107;padding:15px;border-radius:5px;margin:15px 0;text-align:center;font-size:18px;font-weight:700}.sit-off-good{background:#d4edda;border-color:#28a745;color:#155724}.sit-off-bad{background:#f8d7da;border-color:#dc3545;color:#721c24}.manual-match-setup{border:2px solid #ffc107;background:#fff8dc;border-radius:8px;padding:15px;margin:15px 0}.manual-match-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}.manual-match-title{font-size:18px;font-weight:700;color:#856404}.manual-matches-list{margin:15px 0}.manual-match-item{background:#fff;border:1px solid #ffc107;border-radius:5px;padding:12px;margin:8px 0;display:flex;justify-content:space-between;align-items:center}.manual-match-details{flex:1}.manual-match-court{font-weight:700;color:#007acc;margin-bottom:5px}.manual-match-teams{font-size:14px;color:#333}.manual-player-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin:15px 0}.manual-player-item{background:#fff;border:1px solid #ddd;border-radius:5px;padding:8px;cursor:pointer;transition:all .2s;user-select:none}.manual-player-item:hover{border-color:#007acc;background:#f8f9fa}.manual-player-item.selected{background:#007acc;color:#fff;border-color:#0056b3}.manual-player-item.excluded{background:#f8f9f9;color:#6c757d;border-color:#dee2e6;cursor:not-allowed}.team-formation{display:grid;grid-template-columns:1fr auto 1fr;gap:20px;margin:20px 0;align-items:center}.team-slot{border:2px dashed #ddd;border-radius:8px;padding:15px;min-height:100px;background:#fafafa}.team-slot.has-players{border-color:#007acc;background:#e3f2fd}.team-slot-title{font-weight:700;margin-bottom:10px;text-align:center}.team-player{background:#fff;border:1px solid #007acc;border-radius:4px;padding:5px 8px;margin:3px 0;font-size:14px}.vs-divider{font-size:24px;font-weight:700;text-align:center;color:#666}.court-selector{margin:15px 0}.court-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(80px,1fr));gap:8px;margin:10px 0}.court-option{background:#fff;border:2px solid #ddd;border-radius:5px;padding:10px;text-align:center;cursor:pointer;transition:all .2s}.court-option:hover{border-color:#007acc}.court-option.selected{background:#007acc;color:#fff;border-color:#0056b3}.court-option.excluded{background:#f8f9f9;color:#6c757d;border-color:#dee2e6;cursor:not-allowed}.match-container{background:#f9f9f9;border:1px solid #ddd;padding:15px;margin:8px 0;border-radius:6px;border-left:4px solid #007acc}.match-container.manual-match{border-left:4px solid #ffc107;background:#fff8dc}.court-box{display:inline-block;background:#007acc;color:#fff;padding:8px 12px;border-radius:5px;margin-bottom:10px;font-weight:700;cursor:move;user-select:none}.court-box.manual{background:#ffc107;color:#856404}.court-box:hover{background:#005a99}.court-box.manual:hover{background:#e0a800}.court-box.dragging{opacity:.5}.court-box.drag-over{background:#28a745}.teams-row{display:flex;gap:20px;align-items:flex-start}.team-column{flex:1;min-height:80px}.team-header{font-weight:700;margin-bottom:8px;text-align:center;padding:5px;background:#e9e9e9;border-radius:3px}.player-box{background:#fff;border:2px solid #ddd;padding:8px;margin:4px 0;border-radius:5px;cursor:move;user-select:none;text-align:center;transition:all .2s ease}.player-box:hover{border-color:#007acc;box-shadow:0 2px 5px rgba(0,0,0,.2)}.player-box.dragging{opacity:.5;transform:rotate(2deg)}.player-box.nhc{background-color:#ffeb3b;font-weight:700}.player-box.nxd{background-color:#ffffe0;font-weight:700}.player-box.nhc.nxd{background:linear-gradient(90deg,#add8e6 0,#ffffe0 100%)!important;font-weight:700}.player-box.repeat-partner{background-color:#ff9800;border:2px solid #f57c00;font-weight:700}.player-box.manual-match{background-color:#fff8dc;border:2px solid #ffc107}.player-box.drag-over{border-color:#28a745;border-width:3px;background-color:#e8f5e8}.format{font-style:italic;color:#666;margin-top:8px;font-size:.9em}.info-box{background:#cff4fc;border:1px solid #0dcaf0;padding:15px;border-radius:5px;margin:15px 0}.warning-box{background:#fff3cd;border:1px solid #ffc107;padding:15px;border-radius:5px;margin:15px 0}.info-box{background:#cff4fc;border:1px solid #0dcaf0;padding:15px;border-radius:5px;margin:15px 0}.warning-box{background:#fff3cd;border:1px solid #ffc107;padding:15px;border-radius:5px;margin:15px 0}.selection-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:10px;margin:15px 0}.player-checkbox{display:flex;align-items:center;padding:8px;border:1px solid #ddd;border-radius:5px;background:#fff;cursor:pointer;transition:all .2s}.player-checkbox:hover{border-color:#007acc;background:#f8f9fa}.player-checkbox.pso{background-color:#fff3cd;border-color:#ffc107}.player-checkbox.selected{background-color:#d4edda;border-color:#28a745}.player-checkbox input{margin-right:10px}</style><div class="logo-section" style="position:relative"><div style="display:flex;align-items:center;justify-content:center;gap:20px"><img src="CTClogo.jpg" alt="Tennis Club Logo" class="logo"><h1 style="margin:0;color:#333">Social Tennis Match Maker</h1></div><div style="position:absolute;bottom:10px;right:15px;font-size:11px;color:#999">Â© 2025 Problems?: Paul Oen 0438 374 643</div></div><div id="memberLoadStatus" style="margin:15px 0"></div><div class="section"><div class="step-header">Step 1: Select available courts</div><h4>Selected Courts</h4><div id="availableCourts" class="available-courts"><em style="color:#666">Click or Drag courts here in the order they will be used</em></div><h4>Unselected Courts:</h4><div id="courtPool" class="court-pool"></div><button id="clearCourts" class="secondary">Clear All Courts</button></div><div class="section"><div class="step-header">Step 2: Choose match format and set number</div><div style="margin-bottom:15px"><label for="formatSelector" style="font-weight:700;margin-right:10px">Set Format Preference:</label> <select id="formatSelector" style="padding:8px;font-size:16px;border-radius:4px;border:1px solid #ccc"><option value="Same-Sex">Same-Sex Doubles<option value="Mixed">Mixed Doubles</select></div><div style="margin-bottom:15px"><label for="setNumberSelector" style="font-weight:700;margin-right:10px">Set Number:</label> <select id="setNumberSelector" style="padding:8px;font-size:16px;border-radius:4px;border:1px solid #ccc"><option value="1" selected="selected">Set 1<option value="2">Set 2<option value="3">Set 3<option value="4">Set 4<option value="5">Set 5<option value="6">Set 6</select></div></div><div id="playerSelectionSection" class="section" style="display:none"><div class="step-header">Step 3: Player Selection</div><div id="sitOffCalculator" class="sit-off-calculator">Players to sit off: <span id="sitOffCount">-</span></div><table class="player-table"><thead><tr><th style="width:200px">Name<th style="width:80px">Grade<th style="width:80px">Gender<th style="width:60px">NHC<th style="width:60px">NXD<th style="width:80px">Resting<th style="width:60px">PSO<th style="width:60px">SO<tbody id="playerTableBody"></table><div style="text-align:center;margin:15px 0"><button id="addMoreRows" class="secondary">Add 10 More Rows</button> <button id="updateMasterList" class="secondary" style="background:#28a745">Update Master List</button> <button id="proceedToMatches" class="primary" disabled="disabled">Proceed to Match Setup</button></div></div><div id="manualMatchSection" class="section" style="display:none"><div class="step-header">Step 4: Manual Match Setup (optional)</div><div class="manual-match-setup"><div class="manual-match-header"><button id="toggleManualSetup" class="secondary">Setup Manual Match</button></div><div id="manualSetupPanel" style="display:none"><div class="info-box"><h4>Create Manual Matches</h4><p>Set up special requests or exhibition games. These players will be excluded from automatic match generation.</div><div id="manualPlayerSelection"><h4>Available Players:</h4><div id="manualPlayerGrid" class="manual-player-grid"></div></div><div class="team-formation"><div id="team1Slot" class="team-slot"><div class="team-slot-title">Team 1</div><div id="team1Players"></div></div><div class="vs-divider">VS</div><div id="team2Slot" class="team-slot"><div class="team-slot-title">Team 2</div><div id="team2Players"></div></div></div><div class="court-selector"><h4>Select Court:</h4><div id="courtGrid" class="court-grid"></div></div><div style="text-align:center;margin:20px 0"><button id="addManualMatch" class="primary" disabled="disabled">Add Manual Match</button> <button id="clearManualSetup" class="secondary">Clear Setup</button></div></div><div id="manualMatchesList" class="manual-matches-list"></div></div><div style="text-align:center;margin:20px 0"><button id="generateMatches" class="primary">Generate Remaining Matches</button></div></div><div id="matches" class="section" style="display:none"><div class="step-header">Step 5: Generated Matches</div><div style="margin-bottom:15px"><button id="downloadBtn" class="primary" style="background:#28a745">ð¥ Download Results as Excel</button> <button id="printBtn" class="primary" style="background:#007acc;margin-left:10px">ð¨ï¸ Print Match Sheet</button></div><div id="matchResults"></div></div><script>let hasPlayerChanges=!1,masterListData=[],availableCourts=[],playerRows=[],debugLog=[],currentData=null,currentMatches=null,allSetsData={},currentSetNumber=1,manualMatches=[],selectedManualPlayers=[],selectedCourt=null,manualTeam1=[],manualTeam2=[];function log(e){console.log(e),debugLog.push(e)}function scrollToElement(e){const t=document.getElementById(e);t&&t.scrollIntoView({behavior:"smooth",block:"start"})}function translateGrade(e){switch(e){case 5:return"2";case 4:return"2A";case 3:return"2B";case 2:return"3";case 1:return"3A";default:return e}}function reverseTranslateGrade(e){switch(e){case"2":return 5;case"2A":return 4;case"2B":return 3;case"3":return 2;case"3A":return 1;default:return e}}function generateJSFileContent(e){let t="// Tennis Club Member Master List\n";return t+="// Generated on: "+(new Date).toLocaleString()+"\n",t+="// Total Members: "+e.length+"\n\n",t+="const MEMBERS = [\n",e.forEach((a,n)=>{t+="  {\n",t+=`    name: "${a.name}",\n`,t+=`    grade: ${a.grade},\n`,t+=`    gender: "${a.gender}",\n`,t+=`    nhc: ${a.nhc}\n`,t+="  }",n<e.length-1&&(t+=","),t+="\n"}),t+="];\n",t}function downloadJSFile(e){const t=new Blob([e],{type:"text/javascript"}),a=URL.createObjectURL(t),n=document.createElement("a");n.href=a;const r=(new Date).toISOString().slice(0,19).replace(/:/g,"-");n.download=`Member Master List - Updated ${r}.js`,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(a)}function initializeCourts(){const e=document.getElementById("courtPool");e.innerHTML="";const t=[];for(let e=1;e<=27;e++)t.push(e.toString());for(let e=1;e<=10;e++)t.push("H"+e);t.forEach(t=>{const a=document.createElement("div"),n=t.toString().toUpperCase().startsWith("H");a.className=n?"court-item hard-court":"court-item grass-court",a.textContent=t,a.draggable=!0,a.dataset.court=t,a.addEventListener("dragstart",handleCourtDragStart),a.addEventListener("dragend",handleCourtDragEnd),a.addEventListener("click",()=>moveCourtToSelected(t,a)),e.appendChild(a)})}function handleCourtDragStart(e){e.dataTransfer.setData("text/plain",e.target.dataset.court),e.target.classList.add("dragging")}function handleCourtDragEnd(e){e.target.classList.remove("dragging")}const availableCourtsDiv=document.getElementById("availableCourts");function generateUpdatedMasterList(){try{let e=[...masterListData];const t=playerRows.filter(e=>e.name&&""!==e.name.trim()&&""!==e.grade&&""!==e.gender);let a=0,n=0;t.forEach(t=>{const r=e.findIndex(e=>e.name.toLowerCase()===t.name.toLowerCase());if(r>=0){const a=e[r];a.grade===t.grade&&a.gender===t.gender&&a.nhc===t.nhc||(e[r]={name:t.name,grade:t.grade,gender:t.gender,nhc:t.nhc},n++)}else e.push({name:t.name,grade:t.grade,gender:t.gender,nhc:t.nhc}),a++}),e.sort((e,t)=>e.name.localeCompare(t.name));downloadJSFile(generateJSFileContent(e));const r=`Master list updated successfully!\nAdded: ${a} new players\nUpdated: ${n} existing players\nTotal players: ${e.length}`;alert(r),log(`Master list generated: ${a} added, ${n} updated, ${e.length} total`)}catch(e){alert(`Error generating master list: ${e.message}`),log(`Error generating master list: ${e.message}`)}}function updateAvailableCourtsDisplay(){const e=document.getElementById("availableCourts");0!==availableCourts.length?(e.innerHTML="",availableCourts.forEach((t,a)=>{const n=document.createElement("div"),r=t.toString().toUpperCase().startsWith("H");n.className=r?"court-item hard-court":"court-item grass-court",n.textContent=t,n.style.cursor="pointer",n.title="Click to remove from selection",n.addEventListener("click",()=>{moveCourtBackToPool(t,a)}),e.appendChild(n)})):e.innerHTML='<em style="color: #666;">Click courts below to add them in priority order...</em>'}function moveCourtBackToPool(e,t){availableCourts.splice(t,1),updateAvailableCourtsDisplay(),addCourtToPool(e)}function addCourtToPool(e){const t=document.getElementById("courtPool"),a=document.createElement("div"),n=e.toString().toUpperCase().startsWith("H");a.className=n?"court-item hard-court":"court-item grass-court",a.textContent=e,a.draggable=!0,a.dataset.court=e,a.style.cursor="pointer",a.title="Click to add to selection, or drag to specific position",a.addEventListener("dragstart",handleCourtDragStart),a.addEventListener("dragend",handleCourtDragEnd),a.addEventListener("click",()=>{availableCourts.includes(e)||moveCourtToSelected(e,a)});const r=Array.from(t.children);let l=r.length;for(let t=0;t<r.length;t++){const a=r[t].dataset.court;if(shouldCourtComeBefore(e,a)){l=t;break}}l>=r.length?t.appendChild(a):t.insertBefore(a,r[l])}function shouldCourtComeBefore(e,t){const a=e.toString().toUpperCase().startsWith("H"),n=t.toString().toUpperCase().startsWith("H");if(!a&&n)return!0;if(a&&!n)return!1;if(a||n){return parseInt(e.substring(1))<parseInt(t.substring(1))}return parseInt(e)<parseInt(t)}function moveCourtToSelected(e,t){availableCourts.includes(e)||(availableCourts.push(e),updateAvailableCourtsDisplay(),t.remove())}function loadMemberListOnStartup(){try{if("undefined"==typeof MEMBERS)return void(document.getElementById("memberLoadStatus").innerHTML='<div class="error">â Member Master List.js file not found. Please ensure the file is in the same folder as this HTML file.</div>');masterListData=MEMBERS.map(e=>({name:e.name,grade:reverseTranslateGrade(e.grade),gender:e.gender,nhc:e.nhc,nxd:e.nxd,originalGrade:e.grade})),document.getElementById("memberLoadStatus").innerHTML=`<div class="success">â Loaded ${masterListData.length} players from member list</div>`,document.getElementById("playerSelectionSection").style.display="block",initializePlayerTable()}catch(e){document.getElementById("memberLoadStatus").innerHTML=`<div class="error">Error loading member list: ${e.message}</div>`}}function initializePlayerTable(){playerRows=[];document.getElementById("playerTableBody").innerHTML="";for(let e=0;e<10;e++)addPlayerRow();updateSitOffCalculation()}function addPlayerRow(){const e=document.getElementById("playerTableBody"),t=playerRows.length;playerRows.push({name:"",grade:"",gender:"",nhc:!1,nxd:!1,resting:!1,pso:!1,so:!1});const a=document.createElement("tr");a.innerHTML=`\n  <td style="position: relative;">\n    <div style="display: flex; align-items: center; gap: 5px;">\n      <input type="text" class="name-input" placeholder="Start typing name..." \n             data-row="${t}" autocomplete="off" style="flex: 1;">\n      <button type="button" class="delete-player-btn" data-row="${t}" \n              style="background: #dc3545; color: white; border: none; border-radius: 3px; \n                     padding: 3px 6px; font-size: 12px; cursor: pointer; display: none;"\n              title="Remove player">Ã</button>\n    </div>\n    <div class="autocomplete-suggestions" id="suggestions-${t}" style="display: none;"></div>\n  </td>\n  <td>\n    <select class="grade-select" id="grade-${t}" data-row="${t}">\n  <option value="">-</option>\n  <option value="5">2</option>\n  <option value="4">2A</option>\n  <option value="3">2B</option>\n  <option value="2">3</option>\n  <option value="1">3A</option>\n</select>\n  </td>\n  <td>\n    <select class="gender-select" id="gender-${t}" data-row="${t}">\n      <option value="">-</option>\n      <option value="M">M</option>\n      <option value="F">F</option>\n    </select>\n  </td>\n <td class="checkbox-cell">\n  <input type="checkbox" class="status-checkbox" id="nhc-${t}" data-row="${t}">\n</td>\n<td class="checkbox-cell">\n  <input type="checkbox" class="status-checkbox" id="nxd-${t}" data-row="${t}">\n</td>\n<td class="checkbox-cell">\n  <input type="checkbox" class="status-checkbox" id="resting-${t}" data-row="${t}">\n</td>\n<td class="checkbox-cell">\n  <input type="checkbox" class="status-checkbox" id="pso-${t}" data-row="${t}">\n</td>\n<td class="checkbox-cell">\n  <input type="checkbox" class="status-checkbox" id="so-${t}" data-row="${t}">\n</td>\n`,e.appendChild(a);const n=a.querySelector(".name-input");n.addEventListener("input",e=>handleNameInput(e,t)),n.addEventListener("keydown",e=>handleNameKeydown(e,t)),n.addEventListener("blur",e=>setTimeout(()=>hideSuggestions(t),150)),n.addEventListener("input",e=>{playerRows[t].name=e.target.value;const n=a.querySelector(`[data-row="${t}"].delete-player-btn`);""!==e.target.value.trim()&&""!==playerRows[t].grade&&""!==playerRows[t].gender?n.style.display="block":n.style.display="none",updateSitOffCalculation(),updateProceedButton()});a.querySelector(`#resting-${t}`).addEventListener("change",e=>{playerRows[t].resting=e.target.checked,updateSitOffCalculation(),updateProceedButton()});a.querySelector(`#pso-${t}`).addEventListener("change",e=>{playerRows[t].pso=e.target.checked});a.querySelector(`#so-${t}`).addEventListener("change",e=>{playerRows[t].so=e.target.checked,updateSitOffCalculation(),updateProceedButton()});a.querySelector(`[data-row="${t}"].delete-player-btn`).addEventListener("click",()=>{clearPlayerRow(t)});a.querySelector(`#grade-${t}`).addEventListener("change",e=>{playerRows[t].grade=""===e.target.value?"":parseInt(e.target.value);const n=a.querySelector(".name-input"),r=a.querySelector(`[data-row="${t}"].delete-player-btn`);""!==n.value.trim()&&""!==playerRows[t].grade&&""!==playerRows[t].gender&&(r.style.display="block"),updateSitOffCalculation(),updateProceedButton()});a.querySelector(`#gender-${t}`).addEventListener("change",e=>{playerRows[t].gender=e.target.value;const n=a.querySelector(".name-input"),r=a.querySelector(`[data-row="${t}"].delete-player-btn`);""!==n.value.trim()&&""!==playerRows[t].grade&&""!==playerRows[t].gender&&(r.style.display="block"),updateSitOffCalculation(),updateProceedButton()});a.querySelector(`#nhc-${t}`).addEventListener("change",e=>{playerRows[t].nhc=e.target.checked});a.querySelector(`#nxd-${t}`).addEventListener("change",e=>{playerRows[t].nxd=e.target.checked})}function handleNameInput(e,t){const a=e.target.value.toLowerCase(),n=document.getElementById(`suggestions-${t}`);if(0===a.length)return void hideSuggestions(t);const r=playerRows.map((e,a)=>a!==t?e.name:null).filter(e=>e&&""!==e.trim()),l=masterListData.filter(e=>e.name.toLowerCase().includes(a)&&!r.includes(e.name)).sort((e,t)=>e.name.localeCompare(t.name)).slice(0,10);0!==l.length?(n.innerHTML="",l.forEach((e,a)=>{const r=document.createElement("div");r.className="autocomplete-suggestion",0===a&&r.classList.add("selected"),r.textContent=`${e.name} (${e.originalGrade||translateGrade(e.grade)})`,r.addEventListener("click",()=>selectPlayer(t,e)),n.appendChild(r)}),n.style.display="block"):hideSuggestions(t)}function handleNameKeydown(e,t){const a=document.getElementById(`suggestions-${t}`).querySelectorAll(".autocomplete-suggestion");if(0===a.length)return;let n=-1;if(a.forEach((e,t)=>{e.classList.contains("selected")&&(n=t)}),"ArrowDown"===e.key)e.preventDefault(),n>=0&&a[n].classList.remove("selected"),n=n<a.length-1?n+1:0,a[n].classList.add("selected"),a[n].scrollIntoView({block:"nearest"});else if("ArrowUp"===e.key)e.preventDefault(),n>=0&&a[n].classList.remove("selected"),n=n>0?n-1:a.length-1,a[n].classList.add("selected"),a[n].scrollIntoView({block:"nearest"});else if("Enter"===e.key){e.preventDefault();const t=n>=0?a[n]:a[0];t&&t.click()}else"Escape"===e.key&&hideSuggestions(t)}function selectPlayer(e,t){playerRows[e]={name:t.name,grade:t.grade,gender:t.gender,nhc:t.nhc,nxd:t.nxd,resting:playerRows[e].resting,pso:playerRows[e].pso,so:playerRows[e].so},document.querySelector(`[data-row="${e}"]`).value=t.name,document.getElementById(`grade-${e}`).value=t.grade,document.getElementById(`gender-${e}`).value=t.gender,document.getElementById(`nhc-${e}`).checked=t.nhc,document.getElementById(`nxd-${e}`).checked=t.nxd,document.querySelector(`[data-row="${e}"].delete-player-btn`).style.display="block",hideSuggestions(e),updateSitOffCalculation(),updateProceedButton(),setTimeout(()=>{for(let t=e+1;t<playerRows.length;t++)if(!playerRows[t].name||""===playerRows[t].name.trim()){const e=document.querySelector(`[data-row="${t}"]`);if(e){e.focus();break}}},100)}function clearPlayerRow(e){playerRows[e]={name:"",grade:"",gender:"",nhc:!1,nxd:!1,resting:!1,pso:!1,so:!1},document.querySelector(`[data-row="${e}"]`).value="",document.getElementById(`grade-${e}`).value="",document.getElementById(`gender-${e}`).value="",document.getElementById(`nhc-${e}`).checked=!1,document.getElementById(`nxd-${e}`).checked=!1,document.getElementById(`resting-${e}`).checked=!1,document.getElementById(`pso-${e}`).checked=!1,document.getElementById(`so-${e}`).checked=!1,document.querySelector(`[data-row="${e}"].delete-player-btn`).style.display="none",updateSitOffCalculation(),updateProceedButton()}function hideSuggestions(e){document.getElementById(`suggestions-${e}`).style.display="none"}function updateSitOffCalculation(){const e=playerRows.filter(e=>e.name&&""!==e.name.trim()&&""!==e.grade&&""!==e.gender&&!e.resting),t=playerRows.filter(e=>e.name&&""!==e.name.trim()&&""!==e.grade&&""!==e.gender&&!e.resting&&e.so),a=e.length%4,n=t.length,r=Math.max(0,a-n),l=document.getElementById("sitOffCount"),o=document.getElementById("sitOffCalculator");l.textContent=r,o.className="sit-off-calculator",(0===a||0===r)&&o.classList.add("sit-off-good")}function updateProceedButton(){const e=playerRows.filter(e=>e.name&&""!==e.name.trim()&&""!==e.grade&&""!==e.gender&&!e.resting),t=playerRows.filter(e=>e.name&&""!==e.name.trim()&&""!==e.grade&&""!==e.gender&&!e.resting&&e.so),a=document.getElementById("proceedToMatches");if(e.length>=4&&availableCourts.length>0){const n=e.length%4,r=t.length;if(0===n&&0===r)a.disabled=!1,a.textContent="Proceed to Match Setup";else if(n>0&&r===n)a.disabled=!1,a.textContent="Proceed to Match Setup";else if(n>0&&r<n){const e=n-r;a.disabled=!0,a.textContent=`Select ${e} more to sit off`}else if(n>0&&r>n){const e=r-n;a.disabled=!0,a.textContent=`Remove ${e} sit-off selections`}else 0===n&&r>0&&(a.disabled=!0,a.textContent=`Remove ${r} sit-off selections (none needed)`)}else a.disabled=!0,a.textContent="Proceed to Match Setup"}function processPlayersAndProceed(){const e=playerRows.filter(e=>e.name&&""!==e.name.trim()&&""!==e.grade&&""!==e.gender&&!e.resting&&!e.so),t=e.filter(e=>"M"===e.gender),a=e.filter(e=>"F"===e.gender),n=availableCourts.map((e,t)=>({priority:t+1,court:e}));currentData={setFormatPreference:document.getElementById("formatSelector").value,availableMen:t,availableWomen:a,courts:n},console.log("Processed data:",currentData),setupManualMatchInterface(currentData),document.getElementById("manualMatchSection").style.display="block",document.getElementById("generateMatches").textContent=`Generate Remaining Matches for Set ${document.getElementById("setNumberSelector").value}`}function setupManualMatchInterface(e){const t=document.getElementById("manualPlayerGrid"),a=document.getElementById("courtGrid");t.innerHTML="",a.innerHTML="",manualMatches=[],updateManualMatchDisplay();const n=[];e.availableMen.forEach(e=>n.push({...e,gender:"M"})),e.availableWomen.forEach(e=>n.push({...e,gender:"F"})),n.sort((e,t)=>t.grade!==e.grade?t.grade-e.grade:e.name.localeCompare(t.name)),n.forEach(e=>{const a=document.createElement("div");a.className="manual-player-item",a.innerHTML=`${e.name} (${translateGrade(e.grade)})`,a.dataset.playerName=e.name,a.dataset.playerGrade=e.grade,a.dataset.playerGender=e.gender,a.addEventListener("click",()=>selectPlayerForManualMatch(a,e)),t.appendChild(a)}),e.courts.forEach(e=>{const t=document.createElement("div");t.className="court-option",t.innerHTML=`Court ${e.court}`,t.dataset.court=e.court,t.addEventListener("click",()=>selectCourtForManualMatch(t,e.court)),a.appendChild(t)})}function selectPlayerForManualMatch(e,t){if(!e.classList.contains("excluded")){if(e.classList.contains("selected"))e.classList.remove("selected"),selectedManualPlayers=selectedManualPlayers.filter(e=>e.name!==t.name),removePlayerFromTeams(t.name);else{if(selectedManualPlayers.length>=4)return void alert("Maximum 4 players can be selected for a match");e.classList.add("selected"),selectedManualPlayers.push(t),addPlayerToTeam(t)}updateTeamDisplay(),updateAddMatchButton()}}function addPlayerToTeam(e){manualTeam1.length<2?manualTeam1.push(e):manualTeam2.push(e)}function removePlayerFromTeams(e){manualTeam1=manualTeam1.filter(t=>t.name!==e),manualTeam2=manualTeam2.filter(t=>t.name!==e)}function updateTeamDisplay(){const e=document.getElementById("team1Players"),t=document.getElementById("team2Players");e.innerHTML=manualTeam1.map(e=>`<div class="team-player">${e.name} (${translateGrade(e.grade)}, ${e.gender})</div>`).join(""),t.innerHTML=manualTeam2.map(e=>`<div class="team-player">${e.name} (${translateGrade(e.grade)}, ${e.gender})</div>`).join(""),document.getElementById("team1Slot").classList.toggle("has-players",manualTeam1.length>0),document.getElementById("team2Slot").classList.toggle("has-players",manualTeam2.length>0)}function selectCourtForManualMatch(e,t){e.classList.contains("excluded")||(document.querySelectorAll(".court-option").forEach(e=>e.classList.remove("selected")),e.classList.add("selected"),selectedCourt=t,updateAddMatchButton())}function updateAddMatchButton(){const e=document.getElementById("addManualMatch"),t=4===selectedManualPlayers.length&&2===manualTeam1.length&&2===manualTeam2.length&&null!==selectedCourt;e.disabled=!t,e.textContent=t?`Add Match: Court ${selectedCourt}`:"Add Manual Match"}function addManualMatch(){if(4!==selectedManualPlayers.length||!selectedCourt)return;const e=manualTeam1.filter(e=>"M"===e.gender).length,t=manualTeam1.filter(e=>"F"===e.gender).length,a=manualTeam2.filter(e=>"M"===e.gender).length,n=manualTeam2.filter(e=>"F"===e.gender).length;let r;r=1===e&&1===t&&1===a&&1===n?"Mixed Doubles":2===e&&2===a?"Same-Sex Doubles (Men)":2===t&&2===n?"Same-Sex Doubles (Women)":"Mixed Gender";const l={court:selectedCourt,team1:[...manualTeam1],team2:[...manualTeam2],format:r,note:"Manual Setup",isManual:!0};manualMatches.push(l),selectedManualPlayers.forEach(e=>{const t=document.querySelector(`[data-player-name="${e.name}"]`);t&&(t.classList.remove("selected"),t.classList.add("excluded"))});const o=document.querySelector(`[data-court="${selectedCourt}"]`);o&&(o.classList.remove("selected"),o.classList.add("excluded")),selectedManualPlayers=[],selectedCourt=null,manualTeam1=[],manualTeam2=[],updateTeamDisplay(),updateAddMatchButton(),updateManualMatchDisplay(),console.log(`Manual match added: Court ${l.court} - ${r}`)}function updateManualMatchDisplay(){const e=document.getElementById("manualMatchesList");if(0===manualMatches.length)return void(e.innerHTML='<p style="color: #666; font-style: italic;">No manual matches set up yet.</p>');let t="<h4>Manual Matches:</h4>";manualMatches.forEach((e,a)=>{const n=e.team1.map(e=>`${e.name} (${e.grade})`).join(", "),r=e.team2.map(e=>`${e.name} (${e.grade})`).join(", ");t+=`\n      <div class="manual-match-item">\n        <div class="manual-match-details">\n          <div class="manual-match-court">Court ${e.court}</div>\n          <div class="manual-match-teams">${n} vs ${r}</div>\n          <div style="font-size: 12px; color: #666;">${e.format}</div>\n        </div>\n        <button class="danger" onclick="removeManualMatch(${a})">Remove</button>\n      </div>\n    `}),e.innerHTML=t}function removeManualMatch(e){const t=manualMatches[e];[...t.team1,...t.team2].forEach(e=>{const t=document.querySelector(`[data-player-name="${e.name}"]`);t&&t.classList.remove("excluded")});const a=document.querySelector(`[data-court="${t.court}"]`);a&&a.classList.remove("excluded"),manualMatches.splice(e,1),updateManualMatchDisplay(),console.log(`Manual match removed: Court ${t.court}`)}function clearManualSetup(){document.querySelectorAll(".manual-player-item").forEach(e=>{e.classList.remove("selected","excluded")}),document.querySelectorAll(".court-option").forEach(e=>{e.classList.remove("selected","excluded")}),selectedManualPlayers=[],selectedCourt=null,manualTeam1=[],manualTeam2=[],updateTeamDisplay(),updateAddMatchButton()}function processMatchesWithManualSetup(){const e=[],t=[];manualMatches.forEach(a=>{a.team1.forEach(t=>e.push(t.name)),a.team2.forEach(t=>e.push(t.name)),t.push(a.court)});const a={...currentData,availableMen:currentData.availableMen.filter(t=>!e.includes(t.name)),availableWomen:currentData.availableWomen.filter(t=>!e.includes(t.name)),courts:currentData.courts.filter(e=>!t.includes(e.court))};console.log(`Excluded ${e.length} players and ${t.length} courts for manual matches`);const n=(a.availableMen.length+a.availableWomen.length)%4;if(0===n){processMatchesWithAdjustedData(a)}else alert(`Cannot proceed: ${n} players remaining after manual matches. Need multiple of 4.`)}function processMatches(){log("=== STARTING MATCH FORMATION ===");const e=sortPlayers(currentData),t=balanceIndividualMatches(e,fixUncompetitiveMatches(e,autoFixRepeatPartnerships(e,processCourtPreferences(e,formMatchesStrict(e).map(e=>balanceTeamsIfNeeded(e))))));currentData=e,currentMatches=t,displayResults(e,t)}function processMatchesWithAdjustedData(e){log("=== STARTING MATCH FORMATION (ADJUSTED FOR MANUAL MATCHES) ===");const t=sortPlayers(e),a=balanceIndividualMatches(t,fixUncompetitiveMatches(t,autoFixRepeatPartnerships(t,processCourtPreferences(t,formMatchesStrict(t).map(e=>balanceTeamsIfNeeded(e))))));currentMatches=a,displayResults(currentData,a)}function sortPlayers(e){const t=e.availableMen.sort((e,t)=>t.grade-e.grade),a=e.availableWomen.sort((e,t)=>t.grade-e.grade),n=parseInt(document.getElementById("setNumberSelector").value);let r=0;if("Same-Sex"===document.getElementById("formatSelector").value){let e=0;for(let t=1;t<=n;t++)(allSetsData[t]&&"Same-Sex"===allSetsData[t].data.setFormatPreference||t===n)&&e++;r=(e-1)%10}for(let e=5;e>=1;e--){const a=t.filter(t=>t.grade===e);if(a.length>1&&r>0){const n=r%a.length,l=[...a.slice(n),...a.slice(0,n)];let o=0;for(let a=0;a<t.length;a++)t[a].grade===e&&(t[a]=l[o++])}}for(let e=5;e>=1;e--){const t=a.filter(t=>t.grade===e);if(t.length>1&&r>0){const n=r%t.length,l=[...t.slice(n),...t.slice(0,n)];let o=0;for(let t=0;t<a.length;t++)a[t].grade===e&&(a[t]=l[o++])}}log("Applied rotation amount: "+r+" for Set "+n),log("=== SORTED PLAYERS ===");for(let e=5;e>=1;e--){const n=t.filter(t=>t.grade===e).length,r=a.filter(t=>t.grade===e).length;(n>0||r>0)&&log("Grade "+e+": "+n+" men, "+r+" women")}return{...e,sortedMen:t,sortedWomen:a}}function formMatchesStrict(e){return log("=== STRICT MATCH FORMATION ==="),"Mixed"===e.setFormatPreference?formMixedDoublesMatches(e):formSameSexDoublesMatches(e)}function formMixedDoublesMatches(e){log("Using Mixed Doubles Logic");const t=[],a=new Set;let n=0;const r=(t,r,l,o)=>{if(n>=e.courts.length)return log("ERROR: No more courts available"),null;const s=t.filter(t=>e.sortedMen.find(e=>e.name===t.name)).length,c=t.filter(t=>e.sortedWomen.find(e=>e.name===t.name)).length,d=r.filter(t=>e.sortedMen.find(e=>e.name===t.name)).length,i=r.filter(t=>e.sortedWomen.find(e=>e.name===t.name)).length;if(2===s&&0===c&&0===d&&2===i||0===s&&2===c&&2===d&&0===i)return log("ERROR: Attempted prohibited 2M vs 2W match"),null;const m=e.courts[n].court;return n++,t.forEach(e=>a.add(e.name)),r.forEach(e=>a.add(e.name)),log("Created match on Court "+m+": "+t.map(e=>e.name+"("+e.grade+")").join(",")+" vs "+r.map(e=>e.name+"("+e.grade+")").join(",")+" - "+l),{court:m,team1:t,team2:r,format:l,note:o}};for(let n=5;n>=1;n--){log("=== PROCESSING GRADE "+n+" ===");const l=e.sortedMen.filter(e=>e.grade===n&&!a.has(e.name)),o=e.sortedWomen.filter(e=>e.grade===n&&!a.has(e.name)),s=e.sortedMen.filter(e=>e.grade===n-1&&!a.has(e.name)),c=e.sortedWomen.filter(e=>e.grade===n-1&&!a.has(e.name));if(1===l.length&&1===o.length&&s.length>=1&&c.length>=1){const e=r([l[0],c[0]],[s[0],o[0]],"Mixed Doubles","Cross-grade balanced");if(e){t.push(e);continue}}for(;;){const l=e.sortedMen.filter(e=>e.grade===n&&!a.has(e.name)),o=e.sortedWomen.filter(e=>e.grade===n&&!a.has(e.name));if(!(l.length>=2&&o.length>=2))break;{const e=r([l[0],o[0]],[l[1],o[1]],"Mixed Doubles","In-grade");e&&t.push(e)}}log("MANDATORY COMPLETION: All Grade "+n+" players must be assigned");let d=0;for(;d<100;){d++;const l=e.sortedMen.filter(e=>e.grade===n&&!a.has(e.name)),o=e.sortedWomen.filter(e=>e.grade===n&&!a.has(e.name));if(0===l.length&&0===o.length){log("â SUCCESS: ALL Grade "+n+" players assigned");break}const s=e.sortedMen.filter(e=>e.grade<n&&!a.has(e.name)),c=e.sortedWomen.filter(e=>e.grade<n&&!a.has(e.name));log("Attempt "+d+": Grade "+n+" remaining: "+l.length+"M + "+o.length+"W"),log("Available lower: "+s.length+"M + "+c.length+"W");let i=!1;if(l.length>=4){const e=r([l[0],l[1]],[l[2],l[3]],"Same-Sex Doubles (Men)","Mandatory completion");e&&(t.push(e),i=!0)}else if(o.length>=4){const e=r([o[0],o[1]],[o[2],o[3]],"Same-Sex Doubles (Women)","Mandatory completion");e&&(t.push(e),i=!0)}else if(3===l.length&&o.length>=1){const e=r([l[0],o[0]],[l[1],l[2]],"Mixed Gender","Mandatory completion 3M+1W");e&&(t.push(e),i=!0)}else if(3===o.length&&l.length>=1){const e=r([l[0],o[0]],[o[1],o[2]],"Mixed Gender","Mandatory completion 1M+3W");e&&(t.push(e),i=!0)}else if(l.length>=2&&c.length>=2){const e=r([l[0],c[0]],[l[1],c[1]],"Mixed Doubles","Cross-grade completion");e&&(t.push(e),i=!0)}else if(o.length>=2&&s.length>=2){const e=r([s[0],o[0]],[s[1],o[1]],"Mixed Doubles","Cross-grade completion");e&&(t.push(e),i=!0)}else if(l.length>=1&&s.length>=3){const e=r([l[0],s[0]],[s[1],s[2]],"Same-Sex Doubles (Men)","Cross-grade completion");e&&(t.push(e),i=!0)}else if(o.length>=1&&c.length>=3){const e=r([o[0],c[0]],[c[1],c[2]],"Same-Sex Doubles (Women)","Cross-grade completion");e&&(t.push(e),i=!0)}else if(l.length>=1&&s.length>=1&&c.length>=2){const e=r([l[0],c[0]],[s[0],c[1]],"Mixed Doubles","Cross-grade completion");e&&(t.push(e),i=!0)}else if(o.length>=1&&c.length>=1&&s.length>=2){const e=r([s[0],o[0]],[s[1],c[0]],"Mixed Doubles","Cross-grade completion");e&&(t.push(e),i=!0)}if(!i){log("â CRITICAL ERROR: Cannot complete Grade "+n),log("Remaining target players: "+l.map(e=>e.name).join(",")+" | "+o.map(e=>e.name).join(",")),log("Available lower players: "+s.length+"M + "+c.length+"W");break}}}log("=== FINAL CLEANUP PHASE ===");let l=0;for(;l<20;){l++;const n=e.sortedMen.filter(e=>!a.has(e.name)),o=e.sortedWomen.filter(e=>!a.has(e.name));if(0===n.length&&0===o.length){log("â CLEANUP SUCCESS: All players assigned");break}log("Cleanup attempt "+l+": "+n.length+"M + "+o.length+"W remaining");let s=!1;if(n.length>=4){const e=r([n[0],n[1]],[n[2],n[3]],"Same-Sex Doubles (Men)","Final cleanup");e&&(t.push(e),s=!0)}else if(o.length>=4){const e=r([o[0],o[1]],[o[2],o[3]],"Same-Sex Doubles (Women)","Final cleanup");e&&(t.push(e),s=!0)}else if(n.length>=2&&o.length>=2){const e=r([n[0],o[0]],[n[1],o[1]],"Mixed Doubles","Final cleanup");e&&(t.push(e),s=!0)}else if(3===n.length&&1===o.length){const e=r([n[0],o[0]],[n[1],n[2]],"Mixed Gender","Final cleanup 3M+1W");e&&(t.push(e),s=!0)}else if(3===o.length&&1===n.length){const e=r([n[0],o[0]],[o[1],o[2]],"Mixed Gender","Final cleanup 1M+3W");e&&(t.push(e),s=!0)}if(!s){log("â CLEANUP FAILED: Cannot form matches from remaining players");break}}const o=e.sortedMen.filter(e=>!a.has(e.name)),s=e.sortedWomen.filter(e=>!a.has(e.name));return log("=== FINAL STATUS ==="),log("Total matches created: "+t.length),log("Unassigned players: "+(o.length+s.length)),(o.length>0||s.length>0)&&(log("â ERROR: Players remain unassigned!"),log("Unassigned men: "+o.map(e=>e.name+"("+e.grade+")").join(", ")),log("Unassigned women: "+s.map(e=>e.name+"("+e.grade+")").join(", "))),t}function formSameSexDoublesMatches(e){log("Using Same-Sex Doubles Logic");const t=[],a=new Set;let n=0;const r=(t,r,l,o)=>{if(n>=e.courts.length)return null;const s=e.courts[n].court;return n++,t.forEach(e=>a.add(e.name)),r.forEach(e=>a.add(e.name)),log("Created match on Court "+s+": "+t.map(e=>e.name+"("+e.grade+")").join(",")+" vs "+r.map(e=>e.name+"("+e.grade+")").join(",")),{court:s,team1:t,team2:r,format:l,note:o}};for(let n=5;n>=1;n--){for(log("=== PROCESSING GRADE "+n+" ===");;){const l=e.sortedMen.filter(e=>e.grade===n&&!a.has(e.name));if(!(l.length>=4))break;{const e=r([l[0],l[1]],[l[2],l[3]],"Same-Sex Doubles (Men)","In-grade");e&&t.push(e)}}for(;;){const l=e.sortedWomen.filter(e=>e.grade===n&&!a.has(e.name));if(!(l.length>=4))break;{const e=r([l[0],l[1]],[l[2],l[3]],"Same-Sex Doubles (Women)","In-grade");e&&t.push(e)}}let l=0;for(;l<20;){l++;const o=e.sortedMen.filter(e=>e.grade===n&&!a.has(e.name)),s=e.sortedWomen.filter(e=>e.grade===n&&!a.has(e.name));if(0===o.length&&0===s.length){log("â SUCCESS: ALL Grade "+n+" players assigned");break}const c=e.sortedMen.filter(e=>e.grade<n&&!a.has(e.name)),d=e.sortedWomen.filter(e=>e.grade<n&&!a.has(e.name));let i=!1;if(3===o.length&&1===s.length){const e=r([o[0],s[0]],[o[1],o[2]],"Mixed Gender","3M+1W completion");e&&(t.push(e),i=!0)}else if(3===s.length&&1===o.length){const e=r([o[0],s[0]],[s[1],s[2]],"Mixed Gender","1M+3W completion");e&&(t.push(e),i=!0)}else if(2===o.length&&2===s.length){const e=r([o[0],s[0]],[o[1],s[1]],"Mixed Doubles","2M+2W completion");e&&(t.push(e),i=!0)}else if(o.length>=2&&d.length>=2){const e=r([o[0],d[0]],[o[1],d[1]],"Mixed Doubles","Cross-grade");e&&(t.push(e),i=!0)}else if(s.length>=2&&c.length>=2){const e=r([c[0],s[0]],[c[1],s[1]],"Mixed Doubles","Cross-grade");e&&(t.push(e),i=!0)}else if(1===o.length&&1===s.length&&c.length>=1&&d.length>=1){const e=r([o[0],d[0]],[c[0],s[0]],"Mixed Doubles","1M+1W cross-grade completion");e&&(t.push(e),i=!0)}else if(o.length>=1&&c.length>=3){const e=r([o[0],c[0]],[c[1],c[2]],"Same-Sex Doubles (Men)","Cross-grade completion");e&&(t.push(e),i=!0)}else if(s.length>=1&&d.length>=3){const e=r([s[0],d[0]],[d[1],d[2]],"Same-Sex Doubles (Women)","Cross-grade completion");e&&(t.push(e),i=!0)}else if(o.length>=1&&c.length>=1&&d.length>=2){const e=r([o[0],d[0]],[c[0],d[1]],"Mixed Doubles","Cross-grade completion");e&&(t.push(e),i=!0)}else if(s.length>=1&&d.length>=1&&c.length>=2){const e=r([c[0],s[0]],[c[1],d[0]],"Mixed Doubles","Cross-grade completion");e&&(t.push(e),i=!0)}else if(o.length>=2&&c.length>=2){const e=r([o[0],c[0]],[o[1],c[1]],"Same-Sex Doubles (Men)","Cross-grade 2+2 completion");e&&(t.push(e),i=!0)}else if(s.length>=2&&d.length>=2){const e=r([s[0],d[0]],[s[1],d[1]],"Same-Sex Doubles (Women)","Cross-grade 2+2 completion");e&&(t.push(e),i=!0)}if(!i){log("Cannot complete Grade "+n+" - remaining: "+o.length+"M + "+s.length+"W");break}}}log("=== FINAL CLEANUP PHASE ===");let l=0;for(;l<20;){l++;const n=e.sortedMen.filter(e=>!a.has(e.name)),o=e.sortedWomen.filter(e=>!a.has(e.name));if(0===n.length&&0===o.length){log("â CLEANUP SUCCESS: All players assigned");break}log("Cleanup attempt "+l+": "+n.length+"M + "+o.length+"W remaining");let s=!1;if(n.length>=4){const e=r([n[0],n[1]],[n[2],n[3]],"Same-Sex Doubles (Men)","Final cleanup");e&&(t.push(e),s=!0)}else if(o.length>=4){const e=r([o[0],o[1]],[o[2],o[3]],"Same-Sex Doubles (Women)","Final cleanup");e&&(t.push(e),s=!0)}else if(n.length>=2&&o.length>=2){const e=r([n[0],o[0]],[n[1],o[1]],"Mixed Doubles","Final cleanup");e&&(t.push(e),s=!0)}else if(3===n.length&&1===o.length){const e=r([n[0],o[0]],[n[1],n[2]],"Mixed Gender","Final cleanup 3M+1W");e&&(t.push(e),s=!0)}else if(3===o.length&&1===n.length){const e=r([n[0],o[0]],[o[1],o[2]],"Mixed Gender","Final cleanup 1M+3W");e&&(t.push(e),s=!0)}if(!s){log("â CLEANUP FAILED: Cannot form matches from remaining players");break}}return log("=== FINAL STATUS ==="),log("Total matches created: "+t.length),t}function balanceTeamsIfNeeded(e){if("Same-Sex Doubles (Men)"!==e.format&&"Same-Sex Doubles (Women)"!==e.format)return e;const t=e.team1.map(e=>e.grade),a=e.team2.map(e=>e.grade),n=t.filter(e=>e>=4).length,r=a.filter(e=>e>=4).length;if(2===n&&0===r){const n=t[0]<t[1]?0:1,r=a[0]>a[1]?0:1,l=e.team1[n];e.team1[n]=e.team2[r],e.team2[r]=l,log("âï¸ Balanced teams: Swapped "+l.name+" â "+e.team1[n].name)}else if(0===n&&2===r){const n=a[0]<a[1]?0:1,r=t[0]>t[1]?0:1,l=e.team2[n];e.team2[n]=e.team1[r],e.team1[r]=l,log("âï¸ Balanced teams: Swapped "+l.name+" â "+e.team2[n].name)}return e}function processCourtPreferences(e,t){log("=== COURT PREFERENCES ===");const a=t=>[...t.team1,...t.team2].some(t=>{const a=e.sortedMen.find(e=>e.name===t.name),n=e.sortedWomen.find(e=>e.name===t.name),r=a||n;return r&&r.nhc}),n=[],r=[];t.forEach((e,t)=>{var l;(l=e.court)&&l.toString().toUpperCase().startsWith("H")&&a(e)?n.push({index:t,match:e}):(e=>{const t=e&&e.toString().toUpperCase();return t&&(t.startsWith("G")||!t.startsWith("H")&&/^\d+$/.test(t))})(e.court)&&!a(e)&&r.push({index:t,match:e})});const l=Math.min(n.length,r.length);for(let e=0;e<l;e++){const a=n[e].match.court;t[n[e].index].court=r[e].match.court,t[r[e].index].court=a,log("Court swap: "+a+" â "+r[e].match.court)}return t}function checkForRepeatPartnerships(e,t){if(e<=1)return[];const a=[],n=[];t.forEach((e,t)=>{2===e.team1.length&&n.push({matchIndex:t,team:1,players:[e.team1[0].name,e.team1[1].name].sort()}),2===e.team2.length&&n.push({matchIndex:t,team:2,players:[e.team2[0].name,e.team2[1].name].sort()})});for(let t=1;t<e;t++){if(!allSetsData[t]||!allSetsData[t].matches)continue;const e=allSetsData[t].matches,r=[];e.forEach(e=>{2===e.team1.length&&r.push([e.team1[0].name,e.team1[1].name].sort()),2===e.team2.length&&r.push([e.team2[0].name,e.team2[1].name].sort())}),n.forEach(e=>{r.forEach(n=>{e.players[0]===n[0]&&e.players[1]===n[1]&&(a.push({matchIndex:e.matchIndex,team:e.team,players:e.players,previousSet:t}),log("Repeat partnership found: "+e.players.join(" & ")+" (previously in Set "+t+")"))})})}return a}function autoFixRepeatPartnerships(e,t){const a=parseInt(document.getElementById("setNumberSelector").value);if(a<=1)return t;log("=== AUTO-FIXING REPEAT PARTNERSHIPS ===");const n=JSON.parse(JSON.stringify(t)),r=checkForRepeatPartnerships(a,n);if(0===r.length)return log("No repeat partnerships found - no auto-fixes needed"),n;log("Found "+r.length+" repeat partnerships to attempt fixing");log("Repeat partnership limit set to: 20"),r.length>20&&(log("=== REPEAT PARTNERSHIP THRESHOLD EXCEEDED ==="),log("Found "+r.length+" repeat partnerships (>20)"),log("Skipping Phase 2 inter-match fixes to prevent memory issues"),log("Phase 1 intra-match fixes will still be attempted"),log("Remaining repeat partnerships must be resolved manually by operator")),log("=== PHASE 1: INTRA-MATCH FIXES ==="),r.forEach((t,r)=>{const l=t.matchIndex,o=parseInt(t.team),s=n[l],c=1===o?s.team1:s.team2,d=1===o?s.team2:s.team1;if(log("Attempting intra-match fix for: "+t.players.join(" & ")+" (Match "+l+", Team "+o+")"),s.format.includes("Same-Sex")){const t=checkForRepeatPartnerships(a,n).length;let r=!1;for(let l=0;l<c.length&&!r;l++)for(let o=0;o<d.length&&!r;o++){const s=c[l],i=d[o];if(getPlayerGender(s.name,e)!==getPlayerGender(i.name,e))continue;c[l]=i,d[o]=s;const m=checkForRepeatPartnerships(a,n).length;if(m<t){log("â Intra-match fix: Swapped "+s.name+" â "+i.name),log("  Repeat partnerships reduced from "+t+" to "+m),r=!0;break}c[l]=s,d[o]=i}if(r)return}});const l=checkForRepeatPartnerships(a,n);if(0===l.length)return log("ð Phase 1 resolved all repeat partnerships!"),n;if(r.length<=20){log("=== PHASE 2: INTER-MATCH FIXES ==="),log("Remaining repeats after Phase 1: "+l.length);const t=e.setFormatPreference;l.forEach((r,l)=>{const o=r.matchIndex,s=parseInt(r.team),c=n[o],d=1===s?c.team1:c.team2;1===s?c.team2:c.team1;log("Attempting inter-match fix for: "+r.players.join(" & ")+" (Match "+o+", Team "+s+")");let i=!1;const m=[];"Same-Sex"===t?m.push({name:"Same grade, same gender",criteria:(t,a)=>t.grade===a.grade&&getPlayerGender(t.name,e)===getPlayerGender(a.name,e)},{name:"Adjacent grade, same gender",criteria:(t,a)=>1===Math.abs(t.grade-a.grade)&&getPlayerGender(t.name,e)===getPlayerGender(a.name,e)},{name:"Same grade, cross gender",criteria:(t,a)=>t.grade===a.grade&&getPlayerGender(t.name,e)!==getPlayerGender(a.name,e)}):m.push({name:"Same grade, cross gender",criteria:(t,a)=>t.grade===a.grade&&getPlayerGender(t.name,e)!==getPlayerGender(a.name,e)},{name:"Adjacent grade, cross gender",criteria:(t,a)=>1===Math.abs(t.grade-a.grade)&&getPlayerGender(t.name,e)!==getPlayerGender(a.name,e)},{name:"Same grade, same gender",criteria:(t,a)=>t.grade===a.grade&&getPlayerGender(t.name,e)===getPlayerGender(a.name,e)});for(let e of m){if(i)break;log("  Trying inter-match strategy: "+e.name);for(let t=0;t<n.length&&!i;t++){if(t===o)continue;const r=n[t];for(let l=1;l<=2&&!i;l++){const c=1===l?r.team1:r.team2;for(let r=0;r<d.length&&!i;r++)for(let m=0;m<c.length&&!i;m++){const u=d[r],g=c[m];if(!e.criteria(u,g))continue;if(e.name.includes("Adjacent grade")&&!wouldCreateBalancedTeams(n,o,r,s,m,l,t))continue;const h=checkForRepeatPartnerships(a,n).length;d[r]=g,c[m]=u;const p=checkForRepeatPartnerships(a,n).length;if(p<h){log("â Inter-match fix ("+e.name+"): Swapped "+u.name+" â "+g.name),log("  Repeat partnerships reduced from "+h+" to "+p),i=!0;break}d[r]=u,c[m]=g}}}}i||log("â Could not auto-fix: "+r.players.join(" & ")+" - leaving for manual adjustment")});const r=checkForRepeatPartnerships(a,n);r.length>0?(log("â  Could not resolve all repeat partnerships. Remaining: "+r.length),r.forEach(e=>{log("  - "+e.players.join(" & ")+" (previously in Set "+e.previousSet+")")})):log("ð Successfully resolved all repeat partnerships!")}else log("=== PHASE 2 SKIPPED DUE TO THRESHOLD ==="),log("Phase 1 intra-match fixes completed only"),log("Operator must manually resolve remaining repeat partnerships");return n}function wouldCreateBalancedTeams(e,t,a,n,r,l,o=null){const s=null!==o?o:t,c=e[t],d=e[s],i=1===n?c.team1:c.team2,m=1===l?d.team1:d.team2,u=i[a],g=m[r];if(null===o)return!0;const h=[i[1-a],g],p=[m[1-r],u],f=1===n?c.team2:c.team1,y=1===l?d.team2:d.team1,b=isMatchupBalanced(h,f),M=isMatchupBalanced(p,y);return b&&M}function fixUncompetitiveMatches(e,t){log("=== FINAL COMPETITIVENESS OPTIMIZATION ===");const a=[];if(t.forEach((e,t)=>{isUncompetitive(e)&&a.push({index:t,match:e})}),log(`Found ${a.length} uncompetitive matches`),a.length<=1)return log("â¤1 uncompetitive match found - leaving for operator to handle"),t;const n=Math.floor(a.length/2);log(`Processing ${n} pairs of uncompetitive matches`);for(let r=0;r<n;r++){const n=a[2*r],l=a[2*r+1];log(`\n--- Processing pair ${r+1}: Match ${n.index} & Match ${l.index} ---`),attemptCompetitivenessSwap(e,t,n.index,l.index)?log(`â Successful competitiveness swap between matches ${n.index} & ${l.index}`):log(`â No beneficial swap found between matches ${n.index} & ${l.index}`)}const r=t.filter(e=>isUncompetitive(e)).length;return log("\n=== COMPETITIVENESS OPTIMIZATION COMPLETE ==="),log(`Uncompetitive matches reduced from ${a.length} to ${r}`),t}function balanceIndividualMatches(e,t){log("=== FINAL INDIVIDUAL MATCH BALANCING ===");let a=0;return t.forEach((t,n)=>{const r=t.team1.reduce((e,t)=>e+t.grade,0),l=t.team2.reduce((e,t)=>e+t.grade,0),o=Math.abs(r-l);if(o<2)return;log(`Match ${n} needs balancing: ${r} vs ${l} (gap=${o})`);let s=null,c=o;for(let a=0;a<2;a++)for(let n=0;n<2;n++){if(1===a&&1===n)continue;const r=JSON.parse(JSON.stringify(t)),l=r.team1[a];if(r.team1[a]=r.team2[n],r.team2[n]=l,creates2Mvs2F(r,e))continue;const o=r.team1.reduce((e,t)=>e+t.grade,0),d=r.team2.reduce((e,t)=>e+t.grade,0),i=Math.abs(o-d);i<c&&(c=i,s={t1Player:a,t2Player:n})}if(s){const e=t.team1[s.t1Player];t.team1[s.t1Player]=t.team2[s.t2Player],t.team2[s.t2Player]=e,updateMatchFormat(t),log(`  â Swapped players: Gap reduced from ${o} to ${c}`),a++}else log(`  No valid improvement found for match ${n}`)}),log(`=== INDIVIDUAL MATCH BALANCING COMPLETE: ${a} matches improved ===`),t}function isUncompetitive(e){const t=e.team1.map(e=>e.grade).sort((e,t)=>t-e),a=e.team2.map(e=>e.grade).sort((e,t)=>t-e),n=t[0]-t[1],r=a[0]-a[1],l=n>=2||r>=2;return l&&log(`Uncompetitive match: [${t.join(",")}] vs [${a.join(",")}] - gaps: ${n}, ${r}`),l}function attemptCompetitivenessSwap(e,t,a,n){const r=t[a],l=t[n],o=[...r.team1.map((e,t)=>({...e,match:a,team:1,position:t})),...r.team2.map((e,t)=>({...e,match:a,team:2,position:t}))],s=[...l.team1.map((e,t)=>({...e,match:n,team:1,position:t})),...l.team2.map((e,t)=>({...e,match:n,team:2,position:t}))];o.sort((e,t)=>e.grade-t.grade),s.sort((e,t)=>t.grade-e.grade);const c=o.slice(0,2),d=s.slice(0,2);log("Swapping (no competitiveness check needed):"),log(`  Weakest from Match ${a}: ${c.map(e=>`${e.name}(${e.grade})`).join(", ")}`),log(`  Strongest from Match ${n}: ${d.map(e=>`${e.name}(${e.grade})`).join(", ")}`);const i=JSON.parse(JSON.stringify(r)),m=JSON.parse(JSON.stringify(l)),u=c[0],g=d[0],h=1===u.team?i.team1:i.team2,p=1===g.team?m.team1:m.team2,f={...h[u.position]};h[u.position]={...p[g.position]},p[g.position]=f;const y=c[1],b=d[1],M=1===y.team?i.team1:i.team2,S=1===b.team?m.team1:m.team2,v={...M[y.position]};return M[y.position]={...S[b.position]},S[b.position]=v,creates2Mvs2F(i,e)||creates2Mvs2F(m,e)?(log("  â Swap would create 2M vs 2F - rejected"),!1):(t[a]=i,t[n]=m,updateMatchFormat(t[a]),updateMatchFormat(t[n]),log("  â Swap completed"),!0)}function creates2Mvs2F(e,t){const a=e.team1.filter(e=>"M"===getPlayerGender(e.name,t)).length,n=e.team1.filter(e=>"F"===getPlayerGender(e.name,t)).length,r=e.team2.filter(e=>"M"===getPlayerGender(e.name,t)).length,l=e.team2.filter(e=>"F"===getPlayerGender(e.name,t)).length;return 2===a&&0===n&&0===r&&2===l||0===a&&2===n&&2===r&&0===l}function isMatchupBalanced(e,t){const a=e.map(e=>e.grade).sort((e,t)=>t-e),n=t.map(e=>e.grade).sort((e,t)=>t-e),r=a[0],l=a[1],o=n[0],s=n[1];if(Math.abs(r-o)>1)return!1;const c=r+l,d=o+s,i=a.includes(5),m=n.includes(5);return i&&!m?4===o&&4===s:m&&!i?4===r&&4===l:Math.abs(c-d)<=2}function getPlayerGender(e,t){let a=t.sortedMen?t.sortedMen.find(t=>t.name===e):null,n=t.sortedWomen?t.sortedWomen.find(t=>t.name===e):null;return!a&&t.availableMen&&(a=t.availableMen.find(t=>t.name===e)),!n&&t.availableWomen&&(n=t.availableWomen.find(t=>t.name===e)),a?"M":n?"F":null}function testSwapReducesConflicts(e,t,a,n,r,l,o,s){const c=JSON.parse(JSON.stringify(e)),d=c[t],i=c[r],m=1===a?d.team1:d.team2,u=1===l?i.team1:i.team2,g=checkForRepeatPartnerships(s,e).length,h=m[n];m[n]=u[o],u[o]=h;return checkForRepeatPartnerships(s,c).length<g}function displayResults(e,t){currentSetNumber=parseInt(document.getElementById("setNumberSelector").value);const a=[...manualMatches,...t];allSetsData[currentSetNumber]={data:JSON.parse(JSON.stringify(e)),matches:JSON.parse(JSON.stringify(a)),satOffPlayers:[]};const n=playerRows.filter(e=>e.name&&e.so).map(e=>e.name);n.length>0?(allSetsData[currentSetNumber].satOffPlayers=[...n],log("Stored "+allSetsData[currentSetNumber].satOffPlayers.length+" sat-off players for Set "+currentSetNumber)):log("No players sat off for Set "+currentSetNumber+" (evenly divisible by 4)"),log("Set "+currentSetNumber+" data saved to memory");const r=document.getElementById("matches"),l=document.getElementById("matchResults"),o=checkForRepeatPartnerships(currentSetNumber,a);let s='<div class="success">â '+a.length+" Matches Generated for Set "+document.getElementById("setNumberSelector").value;manualMatches.length>0&&(s+=" ("+manualMatches.length+" manual + "+t.length+" automatic)"),s+="</div>",s+='<p style="color: #666; font-style: italic;">Drag players or courts to swap them</p>';const c=t=>{let a=e.availableMen?e.availableMen.find(e=>e.name===t):null,n=e.availableWomen?e.availableWomen.find(e=>e.name===t):null;!a&&e.sortedMen&&(a=e.sortedMen.find(e=>e.name===t)),!n&&e.sortedWomen&&(n=e.sortedWomen.find(e=>e.name===t));const r=a||n;return r&&r.nhc},d=t=>{let a=e.availableMen?e.availableMen.find(e=>e.name===t):null,n=e.availableWomen?e.availableWomen.find(e=>e.name===t):null;!a&&e.sortedMen&&(a=e.sortedMen.find(e=>e.name===t)),!n&&e.sortedWomen&&(n=e.sortedWomen.find(e=>e.name===t));const r=a||n;return r&&r.nxd};s+='<table style="width: 100%; border-collapse: collapse; margin: 20px 0;">',s+='<tr style="background: #f8f9fa; border-bottom: 2px solid #333;">',s+='<th style="padding: 12px; text-align: center; font-weight: bold; border: 1px solid #ddd; width: 40px;">Court #</th>',s+='<th style="padding: 12px; text-align: center; font-weight: bold; border: 1px solid #ddd; width: 45%;">Team 1</th>',s+='<th style="padding: 12px; text-align: center; font-weight: bold; border: 1px solid #ddd; width: 45%;">Team 2</th>',s+="</tr>",a.forEach((e,t)=>{const a=e.isManual||!1;s+="<tr "+(a?'style="background: #fff8dc;"':"")+">";s+='<td style="padding: 8px; text-align: center; border: 1px solid #ddd; vertical-align: middle;">',s+='<div class="'+(a?"court-box manual":"court-box")+'" draggable="true" data-type="court" data-match="'+t+'" data-court="'+e.court+'" ',s+='style="display: inline-block; background: white; color: black; border: 2px solid #333; ',s+='padding: 6px 10px; border-radius: 5px; font-weight: bold; cursor: move; user-select: none;">',s+=e.court,s+="</div></td>",s+='<td style="padding: 8px; border: 1px solid #ddd; vertical-align: middle;">',e.team1.forEach((e,n)=>{const r=c(e.name)?" nhc":"",l=d(e.name)?" nxd":"",i=a?" manual-match":"",m=o.some(a=>a.matchIndex===t&&1===a.team&&a.players.includes(e.name));s+='<span class="player-box'+r+l+(m?" repeat-partner":"")+i+'" draggable="true" ',s+='data-type="player" data-match="'+t+'" data-team="1" data-player="'+n+'" ',s+='data-name="'+e.name+'" data-grade="'+e.grade+'" ',s+='style="display: inline-block; background: white; border: 2px solid #ddd; padding: 4px 8px; margin: 2px; ',s+="border-radius: 5px; cursor: move; user-select: none; transition: all 0.2s ease;",c(e.name)&&d(e.name)?s+=" font-weight: bold;":c(e.name)?s+=" background-color: #add8e6; font-weight: bold;":d(e.name)&&(s+=" background-color: #ffffe0; font-weight: bold;"),m&&(s+=" background-color: #ff9800; border: 2px solid #f57c00; font-weight: bold;"),a&&(s+=" background-color: #fff8dc; border: 2px solid #ffc107;"),s+='">',s+=e.name+" ("+translateGrade(e.grade)+")",s+="</span>",0===n&&(s+=", ")}),s+="</td>",s+='<td style="padding: 8px; border: 1px solid #ddd; vertical-align: middle;">',e.team2.forEach((e,n)=>{const r=c(e.name)?" nhc":"",l=d(e.name)?" nxd":"",i=a?" manual-match":"",m=o.some(a=>a.matchIndex===t&&2===a.team&&a.players.includes(e.name));s+='<span class="player-box'+r+l+(m?" repeat-partner":"")+i+'" draggable="true" ',s+='data-type="player" data-match="'+t+'" data-team="2" data-player="'+n+'" ',s+='data-name="'+e.name+'" data-grade="'+e.grade+'" ',s+='style="display: inline-block; background: white; border: 2px solid #ddd; padding: 4px 8px; margin: 2px; ',s+="border-radius: 5px; cursor: move; user-select: none; transition: all 0.2s ease;",c(e.name)&&d(e.name)?s+=" font-weight: bold;":c(e.name)?s+=" background-color: #add8e6; font-weight: bold;":d(e.name)&&(s+=" background-color: #ffffe0; font-weight: bold;"),m&&(s+=" background-color: #ff9800; border: 2px solid #f57c00; font-weight: bold;"),a&&(s+=" background-color: #fff8dc; border: 2px solid #ffc107;"),s+='">',s+=e.name+" ("+translateGrade(e.grade)+")",s+="</span>",0===n&&(s+=", ")}),s+="</td>",s+="</tr>"}),s+="</table>",l.innerHTML=s,r.style.display="block",currentMatches=a,setTimeout(()=>initializeDragAndDrop(),100)}function initializeDragAndDrop(){log("Initializing drag and drop");let e=null,t=null;const a=document.getElementById("matchResults");if(!a)return;const n=a.cloneNode(!0);a.parentNode.replaceChild(n,a),n.addEventListener("dragstart",function(a){"true"===a.target.getAttribute("draggable")&&(e=a.target,t={type:a.target.dataset.type,match:parseInt(a.target.dataset.match),team:a.target.dataset.team,player:parseInt(a.target.dataset.player),court:a.target.dataset.court,name:a.target.dataset.name,grade:a.target.dataset.grade},a.target.classList.add("dragging"),log("Dragging: "+(t.name||t.court)))}),n.addEventListener("dragend",function(e){"true"===e.target.getAttribute("draggable")&&(e.target.classList.remove("dragging"),n.querySelectorAll(".drag-over").forEach(e=>e.classList.remove("drag-over")))}),n.addEventListener("dragover",function(e){e.preventDefault()}),n.addEventListener("dragenter",function(e){(e.target.classList.contains("player-box")||e.target.classList.contains("court-box"))&&e.target.classList.add("drag-over")}),n.addEventListener("dragleave",function(e){(e.target.classList.contains("player-box")||e.target.classList.contains("court-box"))&&e.target.classList.remove("drag-over")}),n.addEventListener("drop",function(a){if(a.preventDefault(),!e||!t)return;const n=a.target;if(n!==e){if(n.classList.remove("drag-over"),"player"===t.type&&n.classList.contains("player-box")){const e={match:parseInt(n.dataset.match),team:n.dataset.team,player:parseInt(n.dataset.player),name:n.dataset.name};log("Swapping players: "+t.name+" â "+e.name),swapPlayers(t,e),allSetsData[currentSetNumber]&&(allSetsData[currentSetNumber].matches=JSON.parse(JSON.stringify(currentMatches))),refreshDisplay()}else if("court"===t.type&&n.classList.contains("court-box")){const e=parseInt(n.dataset.match),a=n.dataset.court;log("Swapping courts: "+t.court+" â "+a),swapCourts(t.match,e),allSetsData[currentSetNumber]&&(allSetsData[currentSetNumber].matches=JSON.parse(JSON.stringify(currentMatches))),refreshDisplay()}e=null,t=null}})}function swapPlayers(e,t){const a=currentMatches[e.match],n=currentMatches[t.match],r="1"===e.team?a.team1:a.team2,l="1"===t.team?n.team1:n.team2,o={...r[e.player]};r[e.player]={...l[t.player]},l[t.player]=o,updateMatchFormat(currentMatches[e.match]),updateMatchFormat(currentMatches[t.match])}function updateMatchFormat(e){if(!e||!e.team1||!e.team2)return;console.log("currentData:",currentData),console.log("sortedMen:",currentData.sortedMen),console.log("sortedWomen:",currentData.sortedWomen),console.log("First player from team1:",e.team1[0]);const t=e.team1.filter(e=>"M"===getPlayerGender(e.name,currentData)).length,a=e.team1.filter(e=>"F"===getPlayerGender(e.name,currentData)).length,n=e.team2.filter(e=>"M"===getPlayerGender(e.name,currentData)).length,r=e.team2.filter(e=>"F"===getPlayerGender(e.name,currentData)).length;e.format=1===t&&1===a&&1===n&&1===r?"Mixed Doubles":2===t&&2===n?"Same-Sex Doubles (Men)":2===a&&2===r?"Same-Sex Doubles (Women)":"Mixed Gender"}function getPlayerGender(e,t){let a=t.sortedMen?t.sortedMen.find(t=>t.name===e):null,n=t.sortedWomen?t.sortedWomen.find(t=>t.name===e):null;return!a&&t.availableMen&&(a=t.availableMen.find(t=>t.name===e)),!n&&t.availableWomen&&(n=t.availableWomen.find(t=>t.name===e)),a?"M":n?"F":null}function swapCourts(e,t){const a=currentMatches[e].court;currentMatches[e].court=currentMatches[t].court,currentMatches[t].court=a}function refreshDisplay(){displayResults(currentData,currentMatches.filter(e=>!e.isManual))}function printMatchSheet(e,t){try{const a=window.open("","_blank","width=800,height=600"),n=playerRows.filter(e=>e.name&&e.so).map(e=>e.name);let r=`\n<!DOCTYPE html>\n<html>\n<head>\n  <meta charset="UTF-8">\n  <title>Tennis Match Sheet - Set ${document.getElementById("setNumberSelector").value}</title>\n  <style>\n    body { \n      font-family: Arial, sans-serif; \n      margin: 20px; \n      background: white; \n      color: black;\n      line-height: 1.3;\n    }\n    .header { \n      text-align: center; \n      margin-bottom: 30px; \n      border-bottom: 2px solid black; \n      padding-bottom: 15px;\n    }\n    .header h1 { \n      margin: 0; \n      font-size: 24px; \n      font-weight: bold;\n    }\n    .header-info { \n      font-size: 16px; \n      margin: 8px 0;\n    }\n    .sat-off-section { \n      background: #f0f0f0; \n      border: 2px solid black; \n      padding: 15px; \n      margin: 20px 0; \n      border-radius: 5px;\n    }\n    .sat-off-title { \n      font-size: 18px; \n      font-weight: bold; \n      margin-bottom: 10px;\n    }\n    .sat-off-list { \n      font-size: 16px; \n      font-weight: bold;\n    }\n    .match-table {\n      width: 100%;\n      border-collapse: collapse;\n      margin: 20px 0;\n    }\n    .match-table th {\n      background: #f8f9fa;\n      border: 2px solid #333;\n      padding: 12px;\n      text-align: center;\n      font-weight: bold;\n      font-size: 16px;\n    }\n    .match-table td {\n      border: 1px solid #333;\n      padding: 8px;\n      vertical-align: middle;\n    }\n    .match-table tr.manual {\n      background: #fff8dc;\n    }\n    .court-number {\n      background: white;\n      color: black;\n      border: 2px solid #333;\n      padding: 6px 10px;\n      border-radius: 5px;\n      font-weight: bold;\n      display: inline-block;\n    }\n    .team-cell {\n      font-size: 18px;\n    }\n    .match-table th:nth-child(1) {\n      width: 40px;\n    }\n    .match-table th:nth-child(2), .match-table th:nth-child(3) {\n      width: 45%;\n    }\n    @media print {\n      body { margin: 15px; }\n      .match-table { page-break-inside: auto; }\n    }\n  </style>\n</head>\n<body>\n  <div class="header">\n    <h1>Tennis Match Sheet</h1>\n    <div class="header-info">Date: ${(new Date).toLocaleDateString()}</div>\n    <div class="header-info">Set Number: ${document.getElementById("setNumberSelector").value}</div>\n    <div class="header-info">Format: ${e.setFormatPreference}</div>\n  </div>\n`;n.length>0&&(r+=`\n  <div class="sat-off-section">\n    <div class="sat-off-title">Players Sitting Off This Set:</div>\n    <div class="sat-off-list">${n.join(", ")}</div>\n  </div>\n`),r+='\n  <table class="match-table">\n    <tr>\n      <th>Court #</th>\n      <th>Team 1</th>\n      <th>Team 2</th>\n    </tr>\n',t.forEach((e,t)=>{const a=e.team1.map(e=>`${e.name} (${translateGrade(e.grade)})`).join(", "),n=e.team2.map(e=>`${e.name} (${translateGrade(e.grade)})`).join(", "),l=e.isManual||!1;r+=`\n    <tr${l?' class="manual"':""}>\n      <td style="text-align: center;">\n        <div class="court-number">${e.court}</div>\n      </td>\n      <td class="team-cell">${a}</td>\n      <td class="team-cell">${n}</td>\n    </tr>\n`}),r+="\n  </table>\n</body>\n</html>",a.document.write(r),a.document.close(),setTimeout(()=>{a.focus(),a.print()},250),log("Print dialog opened for match sheet")}catch(e){alert("Error creating print sheet: "+e.message),log("Error creating print sheet: "+e.message)}}function downloadResults(e,t){try{const a=XLSX.utils.book_new(),n=Object.keys(allSetsData).sort((e,t)=>parseInt(e)-parseInt(t));0===n.length?createSingleSetSheet(a,e,t,currentSetNumber):n.forEach(e=>{const t=allSetsData[e];createSingleSetSheet(a,t.data,t.matches,e,t.satOffPlayers)});const r=(new Date).toISOString().slice(0,19).replace(/:/g,"-"),l=`Tennis_Matches_${n.length||1}_Sets_${r}.xlsx`;XLSX.writeFile(a,l),log("Excel file downloaded: "+l+" with "+(n.length||1)+" sheets")}catch(e){alert("Error creating Excel file: "+e.message),log("Error creating Excel file: "+e.message)}}function createSingleSetSheet(e,t,a,n,r=[]){const l=[];l.push(["Date",(new Date).toISOString().split("T")[0]]),l.push(["Set Number","Set "+n]),l.push(["Set Format Preference",t.setFormatPreference]),l.push([]),l.push(["Court","Team 1","Team 2","Match Format","Match Type","Sat Off Players","","Total Men Players","Grade","NHC","Resting","PSO","","Total Women Players","Grade","NHC","Resting","PSO"]);const o=Math.max(a.length,t.availableMen.length,t.availableWomen.length);for(let e=0;e<o;e++){const n=["","","","","","",""];if(e<a.length){const t=a[e],l=t.team1.map(e=>`${e.name} (${translateGrade(e.grade)})`).join(", "),o=t.team2.map(e=>`${e.name} (${translateGrade(e.grade)})`).join(", "),s=e<r.length?r[e]:"",c=t.isManual?"Manual":"Auto";n[0]=t.court,n[1]=l,n[2]=o,n[3]=t.format,n[4]=c,n[5]=s,n[6]=""}if(e<t.availableMen.length){const a=t.availableMen[e];n[7]=a.name,n[8]=a.grade,n[9]=a.nhc?"y":"",n[10]=a.resting?"y":"",n[11]=a.pso?"y":""}if(n[12]="",e<t.availableWomen.length){const a=t.availableWomen[e];n[13]=a.name,n[14]=a.grade,n[15]=a.nhc?"y":"",n[16]=a.resting?"y":"",n[17]=a.pso?"y":""}l.push(n)}const s=XLSX.utils.aoa_to_sheet(l);s["!cols"]=[{wch:20},{wch:50},{wch:50},{wch:25},{wch:10},{wch:20},{wch:3},{wch:20},{wch:8},{wch:6},{wch:8},{wch:6},{wch:3},{wch:20},{wch:8},{wch:6},{wch:8},{wch:6}],XLSX.utils.book_append_sheet(e,s,"Set "+n+" Summary")}availableCourtsDiv.addEventListener("dragover",e=>{e.preventDefault(),availableCourtsDiv.classList.add("drag-over")}),availableCourtsDiv.addEventListener("dragleave",e=>{availableCourtsDiv.classList.remove("drag-over")}),availableCourtsDiv.addEventListener("drop",e=>{e.preventDefault(),availableCourtsDiv.classList.remove("drag-over");const t=e.dataTransfer.getData("text/plain");if(t&&!availableCourts.includes(t)){availableCourts.push(t),updateAvailableCourtsDisplay();const e=document.querySelector(`[data-court="${t}"]`);e&&"courtPool"===e.parentElement.id&&e.remove()}}),document.getElementById("clearCourts").addEventListener("click",()=>{availableCourts=[],updateAvailableCourtsDisplay(),initializeCourts()}),document.getElementById("addMoreRows").addEventListener("click",()=>{for(let e=0;e<10;e++)addPlayerRow()}),document.getElementById("updateMasterList").addEventListener("click",generateUpdatedMasterList),document.getElementById("setNumberSelector").addEventListener("change",function(){const e=parseInt(this.value),t=e-1;if(e>1&&allSetsData[t]){const a=allSetsData[t].satOffPlayers||[];playerRows.forEach((e,t)=>{if(a.includes(e.name)){e.so=!1,e.pso=!0;const a=document.getElementById(`so-${t}`),n=document.getElementById(`pso-${t}`);a&&(a.checked=!1),n&&(n.checked=!0)}}),console.log(`Moved ${a.length} players from SO to PSO for Set ${e}`)}playerRows.forEach((e,t)=>{if(!e.pso){e.so=!1;const a=document.getElementById(`so-${t}`);a&&(a.checked=!1)}}),updateSitOffCalculation(),updateProceedButton(),document.getElementById("manualMatchSection").style.display="none",document.getElementById("matches").style.display="none",document.getElementById("generateMatches").textContent=`Generate Remaining Matches for Set ${e}`}),document.getElementById("proceedToMatches").addEventListener("click",()=>{processPlayersAndProceed(),setTimeout(()=>{scrollToElement("manualMatchSection")},100)}),document.getElementById("toggleManualSetup").addEventListener("click",function(){const e=document.getElementById("manualSetupPanel"),t="none"!==e.style.display;e.style.display=t?"none":"block",this.textContent=t?"Setup Manual Match":"Hide Manual Setup"}),document.getElementById("addManualMatch").addEventListener("click",addManualMatch),document.getElementById("clearManualSetup").addEventListener("click",clearManualSetup),document.getElementById("generateMatches").addEventListener("click",()=>{processMatchesWithManualSetup(),setTimeout(()=>{scrollToElement("matches")},500)}),document.addEventListener("DOMContentLoaded",()=>{initializeCourts(),loadMemberListOnStartup()}),document.getElementById("downloadBtn").onclick=function(){currentData&&currentMatches?downloadResults(currentData,currentMatches):alert("No matches to download. Please generate matches first.")},document.getElementById("printBtn").onclick=function(){currentData&&currentMatches?printMatchSheet(currentData,currentMatches):alert("No matches to print. Please generate matches first.")}</script>