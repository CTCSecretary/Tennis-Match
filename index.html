<!DOCTYPE html><html><head><meta charset=UTF-8><title>Social Tennis Match Maker</title><script src=https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js></script><script src="Member Master List.js"></script><style>body{font-family:Arial,sans-serif;padding:20px;background:#f4f4f4}.logo-section{text-align:center;margin-bottom:20px;padding:15px;background:#fff;box-shadow:0 2px 4px rgba(0,0,0,.1)}.step-header{background:linear-gradient(135deg,#1e40af 0,#3b82f6 100%);color:#fff;font-size:24px;font-weight:700;padding:20px 30px;margin:-15px -15px 20px -15px;border-radius:8px 8px 0 0;text-align:left;box-shadow:0 2px 8px rgba(30,64,175,.3)}.logo{max-height:80px;max-width:100%;height:auto;border-radius:8px;transition:all .3s ease}.logo:hover{transform:scale(1.02);box-shadow:0 4px 12px rgba(0,0,0,.15)}h1{text-align:center;color:#333}.section{background:#fff;margin:15px 0;padding:15px;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,.1)}.error{color:red;font-weight:700}.success{color:green;font-weight:700}.warning{color:orange;font-weight:700}button{padding:10px 20px;margin:10px 5px;border:none;border-radius:5px;cursor:pointer}.primary{background:#007acc;color:#fff}.secondary{background:#6c757d;color:#fff}.danger{background:#dc3545;color:#fff}.court-pool{display:grid;grid-template-columns:repeat(auto-fill,minmax(80px,1fr));gap:8px;margin:15px 0;padding:15px;border:2px dashed #ddd;border-radius:8px;background:#fafafa;min-height:120px}.court-item{background:#007acc;color:#fff;padding:10px;text-align:center;border-radius:5px;cursor:move;user-select:none;font-weight:700;transition:all .2s}.court-item.grass-court{background:#28a745!important}.court-item.grass-court:hover{background:#1e7e34!important}.court-item.hard-court{background:#007acc!important}.court-item.hard-court:hover{background:#005a99!important}.available-courts .court-item.grass-court{background:#28a745!important}.available-courts .court-item.grass-court:hover{background:#1e7e34!important}.available-courts .court-item.hard-court{background:#007acc!important}.available-courts .court-item.hard-court:hover{background:#005a99!important}.court-item:hover{background:#005a99;transform:scale(1.05)}.court-item:hover{background:#005a99;transform:scale(1.05)}.court-item.dragging{opacity:.5}.available-courts{min-height:80px;padding:15px;border:2px dashed #28a745;border-radius:8px;background:#f8fff8;margin:15px 0}.available-courts.drag-over{border-color:#007acc;background:#e3f2fd}.available-courts .court-item{background:#28a745;margin:5px;display:inline-block}.available-courts .court-item:hover{background:#1e7e34}.player-table{width:100%;border-collapse:collapse;margin:15px 0}.player-table td,.player-table th{border:1px solid #ddd;padding:8px;text-align:left}.player-table th{background:#f8f9fa;font-weight:700}.player-table tr:nth-child(2n){background:#f9f9f9}.player-table tr:hover{background:#e8f4fd}.name-input{width:100%;padding:5px;border:1px solid #ddd;border-radius:3px;font-size:16px}.name-input:focus{border-color:#007acc;outline:0}.autocomplete-suggestions{position:absolute;background:#fff;border:1px solid #ddd;border-top:none;max-height:200px;overflow-y:auto;z-index:1000;width:100%}.autocomplete-suggestion{padding:8px;cursor:pointer;border-bottom:1px solid #eee;font-size:16px}.autocomplete-suggestion:hover{background:#e8f4fd}.autocomplete-suggestion.selected{background:#007acc;color:#fff}.checkbox-cell{text-align:center;width:60px}.status-checkbox{width:18px;height:18px;cursor:pointer}.gender-select,.grade-select{width:100%;padding:4px;border:1px solid #ddd;border-radius:3px;font-size:14px;background:#fff}.gender-select:focus,.grade-select:focus{border-color:#007acc;outline:0}.sit-off-calculator{background:#fff3cd;border:1px solid #ffc107;padding:15px;border-radius:5px;margin:15px 0;text-align:center;font-size:18px;font-weight:700}.sit-off-good{background:#d4edda;border-color:#28a745;color:#155724}.sit-off-bad{background:#f8d7da;border-color:#dc3545;color:#721c24}.manual-match-setup{border:2px solid #ffc107;background:#fff8dc;border-radius:8px;padding:15px;margin:15px 0}.manual-match-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}.manual-match-title{font-size:18px;font-weight:700;color:#856404}.manual-matches-list{margin:15px 0}.manual-match-item{background:#fff;border:1px solid #ffc107;border-radius:5px;padding:12px;margin:8px 0;display:flex;justify-content:space-between;align-items:center}.manual-match-details{flex:1}.manual-match-court{font-weight:700;color:#007acc;margin-bottom:5px}.manual-match-teams{font-size:14px;color:#333}.manual-player-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin:15px 0}.manual-player-item{background:#fff;border:1px solid #ddd;border-radius:5px;padding:8px;cursor:pointer;transition:all .2s;user-select:none}.manual-player-item:hover{border-color:#007acc;background:#f8f9fa}.manual-player-item.selected{background:#007acc;color:#fff;border-color:#0056b3}.manual-player-item.excluded{background:#f8f9f9;color:#6c757d;border-color:#dee2e6;cursor:not-allowed}.team-formation{display:grid;grid-template-columns:1fr auto 1fr;gap:20px;margin:20px 0;align-items:center}.team-slot{border:2px dashed #ddd;border-radius:8px;padding:15px;min-height:100px;background:#fafafa}.team-slot.has-players{border-color:#007acc;background:#e3f2fd}.team-slot-title{font-weight:700;margin-bottom:10px;text-align:center}.team-player{background:#fff;border:1px solid #007acc;border-radius:4px;padding:5px 8px;margin:3px 0;font-size:14px}.vs-divider{font-size:24px;font-weight:700;text-align:center;color:#666}.court-selector{margin:15px 0}.court-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(80px,1fr));gap:8px;margin:10px 0}.court-option{background:#fff;border:2px solid #ddd;border-radius:5px;padding:10px;text-align:center;cursor:pointer;transition:all .2s}.court-option:hover{border-color:#007acc}.court-option.selected{background:#007acc;color:#fff;border-color:#0056b3}.court-option.excluded{background:#f8f9f9;color:#6c757d;border-color:#dee2e6;cursor:not-allowed}.match-container{background:#f9f9f9;border:1px solid #ddd;padding:15px;margin:8px 0;border-radius:6px;border-left:4px solid #007acc}.match-container.manual-match{border-left:4px solid #ffc107;background:#fff8dc}.court-box{display:inline-block;background:#007acc;color:#fff;padding:8px 12px;border-radius:5px;margin-bottom:10px;font-weight:700;cursor:move;user-select:none}.court-box.manual{background:#ffc107;color:#856404}.court-box:hover{background:#005a99}.court-box.manual:hover{background:#e0a800}.court-box.dragging{opacity:.5}.court-box.drag-over{background:#28a745}.teams-row{display:flex;gap:20px;align-items:flex-start}.team-column{flex:1;min-height:80px}.team-header{font-weight:700;margin-bottom:8px;text-align:center;padding:5px;background:#e9e9e9;border-radius:3px}.player-box{background:#fff;border:2px solid #ddd;padding:8px;margin:4px 0;border-radius:5px;cursor:move;user-select:none;text-align:center;transition:all .2s ease}.player-box:hover{border-color:#007acc;box-shadow:0 2px 5px rgba(0,0,0,.2)}.player-box.dragging{opacity:.5;transform:rotate(2deg)}.player-box.nhc{background-color:#ffeb3b;font-weight:700}.player-box.nxd{background-color:#ffffe0;font-weight:700}.player-box.nhc.nxd{background:linear-gradient(90deg,#add8e6 0,#ffffe0 100%)!important;font-weight:700}.player-box.repeat-partner{background-color:#ff9800;border:2px solid #f57c00;font-weight:700}.player-box.repeat-opponent{border:3px dashed #dc3545!important;box-shadow:0 0 5px rgba(220,53,69,.5)}.player-box.manual-match{background-color:#fff8dc;border:2px solid #ffc107}.player-box.drag-over{border-color:#28a745;border-width:3px;background-color:#e8f5e8}.format{font-style:italic;color:#666;margin-top:8px;font-size:.9em}.info-box{background:#cff4fc;border:1px solid #0dcaf0;padding:15px;border-radius:5px;margin:15px 0}.warning-box{background:#fff3cd;border:1px solid #ffc107;padding:15px;border-radius:5px;margin:15px 0}.info-box{background:#cff4fc;border:1px solid #0dcaf0;padding:15px;border-radius:5px;margin:15px 0}.warning-box{background:#fff3cd;border:1px solid #ffc107;padding:15px;border-radius:5px;margin:15px 0}.selection-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:10px;margin:15px 0}.player-checkbox{display:flex;align-items:center;padding:8px;border:1px solid #ddd;border-radius:5px;background:#fff;cursor:pointer;transition:all .2s}.player-checkbox:hover{border-color:#007acc;background:#f8f9fa}.player-checkbox.pso{background-color:#fff3cd;border-color:#ffc107}.player-checkbox.selected{background-color:#d4edda;border-color:#28a745}.player-checkbox input{margin-right:10px}.save-status{position:fixed;top:20px;right:20px;background:#28a745;color:#fff;padding:8px 16px;border-radius:4px;font-size:14px;z-index:10000;transition:opacity .3s;opacity:0}.save-status.show{opacity:1}</style></head><body><div class=logo-section style=position:relative><div style=display:flex;align-items:center;justify-content:center;gap:20px><img src=CTClogo.jpg alt="Tennis Club Logo" class=logo><h1 style=margin:0;color:#333>Social Tennis Match Maker</h1></div><div style=position:absolute;bottom:10px;right:15px;font-size:11px;color:#999>© 2025 Problems?: Paul Oen 0438 374 643</div></div><div id=memberLoadStatus style="margin:15px 0"></div><div style="text-align:center;margin:15px 0;padding:10px;background:#e3f2fd;border-radius:5px"><button id=importExcelBtn class=secondary style=background:#007acc>📋 Import Excel File</button> <button onclick=clearSavedData() class=danger style=margin-left:10px>Clear Saved Data</button> <input type=file id=excelFileInput accept=.xlsx,.xls style=display:none><div style=font-size:12px;color:#666;margin-top:5px>Import players and courts from Excel file</div></div><div class=section><div class=step-header>Step 1: Select available courts</div><h4>Selected Courts</h4><div id=availableCourts class=available-courts><em style=color:#666>Click or Drag courts here in the order they will be used</em></div><h4>Unselected Courts:</h4><div id=courtPool class=court-pool></div><button id=clearCourts class=secondary>Clear All Courts</button></div><div class=section><div class=step-header>Step 2: Choose match format and set number</div><div style=margin-bottom:15px><label for=formatSelector style=font-weight:700;margin-right:10px>Set Format Preference:</label> <select id=formatSelector style="padding:8px;font-size:16px;border-radius:4px;border:1px solid #ccc"><option value=Same-Sex>Same-Sex Doubles</option><option value=Mixed>Mixed Doubles</option></select></div><div style=margin-bottom:15px><label for=setNumberSelector style=font-weight:700;margin-right:10px>Set Number:</label> <select id=setNumberSelector style="padding:8px;font-size:16px;border-radius:4px;border:1px solid #ccc"><option value=1 selected=selected>Set 1</option><option value=2>Set 2</option><option value=3>Set 3</option><option value=4>Set 4</option><option value=5>Set 5</option><option value=6>Set 6</option></select></div></div><div id=playerSelectionSection class=section style=display:none><div class=step-header>Step 3: Player Selection</div><div id=sitOffCalculator class=sit-off-calculator>Players to sit off: <span id=sitOffCount>-</span></div><table class=player-table><thead><tr><th style=width:200px>Name</th><th style=width:80px>Grade</th><th style=width:80px>Gender</th><th style=width:60px>NHC</th><th style=width:60px>NXD</th><th style=width:80px>Resting</th><th style=width:60px>PSO</th><th style=width:60px>SO</th></tr></thead><tbody id=playerTableBody></tbody></table><div style="text-align:center;margin:15px 0"><button id=addMoreRows class=secondary>Add 10 More Rows</button> <button id=updateMasterList class=secondary style=background:#28a745>Update Master List</button> <button id=proceedToMatches class=primary disabled=disabled>Proceed to Match Setup</button></div></div><div id=manualMatchSection class=section style=display:none><div class=step-header>Step 4: Manual Match Setup (optional)</div><div class=manual-match-setup><div class=manual-match-header><button id=toggleManualSetup class=secondary>Setup Manual Match</button></div><div id=manualSetupPanel style=display:none><div class=info-box><h4>Create Manual Matches</h4><p>Set up special requests or exhibition games. These players will be excluded from automatic match generation.</p></div><div id=manualPlayerSelection><h4>Available Players:</h4><div id=manualPlayerGrid class=manual-player-grid></div></div><div class=team-formation><div id=team1Slot class=team-slot><div class=team-slot-title>Team 1</div><div id=team1Players></div></div><div class=vs-divider>VS</div><div id=team2Slot class=team-slot><div class=team-slot-title>Team 2</div><div id=team2Players></div></div></div><div class=court-selector><h4>Select Court:</h4><div id=courtGrid class=court-grid></div></div><div style="text-align:center;margin:20px 0"><button id=addManualMatch class=primary disabled=disabled>Add Manual Match</button> <button id=clearManualSetup class=secondary>Clear Setup</button></div></div><div id=manualMatchesList class=manual-matches-list></div></div><div style="text-align:center;margin:20px 0"><button id=generateMatches class=primary>Generate Remaining Matches</button></div></div><div id=matches class=section style=display:none><div class=step-header>Step 5: Generated Matches</div><div style=margin-bottom:15px><button id=downloadBtn class=primary style=background:#28a745>📥 Download Results as Excel</button> <button id=printBtn class=primary style=background:#007acc;margin-left:10px>🖨️ Print Match Sheet</button></div><div id=matchResults></div></div><script>let hasPlayerChanges=!1,masterListData=[],availableCourts=[],playerRows=[],debugLog=[],currentData=null,currentMatches=null,allSetsData={},currentSetNumber=1;function splitAB(e){const t=Math.ceil(e.length/2);return[e.slice(0,t),e.slice(t)]}function rotateRight(e,t){const a=e.length;if(0===a)return e.slice();const n=(t%a+a)%a;return 0===n?e.slice():e.slice(a-n).concat(e.slice(0,a-n))}function interleaveAB(e,t){const a=[],n=Math.max(e.length,t.length);for(let r=0;r<n;r++)r<e.length&&a.push(e[r]),r<t.length&&a.push(t[r]);return a}function mixABSmart(e,t){if(e.length<=1)return e.slice();let[a,n]=splitAB(e);const r=2*(t-1);return a=rotateRight(a,t-1),n=rotateRight(n,r),interleaveAB(a,n)}const MIXING_MODE="ab-smart";let manualMatches=[];function getPerfect16Schedule(e){return{1:[[0,1,2,3],[4,5,6,7],[8,9,10,11],[12,13,14,15]],2:[[0,4,8,12],[1,5,9,13],[2,6,10,14],[3,7,11,15]],3:[[0,5,10,15],[1,4,11,14],[2,7,8,13],[3,6,9,12]],4:[[0,6,11,13],[1,7,10,12],[2,4,9,15],[3,5,8,14]],5:[[0,7,9,14],[1,6,8,15],[2,5,11,12],[3,4,10,13]]}[e]||null}function generatePerfect16Matches(e){log("Generating Perfect 16 matches for Set "+e);const t=playerRows.filter(e=>e.name&&""!==e.name.trim()&&""!==e.grade&&""!==e.gender&&!e.resting&&!e.so);if(16!==t.length)return log("ERROR: Expected 16 players, found "+t.length),null;const a=t.map((e,t)=>({...e,id:t})),n=getPerfect16Schedule(e);if(!n)return log("ERROR: No schedule found for Set "+e),null;const r=[];let o=0;return n.forEach(n=>{if(o>=currentData.courts.length)return log("ERROR: Not enough courts for Perfect 16"),null;const l=currentData.courts[o].court,s=[a[n[0]],a[n[1]]],c=[a[n[2]],a[n[3]]],d="M"===t[0].gender?"Same-Sex Doubles (Men)":"Same-Sex Doubles (Women)";r.push({court:l,team1:s,team2:c,format:d,note:"Perfect 16 Set "+e}),o++}),log("Perfect 16: Generated "+r.length+" matches for Set "+e),r}function detectPerfect16Scenario(){const e=parseInt(document.getElementById("setNumberSelector").value);if(e<1||e>5)return!1;for(let e=1;e<=5;e++)if(allSetsData[e]&&allSetsData[e].matches){if(allSetsData[e].matches.some(e=>e.isManual))return log("Perfect 16 disabled: Manual matches detected in Set "+e),!1}if(manualMatches&&manualMatches.length>0)return log("Perfect 16 disabled: Manual matches selected for current set"),!1;const t=playerRows.filter(e=>e.name&&""!==e.name.trim()&&""!==e.grade&&""!==e.gender&&!e.resting&&!e.so);if(16!==t.length)return!1;const a=[...new Set(t.map(e=>e.gender))];if(1!==a.length)return!1;const n=[...new Set(t.map(e=>e.grade))];return 1===n.length&&(log("=== PERFECT 16 DETECTED ==="),log("16 players, all "+a[0]+", all grade "+translateGrade(n[0])),!0)}let selectedManualPlayers=[],selectedCourt=null,manualTeam1=[],manualTeam2=[];function saveDataToStorage(){try{const e={version:"1.0",timestamp:(new Date).toISOString(),availableCourts:availableCourts,playerRows:playerRows,currentSetNumber:parseInt(document.getElementById("setNumberSelector").value),allSetsData:allSetsData,manualMatches:manualMatches,currentData:currentData,currentMatches:currentMatches,setFormatPreference:document.getElementById("formatSelector").value};localStorage.setItem("tennisMatchMaker_autoSave",JSON.stringify(e)),localStorage.setItem("tennisMatchMaker_lastSave",(new Date).toISOString()),showSaveIndicator()}catch(e){console.warn("Failed to auto-save data:",e)}}function loadDataFromStorage(){try{const e=localStorage.getItem("tennisMatchMaker_autoSave"),t=localStorage.getItem("tennisMatchMaker_lastSave");if(!e)return!1;const a=JSON.parse(e),n=new Date(t);if((new Date-n)/36e5>24)return localStorage.removeItem("tennisMatchMaker_autoSave"),localStorage.removeItem("tennisMatchMaker_lastSave"),!1;const r=`Found saved data from ${n.toLocaleString()}. Would you like to restore it?`;if(confirm(r))return restoreDataFromSave(a),!0}catch(e){console.warn("Failed to load saved data:",e)}return!1}function restoreDataFromSave(e){try{availableCourts=e.availableCourts||[],playerRows=e.playerRows||[],allSetsData=e.allSetsData||{},manualMatches=e.manualMatches||[],currentData=e.currentData,currentMatches=e.currentMatches,document.getElementById("setNumberSelector").value=e.currentSetNumber||1,document.getElementById("formatSelector").value=e.setFormatPreference||"Same-Sex",updateAvailableCourtsDisplay(),restorePlayerTable(),playerRows.some(e=>e.name&&""!==e.name.trim())&&(document.getElementById("playerSelectionSection").style.display="block"),availableCourts.length>0&&playerRows.some(e=>e.name&&""!==e.name.trim())&&(document.getElementById("manualMatchSection").style.display="block"),currentMatches&&currentMatches.length>0&&(document.getElementById("matches").style.display="block",displayResults(currentData,currentMatches.filter(e=>!e.isManual))),updateSitOffCalculation(),updateProceedButton(),alert("Data restored successfully!")}catch(e){alert("Error restoring data: "+e.message)}}function restorePlayerTable(){for(document.getElementById("playerTableBody").innerHTML="";playerRows.length<10;)playerRows.push({name:"",grade:"",gender:"",nhc:!1,nxd:!1,resting:!1,pso:!1,so:!1});playerRows.forEach((e,t)=>{addPlayerRowAtIndex(t),e.name&&(document.querySelector(`[data-row="${t}"]`).value=e.name,document.getElementById(`grade-${t}`).value=e.grade,document.getElementById(`gender-${t}`).value=e.gender,document.getElementById(`nhc-${t}`).checked=e.nhc,document.getElementById(`nxd-${t}`).checked=e.nxd,document.getElementById(`resting-${t}`).checked=e.resting,document.getElementById(`pso-${t}`).checked=e.pso,document.getElementById(`so-${t}`).checked=e.so,e.name&&e.grade&&e.gender&&(document.querySelector(`[data-row="${t}"].delete-player-btn`).style.display="block"))})}function addPlayerRowAtIndex(e){const t=document.getElementById("playerTableBody"),a=document.createElement("tr");a.innerHTML=`\n    <td style="position: relative;">\n      <div style="display: flex; align-items: center; gap: 5px;">\n        <input type="text" class="name-input" placeholder="Start typing name..." \n               data-row="${e}" autocomplete="off" style="flex: 1;">\n        <button type="button" class="delete-player-btn" data-row="${e}" \n                style="background: #dc3545; color: white; border: none; border-radius: 3px; \n                       padding: 3px 6px; font-size: 12px; cursor: pointer; display: none;"\n                title="Remove player">×</button>\n      </div>\n      <div class="autocomplete-suggestions" id="suggestions-${e}" style="display: none;"></div>\n    </td>\n    <td>\n      <select class="grade-select" id="grade-${e}" data-row="${e}">\n        <option value="">-</option>\n        <option value="5">2</option>\n        <option value="4">2A</option>\n        <option value="3">2B</option>\n        <option value="2">3</option>\n        <option value="1">3A</option>\n      </select>\n    </td>\n    <td>\n      <select class="gender-select" id="gender-${e}" data-row="${e}">\n        <option value="">-</option>\n        <option value="M">M</option>\n        <option value="F">F</option>\n      </select>\n    </td>\n    <td class="checkbox-cell">\n      <input type="checkbox" class="status-checkbox" id="nhc-${e}" data-row="${e}">\n    </td>\n    <td class="checkbox-cell">\n      <input type="checkbox" class="status-checkbox" id="nxd-${e}" data-row="${e}">\n    </td>\n    <td class="checkbox-cell">\n      <input type="checkbox" class="status-checkbox" id="resting-${e}" data-row="${e}">\n    </td>\n    <td class="checkbox-cell">\n      <input type="checkbox" class="status-checkbox" id="pso-${e}" data-row="${e}">\n    </td>\n    <td class="checkbox-cell">\n      <input type="checkbox" class="status-checkbox" id="so-${e}" data-row="${e}">\n    </td>\n  `,t.appendChild(a);const n=a.querySelector(".name-input");n.addEventListener("input",t=>handleNameInput(t,e)),n.addEventListener("keydown",t=>handleNameKeydown(t,e)),n.addEventListener("blur",t=>setTimeout(()=>hideSuggestions(e),150));a.querySelector(`#resting-${e}`).addEventListener("change",t=>{playerRows[e].resting=t.target.checked,updateSitOffCalculation(),updateProceedButton(),saveDataToStorage()});a.querySelector(`#pso-${e}`).addEventListener("change",t=>{playerRows[e].pso=t.target.checked,saveDataToStorage()});a.querySelector(`#so-${e}`).addEventListener("change",t=>{playerRows[e].so=t.target.checked,updateSitOffCalculation(),updateProceedButton(),saveDataToStorage()});a.querySelector(`[data-row="${e}"].delete-player-btn`).addEventListener("click",()=>{clearPlayerRow(e),saveDataToStorage()});a.querySelector(`#grade-${e}`).addEventListener("change",t=>{playerRows[e].grade=""===t.target.value?"":parseInt(t.target.value),updateSitOffCalculation(),updateProceedButton(),saveDataToStorage()});a.querySelector(`#gender-${e}`).addEventListener("change",t=>{playerRows[e].gender=t.target.value,updateSitOffCalculation(),updateProceedButton(),saveDataToStorage()});a.querySelector(`#nhc-${e}`).addEventListener("change",t=>{playerRows[e].nhc=t.target.checked,saveDataToStorage()});a.querySelector(`#nxd-${e}`).addEventListener("change",t=>{playerRows[e].nxd=t.target.checked,saveDataToStorage()})}function showSaveIndicator(){let e=document.getElementById("saveIndicator");e||(e=document.createElement("div"),e.id="saveIndicator",e.style.cssText="\n      position: fixed;\n      top: 20px;\n      right: 20px;\n      background: #28a745;\n      color: white;\n      padding: 8px 16px;\n      border-radius: 4px;\n      font-size: 14px;\n      z-index: 10000;\n      transition: opacity 0.3s;\n    ",document.body.appendChild(e)),e.textContent="Saved ✓",e.style.opacity="1",setTimeout(()=>{e.style.opacity="0"},2e3)}function clearSavedData(){confirm("Are you sure you want to clear all saved data? This cannot be undone.")&&(localStorage.removeItem("tennisMatchMaker_autoSave"),localStorage.removeItem("tennisMatchMaker_lastSave"),alert("Saved data cleared successfully."))}function log(e){console.log(e),debugLog.push(e)}function scrollToElement(e){const t=document.getElementById(e);t&&t.scrollIntoView({behavior:"smooth",block:"start"})}function translateGrade(e){switch(e){case 5:return"2";case 4:return"2A";case 3:return"2B";case 2:return"3";case 1:return"3A";default:return e}}function reverseTranslateGrade(e){switch(e){case"2":return 5;case"2A":return 4;case"2B":return 3;case"3":return 2;case"3A":return 1;default:return e}}function generateJSFileContent(e){let t="// Tennis Club Member Master List\n";return t+="// Generated on: "+(new Date).toLocaleString()+"\n",t+="// Total Members: "+e.length+"\n\n",t+="const MEMBERS = [\n",e.forEach((a,n)=>{t+="  {\n",t+=`    name: "${a.name}",\n`,t+=`    grade: ${a.grade},\n`,t+=`    gender: "${a.gender}",\n`,t+=`    nhc: ${a.nhc}\n`,t+="  }",n<e.length-1&&(t+=","),t+="\n"}),t+="];\n",t}function downloadJSFile(e){const t=new Blob([e],{type:"text/javascript"}),a=URL.createObjectURL(t),n=document.createElement("a");n.href=a;const r=(new Date).toISOString().slice(0,19).replace(/:/g,"-");n.download=`Member Master List - Updated ${r}.js`,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(a)}function initializeCourts(){const e=document.getElementById("courtPool");e.innerHTML="";const t=[];for(let e=1;e<=27;e++)t.push(e.toString());for(let e=1;e<=10;e++)t.push("H"+e);t.forEach(t=>{const a=document.createElement("div"),n=t.toString().toUpperCase().startsWith("H");a.className=n?"court-item hard-court":"court-item grass-court",a.textContent=t,a.draggable=!0,a.dataset.court=t,a.addEventListener("dragstart",handleCourtDragStart),a.addEventListener("dragend",handleCourtDragEnd),a.addEventListener("click",()=>moveCourtToSelected(t,a)),e.appendChild(a)})}function handleCourtDragStart(e){e.dataTransfer.setData("text/plain",e.target.dataset.court),e.target.classList.add("dragging")}function handleCourtDragEnd(e){e.target.classList.remove("dragging")}const availableCourtsDiv=document.getElementById("availableCourts");function generateUpdatedMasterList(){try{let e=[...masterListData];const t=playerRows.filter(e=>e.name&&""!==e.name.trim()&&""!==e.grade&&""!==e.gender);let a=0,n=0;t.forEach(t=>{const r=e.findIndex(e=>e.name.toLowerCase()===t.name.toLowerCase());if(r>=0){const a=e[r];a.grade===t.grade&&a.gender===t.gender&&a.nhc===t.nhc||(e[r]={name:t.name,grade:t.grade,gender:t.gender,nhc:t.nhc},n++)}else e.push({name:t.name,grade:t.grade,gender:t.gender,nhc:t.nhc}),a++}),e.sort((e,t)=>e.name.localeCompare(t.name));downloadJSFile(generateJSFileContent(e));const r=`Master list updated successfully!\nAdded: ${a} new players\nUpdated: ${n} existing players\nTotal players: ${e.length}`;alert(r),log(`Master list generated: ${a} added, ${n} updated, ${e.length} total`)}catch(e){alert(`Error generating master list: ${e.message}`),log(`Error generating master list: ${e.message}`)}}function updateAvailableCourtsDisplay(){const e=document.getElementById("availableCourts");0!==availableCourts.length?(e.innerHTML="",availableCourts.forEach((t,a)=>{const n=document.createElement("div"),r=t.toString().toUpperCase().startsWith("H");n.className=r?"court-item hard-court":"court-item grass-court",n.textContent=t,n.style.cursor="pointer",n.title="Click to remove from selection",n.addEventListener("click",()=>{moveCourtBackToPool(t,a)}),e.appendChild(n)})):e.innerHTML='<em style="color: #666;">Click courts below to add them in priority order...</em>'}function moveCourtBackToPool(e,t){availableCourts.splice(t,1),updateAvailableCourtsDisplay(),addCourtToPool(e)}function addCourtToPool(e){const t=document.getElementById("courtPool"),a=document.createElement("div"),n=e.toString().toUpperCase().startsWith("H");a.className=n?"court-item hard-court":"court-item grass-court",a.textContent=e,a.draggable=!0,a.dataset.court=e,a.style.cursor="pointer",a.title="Click to add to selection, or drag to specific position",a.addEventListener("dragstart",handleCourtDragStart),a.addEventListener("dragend",handleCourtDragEnd),a.addEventListener("click",()=>{availableCourts.includes(e)||moveCourtToSelected(e,a)});const r=Array.from(t.children);let o=r.length;for(let t=0;t<r.length;t++){const a=r[t].dataset.court;if(shouldCourtComeBefore(e,a)){o=t;break}}o>=r.length?t.appendChild(a):t.insertBefore(a,r[o])}function shouldCourtComeBefore(e,t){const a=e.toString().toUpperCase().startsWith("H"),n=t.toString().toUpperCase().startsWith("H");if(!a&&n)return!0;if(a&&!n)return!1;if(a||n){return parseInt(e.substring(1))<parseInt(t.substring(1))}return parseInt(e)<parseInt(t)}function moveCourtToSelected(e,t){availableCourts.includes(e)||(availableCourts.push(e),updateAvailableCourtsDisplay(),saveDataToStorage(),t.remove())}function loadMemberListOnStartup(){try{if("undefined"==typeof MEMBERS)return void(document.getElementById("memberLoadStatus").innerHTML='<div class="error">❌ Member Master List.js file not found. Please ensure the file is in the same folder as this HTML file.</div>');masterListData=MEMBERS.map(e=>({name:e.name,grade:reverseTranslateGrade(e.grade),gender:e.gender,nhc:e.nhc,nxd:e.nxd,originalGrade:e.grade})),document.getElementById("memberLoadStatus").innerHTML=`<div class="success">✓ Loaded ${masterListData.length} players from member list</div>`,document.getElementById("playerSelectionSection").style.display="block",initializePlayerTable()}catch(e){document.getElementById("memberLoadStatus").innerHTML=`<div class="error">Error loading member list: ${e.message}</div>`}}function initializePlayerTable(){playerRows=[];document.getElementById("playerTableBody").innerHTML="";for(let e=0;e<10;e++)addPlayerRow();updateSitOffCalculation()}function addPlayerRow(){const e=document.getElementById("playerTableBody"),t=playerRows.length;playerRows.push({name:"",grade:"",gender:"",nhc:!1,nxd:!1,resting:!1,pso:!1,so:!1});const a=document.createElement("tr");a.innerHTML=`\n  <td style="position: relative;">\n    <div style="display: flex; align-items: center; gap: 5px;">\n      <input type="text" class="name-input" placeholder="Start typing name..." \n             data-row="${t}" autocomplete="off" style="flex: 1;">\n      <button type="button" class="delete-player-btn" data-row="${t}" \n              style="background: #dc3545; color: white; border: none; border-radius: 3px; \n                     padding: 3px 6px; font-size: 12px; cursor: pointer; display: none;"\n              title="Remove player">×</button>\n    </div>\n    <div class="autocomplete-suggestions" id="suggestions-${t}" style="display: none;"></div>\n  </td>\n  <td>\n    <select class="grade-select" id="grade-${t}" data-row="${t}">\n  <option value="">-</option>\n  <option value="5">2</option>\n  <option value="4">2A</option>\n  <option value="3">2B</option>\n  <option value="2">3</option>\n  <option value="1">3A</option>\n</select>\n  </td>\n  <td>\n    <select class="gender-select" id="gender-${t}" data-row="${t}">\n      <option value="">-</option>\n      <option value="M">M</option>\n      <option value="F">F</option>\n    </select>\n  </td>\n <td class="checkbox-cell">\n  <input type="checkbox" class="status-checkbox" id="nhc-${t}" data-row="${t}">\n</td>\n<td class="checkbox-cell">\n  <input type="checkbox" class="status-checkbox" id="nxd-${t}" data-row="${t}">\n</td>\n<td class="checkbox-cell">\n  <input type="checkbox" class="status-checkbox" id="resting-${t}" data-row="${t}">\n</td>\n<td class="checkbox-cell">\n  <input type="checkbox" class="status-checkbox" id="pso-${t}" data-row="${t}">\n</td>\n<td class="checkbox-cell">\n  <input type="checkbox" class="status-checkbox" id="so-${t}" data-row="${t}">\n</td>\n`,e.appendChild(a);const n=a.querySelector(".name-input");n.addEventListener("input",e=>handleNameInput(e,t)),n.addEventListener("keydown",e=>handleNameKeydown(e,t)),n.addEventListener("blur",e=>setTimeout(()=>hideSuggestions(t),150)),n.addEventListener("input",e=>{playerRows[t].name=e.target.value;const n=a.querySelector(`[data-row="${t}"].delete-player-btn`);""!==e.target.value.trim()&&""!==playerRows[t].grade&&""!==playerRows[t].gender?n.style.display="block":n.style.display="none",updateSitOffCalculation(),updateProceedButton()});a.querySelector(`#resting-${t}`).addEventListener("change",e=>{playerRows[t].resting=e.target.checked,updateSitOffCalculation(),updateProceedButton()});a.querySelector(`#pso-${t}`).addEventListener("change",e=>{playerRows[t].pso=e.target.checked});a.querySelector(`#so-${t}`).addEventListener("change",e=>{playerRows[t].so=e.target.checked,updateSitOffCalculation(),updateProceedButton()});a.querySelector(`[data-row="${t}"].delete-player-btn`).addEventListener("click",()=>{clearPlayerRow(t)});a.querySelector(`#grade-${t}`).addEventListener("change",e=>{playerRows[t].grade=""===e.target.value?"":parseInt(e.target.value);const n=a.querySelector(".name-input"),r=a.querySelector(`[data-row="${t}"].delete-player-btn`);""!==n.value.trim()&&""!==playerRows[t].grade&&""!==playerRows[t].gender&&(r.style.display="block"),updateSitOffCalculation(),updateProceedButton()});a.querySelector(`#gender-${t}`).addEventListener("change",e=>{playerRows[t].gender=e.target.value;const n=a.querySelector(".name-input"),r=a.querySelector(`[data-row="${t}"].delete-player-btn`);""!==n.value.trim()&&""!==playerRows[t].grade&&""!==playerRows[t].gender&&(r.style.display="block"),updateSitOffCalculation(),updateProceedButton()});a.querySelector(`#nhc-${t}`).addEventListener("change",e=>{playerRows[t].nhc=e.target.checked});a.querySelector(`#nxd-${t}`).addEventListener("change",e=>{playerRows[t].nxd=e.target.checked})}function handleNameInput(e,t){const a=e.target.value.toLowerCase(),n=document.getElementById(`suggestions-${t}`);if(0===a.length)return void hideSuggestions(t);const r=playerRows.map((e,a)=>a!==t?e.name:null).filter(e=>e&&""!==e.trim()),o=masterListData.filter(e=>e.name.toLowerCase().includes(a)&&!r.includes(e.name)).sort((e,t)=>e.name.localeCompare(t.name)).slice(0,10);0!==o.length?(n.innerHTML="",o.forEach((e,a)=>{const r=document.createElement("div");r.className="autocomplete-suggestion",0===a&&r.classList.add("selected"),r.textContent=`${e.name} (${e.originalGrade||translateGrade(e.grade)})`,r.addEventListener("click",()=>selectPlayer(t,e)),n.appendChild(r)}),n.style.display="block"):hideSuggestions(t)}function handleNameKeydown(e,t){const a=document.getElementById(`suggestions-${t}`).querySelectorAll(".autocomplete-suggestion");if(0===a.length)return;let n=-1;if(a.forEach((e,t)=>{e.classList.contains("selected")&&(n=t)}),"ArrowDown"===e.key)e.preventDefault(),n>=0&&a[n].classList.remove("selected"),n=n<a.length-1?n+1:0,a[n].classList.add("selected"),a[n].scrollIntoView({block:"nearest"});else if("ArrowUp"===e.key)e.preventDefault(),n>=0&&a[n].classList.remove("selected"),n=n>0?n-1:a.length-1,a[n].classList.add("selected"),a[n].scrollIntoView({block:"nearest"});else if("Enter"===e.key){e.preventDefault();const t=n>=0?a[n]:a[0];t&&t.click()}else"Escape"===e.key&&hideSuggestions(t)}function selectPlayer(e,t){playerRows[e]={name:t.name,grade:t.grade,gender:t.gender,nhc:t.nhc,nxd:t.nxd,resting:playerRows[e].resting,pso:playerRows[e].pso,so:playerRows[e].so},document.querySelector(`[data-row="${e}"]`).value=t.name,document.getElementById(`grade-${e}`).value=t.grade,document.getElementById(`gender-${e}`).value=t.gender,document.getElementById(`nhc-${e}`).checked=t.nhc,document.getElementById(`nxd-${e}`).checked=t.nxd,document.querySelector(`[data-row="${e}"].delete-player-btn`).style.display="block",hideSuggestions(e),updateSitOffCalculation(),updateProceedButton(),saveDataToStorage(),setTimeout(()=>{for(let t=e+1;t<playerRows.length;t++)if(!playerRows[t].name||""===playerRows[t].name.trim()){const e=document.querySelector(`[data-row="${t}"]`);if(e){e.focus();break}}},100)}function clearPlayerRow(e){playerRows[e]={name:"",grade:"",gender:"",nhc:!1,nxd:!1,resting:!1,pso:!1,so:!1},document.querySelector(`[data-row="${e}"]`).value="",document.getElementById(`grade-${e}`).value="",document.getElementById(`gender-${e}`).value="",document.getElementById(`nhc-${e}`).checked=!1,document.getElementById(`nxd-${e}`).checked=!1,document.getElementById(`resting-${e}`).checked=!1,document.getElementById(`pso-${e}`).checked=!1,document.getElementById(`so-${e}`).checked=!1,document.querySelector(`[data-row="${e}"].delete-player-btn`).style.display="none",updateSitOffCalculation(),updateProceedButton()}function hideSuggestions(e){document.getElementById(`suggestions-${e}`).style.display="none"}function updateSitOffCalculation(){const e=playerRows.filter(e=>e.name&&""!==e.name.trim()&&""!==e.grade&&""!==e.gender&&!e.resting),t=playerRows.filter(e=>e.name&&""!==e.name.trim()&&""!==e.grade&&""!==e.gender&&!e.resting&&e.so),a=e.length%4,n=t.length,r=Math.max(0,a-n),o=document.getElementById("sitOffCount"),l=document.getElementById("sitOffCalculator");o.textContent=r,l.className="sit-off-calculator",(0===a||0===r)&&l.classList.add("sit-off-good")}function updateProceedButton(){const e=playerRows.filter(e=>e.name&&""!==e.name.trim()&&""!==e.grade&&""!==e.gender&&!e.resting),t=playerRows.filter(e=>e.name&&""!==e.name.trim()&&""!==e.grade&&""!==e.gender&&!e.resting&&e.so),a=document.getElementById("proceedToMatches");if(e.length>=4&&availableCourts.length>0){const n=e.length%4,r=t.length;if(0===n&&0===r)a.disabled=!1,a.textContent="Proceed to Match Setup";else if(n>0&&r===n)a.disabled=!1,a.textContent="Proceed to Match Setup";else if(n>0&&r<n){const e=n-r;a.disabled=!0,a.textContent=`Select ${e} more to sit off`}else if(n>0&&r>n){const e=r-n;a.disabled=!0,a.textContent=`Remove ${e} sit-off selections`}else 0===n&&r>0&&(a.disabled=!0,a.textContent=`Remove ${r} sit-off selections (none needed)`)}else a.disabled=!0,a.textContent="Proceed to Match Setup"}function processPlayersAndProceed(){const e=playerRows.filter(e=>e.name&&""!==e.name.trim()&&""!==e.grade&&""!==e.gender&&!e.resting&&!e.so),t=e.filter(e=>"M"===e.gender),a=e.filter(e=>"F"===e.gender),n=availableCourts.map((e,t)=>({priority:t+1,court:e}));currentData={setFormatPreference:document.getElementById("formatSelector").value,availableMen:t,availableWomen:a,courts:n},console.log("Processed data:",currentData),setupManualMatchInterface(currentData),document.getElementById("manualMatchSection").style.display="block",saveDataToStorage(),document.getElementById("generateMatches").textContent=`Generate Remaining Matches for Set ${document.getElementById("setNumberSelector").value}`}function setupManualMatchInterface(e){const t=document.getElementById("manualPlayerGrid"),a=document.getElementById("courtGrid");t.innerHTML="",a.innerHTML="",manualMatches=[],updateManualMatchDisplay();const n=[];e.availableMen.forEach(e=>n.push({...e,gender:"M"})),e.availableWomen.forEach(e=>n.push({...e,gender:"F"})),n.sort((e,t)=>t.grade!==e.grade?t.grade-e.grade:e.name.localeCompare(t.name)),n.forEach(e=>{const a=document.createElement("div");a.className="manual-player-item",a.innerHTML=`${e.name} (${translateGrade(e.grade)})`,a.dataset.playerName=e.name,a.dataset.playerGrade=e.grade,a.dataset.playerGender=e.gender,a.addEventListener("click",()=>selectPlayerForManualMatch(a,e)),t.appendChild(a)}),e.courts.forEach(e=>{const t=document.createElement("div");t.className="court-option",t.innerHTML=`Court ${e.court}`,t.dataset.court=e.court,t.addEventListener("click",()=>selectCourtForManualMatch(t,e.court)),a.appendChild(t)})}function selectPlayerForManualMatch(e,t){if(!e.classList.contains("excluded")){if(e.classList.contains("selected"))e.classList.remove("selected"),selectedManualPlayers=selectedManualPlayers.filter(e=>e.name!==t.name),removePlayerFromTeams(t.name);else{if(selectedManualPlayers.length>=4)return void alert("Maximum 4 players can be selected for a match");e.classList.add("selected"),selectedManualPlayers.push(t),addPlayerToTeam(t)}updateTeamDisplay(),updateAddMatchButton()}}function addPlayerToTeam(e){manualTeam1.length<2?manualTeam1.push(e):manualTeam2.push(e)}function removePlayerFromTeams(e){manualTeam1=manualTeam1.filter(t=>t.name!==e),manualTeam2=manualTeam2.filter(t=>t.name!==e)}function updateTeamDisplay(){const e=document.getElementById("team1Players"),t=document.getElementById("team2Players");e.innerHTML=manualTeam1.map(e=>`<div class="team-player">${e.name} (${translateGrade(e.grade)}, ${e.gender})</div>`).join(""),t.innerHTML=manualTeam2.map(e=>`<div class="team-player">${e.name} (${translateGrade(e.grade)}, ${e.gender})</div>`).join(""),document.getElementById("team1Slot").classList.toggle("has-players",manualTeam1.length>0),document.getElementById("team2Slot").classList.toggle("has-players",manualTeam2.length>0)}function selectCourtForManualMatch(e,t){e.classList.contains("excluded")||(document.querySelectorAll(".court-option").forEach(e=>e.classList.remove("selected")),e.classList.add("selected"),selectedCourt=t,updateAddMatchButton())}function updateAddMatchButton(){const e=document.getElementById("addManualMatch"),t=4===selectedManualPlayers.length&&2===manualTeam1.length&&2===manualTeam2.length&&null!==selectedCourt;e.disabled=!t,e.textContent=t?`Add Match: Court ${selectedCourt}`:"Add Manual Match"}function addManualMatch(){if(4!==selectedManualPlayers.length||!selectedCourt)return;const e=manualTeam1.filter(e=>"M"===e.gender).length,t=manualTeam1.filter(e=>"F"===e.gender).length,a=manualTeam2.filter(e=>"M"===e.gender).length,n=manualTeam2.filter(e=>"F"===e.gender).length;let r;r=1===e&&1===t&&1===a&&1===n?"Mixed Doubles":2===e&&2===a?"Same-Sex Doubles (Men)":2===t&&2===n?"Same-Sex Doubles (Women)":"Mixed Gender";const o={court:selectedCourt,team1:[...manualTeam1],team2:[...manualTeam2],format:r,note:"Manual Setup",isManual:!0};manualMatches.push(o),selectedManualPlayers.forEach(e=>{const t=document.querySelector(`[data-player-name="${e.name}"]`);t&&(t.classList.remove("selected"),t.classList.add("excluded"))});const l=document.querySelector(`[data-court="${selectedCourt}"]`);l&&(l.classList.remove("selected"),l.classList.add("excluded")),selectedManualPlayers=[],selectedCourt=null,manualTeam1=[],manualTeam2=[],updateTeamDisplay(),updateAddMatchButton(),updateManualMatchDisplay(),saveDataToStorage(),console.log(`Manual match added: Court ${o.court} - ${r}`)}function updateManualMatchDisplay(){const e=document.getElementById("manualMatchesList");if(0===manualMatches.length)return void(e.innerHTML='<p style="color: #666; font-style: italic;">No manual matches set up yet.</p>');let t="<h4>Manual Matches:</h4>";manualMatches.forEach((e,a)=>{const n=e.team1.map(e=>`${e.name} (${e.grade})`).join(", "),r=e.team2.map(e=>`${e.name} (${e.grade})`).join(", ");t+=`\n      <div class="manual-match-item">\n        <div class="manual-match-details">\n          <div class="manual-match-court">Court ${e.court}</div>\n          <div class="manual-match-teams">${n} vs ${r}</div>\n          <div style="font-size: 12px; color: #666;">${e.format}</div>\n        </div>\n        <button class="danger" onclick="removeManualMatch(${a})">Remove</button>\n      </div>\n    `}),e.innerHTML=t}function removeManualMatch(e){const t=manualMatches[e];[...t.team1,...t.team2].forEach(e=>{const t=document.querySelector(`[data-player-name="${e.name}"]`);t&&t.classList.remove("excluded")});const a=document.querySelector(`[data-court="${t.court}"]`);a&&a.classList.remove("excluded"),manualMatches.splice(e,1),updateManualMatchDisplay(),console.log(`Manual match removed: Court ${t.court}`)}function clearManualSetup(){document.querySelectorAll(".manual-player-item").forEach(e=>{e.classList.remove("selected","excluded")}),document.querySelectorAll(".court-option").forEach(e=>{e.classList.remove("selected","excluded")}),selectedManualPlayers=[],selectedCourt=null,manualTeam1=[],manualTeam2=[],updateTeamDisplay(),updateAddMatchButton()}function processMatchesWithManualSetup(){const e=[],t=[];manualMatches.forEach(a=>{a.team1.forEach(t=>e.push(t.name)),a.team2.forEach(t=>e.push(t.name)),t.push(a.court)});const a={...currentData,availableMen:currentData.availableMen.filter(t=>!e.includes(t.name)),availableWomen:currentData.availableWomen.filter(t=>!e.includes(t.name)),courts:currentData.courts.filter(e=>!t.includes(e.court))};console.log(`Excluded ${e.length} players and ${t.length} courts for manual matches`);const n=(a.availableMen.length+a.availableWomen.length)%4;if(0===n){processMatchesWithAdjustedData(a)}else alert(`Cannot proceed: ${n} players remaining after manual matches. Need multiple of 4.`)}function processMatches(){if(detectPerfect16Scenario()){const e=generatePerfect16Matches(parseInt(document.getElementById("setNumberSelector").value));if(e){const t=processCourtPreferences(currentData,e);return currentMatches=t,void displayResults(currentData,t)}6===parseInt(document.getElementById("setNumberSelector").value)&&log("=== EXITING PERFECT 16 MODE - SWITCHING TO NORMAL ALGORITHMS ==="),log("Perfect 16 failed, falling back to normal algorithm")}log("=== STARTING MATCH FORMATION ===");const e=sortPlayers(currentData),t=balanceIndividualMatches(e,fixUncompetitiveMatches(e,autoFixRepeatOpponents(e,autoFixRepeatPartnerships(e,processCourtPreferences(e,formMatchesStrict(e).map(e=>balanceTeamsIfNeeded(e)))))));currentData=e,currentMatches=t,displayResults(e,t)}function processMatchesWithAdjustedData(e){if(detectPerfect16Scenario()){const e=generatePerfect16Matches(parseInt(document.getElementById("setNumberSelector").value));if(e){const t=processCourtPreferences(currentData,e);return currentMatches=t,void displayResults(currentData,t)}log("Perfect 16 failed, falling back to normal algorithm")}log("=== STARTING MATCH FORMATION (ADJUSTED FOR MANUAL MATCHES) ===");const t=sortPlayers(e),a=balanceIndividualMatches(t,fixUncompetitiveMatches(t,autoFixRepeatOpponents(t,autoFixRepeatPartnerships(t,processCourtPreferences(t,formMatchesStrict(t).map(e=>balanceTeamsIfNeeded(e)))))));currentMatches=a,displayResults(currentData,a)}function sortPlayers(e){const t=e.availableMen.sort((e,t)=>t.grade-e.grade),a=e.availableWomen.sort((e,t)=>t.grade-e.grade),n=parseInt(document.getElementById("setNumberSelector").value);let r,o;r=mixABSmart(t.slice(),n),o=mixABSmart(a.slice(),n),log("Applied A/B Smart Mixing for Set "+n),log("=== SORTED PLAYERS (after mixing) ===");for(let e=5;e>=1;e--){const t=r.filter(t=>t.grade===e).length,a=o.filter(t=>t.grade===e).length;(t>0||a>0)&&log("Grade "+e+": "+t+" men, "+a+" women")}return{...e,sortedMen:r,sortedWomen:o}}function formMatchesStrict(e){return log("=== STRICT MATCH FORMATION ==="),"Mixed"===e.setFormatPreference?formMixedDoublesMatches(e):formSameSexDoublesMatches(e)}function formMixedDoublesMatches(e){log("Using Mixed Doubles Logic");const t=[],a=new Set;let n=0;const r=(t,r,o,l)=>{if(n>=e.courts.length)return log("ERROR: No more courts available"),null;const s=t.filter(t=>e.sortedMen.find(e=>e.name===t.name)).length,c=t.filter(t=>e.sortedWomen.find(e=>e.name===t.name)).length,d=r.filter(t=>e.sortedMen.find(e=>e.name===t.name)).length,i=r.filter(t=>e.sortedWomen.find(e=>e.name===t.name)).length;if(2===s&&0===c&&0===d&&2===i||0===s&&2===c&&2===d&&0===i)return log("ERROR: Attempted prohibited 2M vs 2W match"),null;const m=e.courts[n].court;return n++,t.forEach(e=>a.add(e.name)),r.forEach(e=>a.add(e.name)),log("Created match on Court "+m+": "+t.map(e=>e.name+"("+e.grade+")").join(",")+" vs "+r.map(e=>e.name+"("+e.grade+")").join(",")+" - "+o),{court:m,team1:t,team2:r,format:o,note:l}};for(let n=5;n>=1;n--){log("=== PROCESSING GRADE "+n+" ===");const o=e.sortedMen.filter(e=>e.grade===n&&!a.has(e.name)),l=e.sortedWomen.filter(e=>e.grade===n&&!a.has(e.name)),s=e.sortedMen.filter(e=>e.grade===n-1&&!a.has(e.name)),c=e.sortedWomen.filter(e=>e.grade===n-1&&!a.has(e.name));if(1===o.length&&1===l.length&&s.length>=1&&c.length>=1){const e=r([o[0],c[0]],[s[0],l[0]],"Mixed Doubles","Cross-grade balanced");if(e){t.push(e);continue}}for(;;){const o=e.sortedMen.filter(e=>e.grade===n&&!a.has(e.name)),l=e.sortedWomen.filter(e=>e.grade===n&&!a.has(e.name));if(!(o.length>=2&&l.length>=2))break;{const e=r([o[0],l[0]],[o[1],l[1]],"Mixed Doubles","In-grade");e&&t.push(e)}}log("MANDATORY COMPLETION: All Grade "+n+" players must be assigned");let d=0;for(;d<100;){d++;const o=e.sortedMen.filter(e=>e.grade===n&&!a.has(e.name)),l=e.sortedWomen.filter(e=>e.grade===n&&!a.has(e.name));if(0===o.length&&0===l.length){log("✓ SUCCESS: ALL Grade "+n+" players assigned");break}const s=e.sortedMen.filter(e=>e.grade<n&&!a.has(e.name)),c=e.sortedWomen.filter(e=>e.grade<n&&!a.has(e.name));log("Attempt "+d+": Grade "+n+" remaining: "+o.length+"M + "+l.length+"F"),log("Available lower: "+s.length+"M + "+c.length+"F");let i=!1;if(o.length>=4){const e=r([o[0],o[1]],[o[2],o[3]],"Same-Sex Doubles (Men)","Mandatory completion");e&&(t.push(e),i=!0)}else if(l.length>=4){const e=r([l[0],l[1]],[l[2],l[3]],"Same-Sex Doubles (Women)","Mandatory completion");e&&(t.push(e),i=!0)}else if(3===o.length&&l.length>=1){const e=r([o[0],l[0]],[o[1],o[2]],"Mixed Gender","Mandatory completion 3M+1W");e&&(t.push(e),i=!0)}else if(3===l.length&&o.length>=1){const e=r([o[0],l[0]],[l[1],l[2]],"Mixed Gender","Mandatory completion 1M+3W");e&&(t.push(e),i=!0)}else if(o.length>=2&&c.length>=2){const e=r([o[0],c[0]],[o[1],c[1]],"Mixed Doubles","Cross-grade completion");e&&(t.push(e),i=!0)}else if(l.length>=2&&s.length>=2){const e=r([s[0],l[0]],[s[1],l[1]],"Mixed Doubles","Cross-grade completion");e&&(t.push(e),i=!0)}else if(o.length>=1&&s.length>=3){const e=r([o[0],s[0]],[s[1],s[2]],"Same-Sex Doubles (Men)","Cross-grade completion");e&&(t.push(e),i=!0)}else if(l.length>=1&&c.length>=3){const e=r([l[0],c[0]],[c[1],c[2]],"Same-Sex Doubles (Women)","Cross-grade completion");e&&(t.push(e),i=!0)}else if(o.length>=1&&s.length>=1&&c.length>=2){const e=r([o[0],c[0]],[s[0],c[1]],"Mixed Doubles","Cross-grade completion");e&&(t.push(e),i=!0)}else if(l.length>=1&&c.length>=1&&s.length>=2){const e=r([s[0],l[0]],[s[1],c[0]],"Mixed Doubles","Cross-grade completion");e&&(t.push(e),i=!0)}if(!i){log("❌ CRITICAL ERROR: Cannot complete Grade "+n),log("Remaining target players: "+o.map(e=>e.name).join(",")+" | "+l.map(e=>e.name).join(",")),log("Available lower players: "+s.length+"M + "+c.length+"F");break}}}log("=== FINAL CLEANUP PHASE ===");let o=0;for(;o<20;){o++;const n=e.sortedMen.filter(e=>!a.has(e.name)),l=e.sortedWomen.filter(e=>!a.has(e.name));if(0===n.length&&0===l.length){log("✓ CLEANUP SUCCESS: All players assigned");break}log("Cleanup attempt "+o+": "+n.length+"M + "+l.length+"W remaining");let s=!1;if(n.length>=4){const e=r([n[0],n[1]],[n[2],n[3]],"Same-Sex Doubles (Men)","Final cleanup");e&&(t.push(e),s=!0)}else if(l.length>=4){const e=r([l[0],l[1]],[l[2],l[3]],"Same-Sex Doubles (Women)","Final cleanup");e&&(t.push(e),s=!0)}else if(n.length>=2&&l.length>=2){const e=r([n[0],l[0]],[n[1],l[1]],"Mixed Doubles","Final cleanup");e&&(t.push(e),s=!0)}else if(3===n.length&&1===l.length){const e=r([n[0],l[0]],[n[1],n[2]],"Mixed Gender","Final cleanup 3M+1W");e&&(t.push(e),s=!0)}else if(3===l.length&&1===n.length){const e=r([n[0],l[0]],[l[1],l[2]],"Mixed Gender","Final cleanup 1M+3W");e&&(t.push(e),s=!0)}if(!s){log("❌ CLEANUP FAILED: Cannot form matches from remaining players");break}}const l=e.sortedMen.filter(e=>!a.has(e.name)),s=e.sortedWomen.filter(e=>!a.has(e.name));return log("=== FINAL STATUS ==="),log("Total matches created: "+t.length),log("Unassigned players: "+(l.length+s.length)),(l.length>0||s.length>0)&&(log("❌ ERROR: Players remain unassigned!"),log("Unassigned men: "+l.map(e=>e.name+"("+e.grade+")").join(", ")),log("Unassigned women: "+s.map(e=>e.name+"("+e.grade+")").join(", "))),t}function formSameSexDoublesMatches(e){log("Using Same-Sex Doubles Logic");const t=[],a=new Set;let n=0;const r=(t,r,o,l)=>{if(n>=e.courts.length)return null;const s=e.courts[n].court;return n++,t.forEach(e=>a.add(e.name)),r.forEach(e=>a.add(e.name)),log("Created match on Court "+s+": "+t.map(e=>e.name+"("+e.grade+")").join(",")+" vs "+r.map(e=>e.name+"("+e.grade+")").join(",")),{court:s,team1:t,team2:r,format:o,note:l}};for(let n=5;n>=1;n--){for(log("=== PROCESSING GRADE "+n+" ===");;){const o=e.sortedMen.filter(e=>e.grade===n&&!a.has(e.name));if(!(o.length>=4))break;{const e=r([o[0],o[1]],[o[2],o[3]],"Same-Sex Doubles (Men)","In-grade");e&&t.push(e)}}for(;;){const o=e.sortedWomen.filter(e=>e.grade===n&&!a.has(e.name));if(!(o.length>=4))break;{const e=r([o[0],o[1]],[o[2],o[3]],"Same-Sex Doubles (Women)","In-grade");e&&t.push(e)}}let o=0;for(;o<20;){o++;const l=e.sortedMen.filter(e=>e.grade===n&&!a.has(e.name)),s=e.sortedWomen.filter(e=>e.grade===n&&!a.has(e.name));if(0===l.length&&0===s.length){log("✓ SUCCESS: ALL Grade "+n+" players assigned");break}const c=e.sortedMen.filter(e=>e.grade<n&&!a.has(e.name)),d=e.sortedWomen.filter(e=>e.grade<n&&!a.has(e.name));let i=!1;if(!i&&3===l.length&&c.length>=1){const e=r([l[0],l[1]],[l[2],c[0]],"Same-Sex Doubles (Men)","Cross-grade 3+1 (preferred for exactly 3 leftovers)");e&&(t.push(e),i=!0)}else if(!i&&3===s.length&&d.length>=1){const e=r([s[0],s[1]],[s[2],d[0]],"Same-Sex Doubles (Women)","Cross-grade 3+1 (preferred for exactly 3 leftovers)");e&&(t.push(e),i=!0)}else if(!i&&l.length>=2&&c.length>=2){const e=r([l[0],c[0]],[l[1],c[1]],"Same-Sex Doubles (Men)","Cross-grade 2+2 (preferred after 3+1)");e&&(t.push(e),i=!0)}else if(!i&&s.length>=2&&d.length>=2){const e=r([s[0],d[0]],[s[1],d[1]],"Same-Sex Doubles (Women)","Cross-grade 2+2 (preferred after 3+1)");e&&(t.push(e),i=!0)}else if(i||3!==l.length||1!==s.length)if(i||3!==s.length||1!==l.length){if(!i&&l.length>=2&&d.length>=2){const e=r([l[0],d[0]],[l[1],d[1]],"Mixed Doubles","Cross-grade mixed completion");e&&(t.push(e),i=!0)}else if(!i&&s.length>=2&&c.length>=2){const e=r([c[0],s[0]],[c[1],s[1]],"Mixed Doubles","Cross-grade mixed completion");e&&(t.push(e),i=!0)}else if(!i&&l.length>=1&&c.length>=3){const e=r([l[0],c[0]],[c[1],c[2]],"Same-Sex Doubles (Men)","Cross-grade 1+3 fallback (last resort)");e&&(t.push(e),i=!0)}else if(!i&&s.length>=1&&d.length>=3){const e=r([s[0],d[0]],[d[1],d[2]],"Same-Sex Doubles (Women)","Cross-grade 1+3 fallback (last resort)");e&&(t.push(e),i=!0)}}else{const e=r([l[0],s[0]],[s[1],s[2]],"Mixed Gender","1M+3W completion");e&&(t.push(e),i=!0)}else{const e=r([l[0],s[0]],[l[1],l[2]],"Mixed Gender","3M+1W completion");e&&(t.push(e),i=!0)}if(!i){log("Cannot complete Grade "+n+" - remaining: "+l.length+"M + "+s.length+"F");break}}}log("=== FINAL CLEANUP PHASE ===");let o=0;for(;o<20;){o++;const n=e.sortedMen.filter(e=>!a.has(e.name)),l=e.sortedWomen.filter(e=>!a.has(e.name));if(0===n.length&&0===l.length){log("✓ CLEANUP SUCCESS: All players assigned");break}log("Cleanup attempt "+o+": "+n.length+"M + "+l.length+"W remaining");let s=!1;if(n.length>=4){const e=r([n[0],n[1]],[n[2],n[3]],"Same-Sex Doubles (Men)","Final cleanup");e&&(t.push(e),s=!0)}else if(l.length>=4){const e=r([l[0],l[1]],[l[2],l[3]],"Same-Sex Doubles (Women)","Final cleanup");e&&(t.push(e),s=!0)}else if(n.length>=2&&l.length>=2){const e=r([n[0],l[0]],[n[1],l[1]],"Mixed Doubles","Final cleanup");e&&(t.push(e),s=!0)}else if(3===n.length&&1===l.length){const e=r([n[0],l[0]],[n[1],n[2]],"Mixed Gender","Final cleanup 3M+1W");e&&(t.push(e),s=!0)}else if(3===l.length&&1===n.length){const e=r([n[0],l[0]],[l[1],l[2]],"Mixed Gender","Final cleanup 1M+3W");e&&(t.push(e),s=!0)}if(!s){log("❌ CLEANUP FAILED: Cannot form matches from remaining players");break}}return log("=== FINAL STATUS ==="),log("Total matches created: "+t.length),t}function balanceTeamsIfNeeded(e){if("Same-Sex Doubles (Men)"!==e.format&&"Same-Sex Doubles (Women)"!==e.format)return e;const t=e.team1.map(e=>e.grade),a=e.team2.map(e=>e.grade),n=t.filter(e=>e>=4).length,r=a.filter(e=>e>=4).length;if(2===n&&0===r){const n=t[0]<t[1]?0:1,r=a[0]>a[1]?0:1,o=e.team1[n];e.team1[n]=e.team2[r],e.team2[r]=o,log("⚖️ Balanced teams: Swapped "+o.name+" ↔ "+e.team1[n].name)}else if(0===n&&2===r){const n=a[0]<a[1]?0:1,r=t[0]>t[1]?0:1,o=e.team2[n];e.team2[n]=e.team1[r],e.team1[r]=o,log("⚖️ Balanced teams: Swapped "+o.name+" ↔ "+e.team2[n].name)}return e}function processCourtPreferences(e,t){log("=== COURT PREFERENCES ===");const a=t=>[...t.team1,...t.team2].some(t=>{const a=e.sortedMen?e.sortedMen.find(e=>e.name===t.name):null,n=e.sortedWomen?e.sortedWomen.find(e=>e.name===t.name):null,r=!a&&e.availableMen?e.availableMen.find(e=>e.name===t.name):null,o=!n&&e.availableWomen?e.availableWomen.find(e=>e.name===t.name):null,l=a||n||r||o;return l&&l.nhc}),n=[],r=[];t.forEach((e,t)=>{var o;(o=e.court)&&o.toString().toUpperCase().startsWith("H")&&a(e)?n.push({index:t,match:e}):(e=>{const t=e&&e.toString().toUpperCase();return t&&(t.startsWith("G")||!t.startsWith("H")&&/^\d+$/.test(t))})(e.court)&&!a(e)&&r.push({index:t,match:e})});const o=Math.min(n.length,r.length);for(let e=0;e<o;e++){const a=n[e].match.court;t[n[e].index].court=r[e].match.court,t[r[e].index].court=a,log("Court swap: "+a+" ↔ "+r[e].match.court)}return t}function checkForRepeatPartnerships(e,t){if(e<=1)return[];const a=[],n=[];t.forEach((e,t)=>{2===e.team1.length&&n.push({matchIndex:t,team:1,players:[e.team1[0].name,e.team1[1].name].sort()}),2===e.team2.length&&n.push({matchIndex:t,team:2,players:[e.team2[0].name,e.team2[1].name].sort()})});for(let t=1;t<e;t++){if(!allSetsData[t]||!allSetsData[t].matches)continue;const e=allSetsData[t].matches,r=[];e.forEach(e=>{2===e.team1.length&&r.push([e.team1[0].name,e.team1[1].name].sort()),2===e.team2.length&&r.push([e.team2[0].name,e.team2[1].name].sort())}),n.forEach(e=>{r.forEach(n=>{e.players[0]===n[0]&&e.players[1]===n[1]&&(a.push({matchIndex:e.matchIndex,team:e.team,players:e.players,previousSet:t}),log("Repeat partnership found: "+e.players.join(" & ")+" (previously in Set "+t+")"))})})}return a}function checkForRepeatOpponents(e,t){if(e<=1)return[];const a=[],n=allSetsData[e-1];if(!n||!n.matches)return[];const r=n.matches;return t.forEach((t,n)=>{const o=[...t.team1,...t.team2];for(let l=0;l<o.length;l++)for(let s=l+1;s<o.length;s++){const c=o[l],d=o[s];(t.team1.some(e=>e.name===c.name)?1:2)!==(t.team1.some(e=>e.name===d.name)?1:2)&&r.forEach(t=>{const r=t.team1.some(e=>e.name===c.name)?1:t.team2.some(e=>e.name===c.name)?2:0,o=t.team1.some(e=>e.name===d.name)?1:t.team2.some(e=>e.name===d.name)?2:0;0!==r&&0!==o&&r!==o&&(a.push({matchIndex:n,player1:c.name,player2:d.name}),log("Repeat opponents found: "+c.name+" vs "+d.name+" (previously opponents in Set "+(e-1)+")"))})}}),a}function autoFixRepeatPartnerships(e,t){const a=parseInt(document.getElementById("setNumberSelector").value);if(a<=1)return t;log("=== AUTO-FIXING REPEAT PARTNERSHIPS ===");const n=JSON.parse(JSON.stringify(t)),r=checkForRepeatPartnerships(a,n);if(0===r.length)return log("No repeat partnerships found - no auto-fixes needed"),n;log("Found "+r.length+" repeat partnerships to attempt fixing");log("Repeat partnership limit set to: 20"),r.length>20&&(log("=== REPEAT PARTNERSHIP THRESHOLD EXCEEDED ==="),log("Found "+r.length+" repeat partnerships (>20)"),log("Skipping Phase 2 inter-match fixes to prevent memory issues"),log("Phase 1 intra-match fixes will still be attempted"),log("Remaining repeat partnerships must be resolved manually by operator")),log("=== PHASE 1: INTRA-MATCH FIXES ==="),r.forEach((t,r)=>{const o=t.matchIndex,l=parseInt(t.team),s=n[o],c=1===l?s.team1:s.team2,d=1===l?s.team2:s.team1;log("Attempting intra-match fix for: "+t.players.join(" & ")+" (Match "+o+", Team "+l+")");let i=!1;if(s.format.includes("Same-Sex")){const t=checkForRepeatPartnerships(a,n).length;for(let r=0;r<c.length&&!i;r++)for(let s=0;s<d.length&&!i;s++){const m=c[r],u=d[s];if(getPlayerGender(m.name,e)!==getPlayerGender(u.name,e))continue;const g=JSON.parse(JSON.stringify(n)),p=g[o],h=1===l?p.team1:p.team2,f=1===l?p.team2:p.team1,y=h[r];h[r]=f[s],f[s]=y;const S=checkForRepeatPartnerships(a,g).length;if(S<t){c[r]=u,d[s]=m,log("✅ Intra-match fix (Same-Sex): Swapped "+m.name+" ↔ "+u.name),log("  Repeat partnerships reduced from "+t+" to "+S),i=!0;break}}}else if("Mixed Doubles"===s.format){const t=checkForRepeatPartnerships(a,n).length,r=[...s.team1,...s.team2],l=r.filter(t=>"M"===getPlayerGender(t.name,e)),c=r.filter(t=>"F"===getPlayerGender(t.name,e));if(2===l.length&&!i){const e=JSON.parse(JSON.stringify(n)),r=e[o];let c=null,d=null,m=null,u=null;if(r.team1.forEach((e,t)=>{e.name===l[0].name&&(c=r.team1,d=t),e.name===l[1].name&&(m=r.team1,u=t)}),r.team2.forEach((e,t)=>{e.name===l[0].name&&(c=r.team2,d=t),e.name===l[1].name&&(m=r.team2,u=t)}),c&&m&&null!==d&&null!==u){const n=c[d];c[d]=m[u],m[u]=n;const r=checkForRepeatPartnerships(a,e).length;if(r<t){let e=null,a=null,n=null,o=null;s.team1.forEach((t,r)=>{t.name===l[0].name&&(e=s.team1,a=r),t.name===l[1].name&&(n=s.team1,o=r)}),s.team2.forEach((t,r)=>{t.name===l[0].name&&(e=s.team2,a=r),t.name===l[1].name&&(n=s.team2,o=r)});const c=e[a];e[a]=n[o],n[o]=c,log("✅ Intra-match fix (Mixed Doubles - Men): Swapped "+l[0].name+" ↔ "+l[1].name),log("  Repeat partnerships reduced from "+t+" to "+r),i=!0}}}if(2===c.length&&!i){const e=JSON.parse(JSON.stringify(n)),r=e[o];let l=null,d=null,m=null,u=null;if(r.team1.forEach((e,t)=>{e.name===c[0].name&&(l=r.team1,d=t),e.name===c[1].name&&(m=r.team1,u=t)}),r.team2.forEach((e,t)=>{e.name===c[0].name&&(l=r.team2,d=t),e.name===c[1].name&&(m=r.team2,u=t)}),l&&m&&null!==d&&null!==u){const n=l[d];l[d]=m[u],m[u]=n;const r=checkForRepeatPartnerships(a,e).length;if(r<t){let e=null,a=null,n=null,o=null;s.team1.forEach((t,r)=>{t.name===c[0].name&&(e=s.team1,a=r),t.name===c[1].name&&(n=s.team1,o=r)}),s.team2.forEach((t,r)=>{t.name===c[0].name&&(e=s.team2,a=r),t.name===c[1].name&&(n=s.team2,o=r)});const l=e[a];e[a]=n[o],n[o]=l,log("✅ Intra-match fix (Mixed Doubles - Women): Swapped "+c[0].name+" ↔ "+c[1].name),log("  Repeat partnerships reduced from "+t+" to "+r),i=!0}}}}i||log("❌ Could not fix intra-match: "+t.players.join(" & "))});const o=checkForRepeatPartnerships(a,n);if(0===o.length)return log("🎉 Phase 1 resolved all repeat partnerships!"),n;if(r.length<=20){log("=== PHASE 2: INTER-MATCH FIXES ==="),log("Remaining repeats after Phase 1: "+o.length);const t=e.setFormatPreference;o.forEach((r,o)=>{const l=r.matchIndex,s=parseInt(r.team),c=n[l],d=1===s?c.team1:c.team2;1===s?c.team2:c.team1;log("Attempting inter-match fix for: "+r.players.join(" & ")+" (Match "+l+", Team "+s+")");let i=!1;const m=[];"Same-Sex"===t?m.push({name:"Same grade, same gender",criteria:(t,a)=>t.grade===a.grade&&getPlayerGender(t.name,e)===getPlayerGender(a.name,e)},{name:"Adjacent grade, same gender",criteria:(t,a)=>1===Math.abs(t.grade-a.grade)&&getPlayerGender(t.name,e)===getPlayerGender(a.name,e)},{name:"Same grade, cross gender",criteria:(t,a)=>t.grade===a.grade&&getPlayerGender(t.name,e)!==getPlayerGender(a.name,e)}):m.push({name:"Same grade, cross gender",criteria:(t,a)=>t.grade===a.grade&&getPlayerGender(t.name,e)!==getPlayerGender(a.name,e)},{name:"Adjacent grade, cross gender",criteria:(t,a)=>1===Math.abs(t.grade-a.grade)&&getPlayerGender(t.name,e)!==getPlayerGender(a.name,e)},{name:"Same grade, same gender",criteria:(t,a)=>t.grade===a.grade&&getPlayerGender(t.name,e)===getPlayerGender(a.name,e)});for(let e of m){if(i)break;log("  Trying inter-match strategy: "+e.name);for(let t=0;t<n.length&&!i;t++){if(t===l)continue;const r=n[t];for(let o=1;o<=2&&!i;o++){const c=1===o?r.team1:r.team2;for(let r=0;r<d.length&&!i;r++)for(let m=0;m<c.length&&!i;m++){const u=d[r],g=c[m];if(!e.criteria(u,g))continue;if(e.name.includes("Adjacent grade")&&!wouldCreateBalancedTeams(n,l,r,s,m,o,t))continue;const p=checkForRepeatPartnerships(a,n).length;d[r]=g,c[m]=u;const h=checkForRepeatPartnerships(a,n).length;if(h<p){log("✓ Inter-match fix ("+e.name+"): Swapped "+u.name+" ↔ "+g.name),log("  Repeat partnerships reduced from "+p+" to "+h),i=!0;break}d[r]=u,c[m]=g}}}}i||log("❌ Could not auto-fix: "+r.players.join(" & ")+" - leaving for manual adjustment")});const r=checkForRepeatPartnerships(a,n);r.length>0?(log("⚠ Could not resolve all repeat partnerships. Remaining: "+r.length),r.forEach(e=>{log("  - "+e.players.join(" & ")+" (previously in Set "+e.previousSet+")")})):log("🎉 Successfully resolved all repeat partnerships!")}else log("=== PHASE 2 SKIPPED DUE TO THRESHOLD ==="),log("Phase 1 intra-match fixes completed only"),log("Operator must manually resolve remaining repeat partnerships");return n}function autoFixRepeatOpponents(e,t){const a=parseInt(document.getElementById("setNumberSelector").value);if(a<=1)return t;log("=== AUTO-FIXING REPEAT OPPONENTS ===");const n=JSON.parse(JSON.stringify(t)),r=checkForRepeatOpponents(a,n);if(0===r.length)return log("No repeat opponents found - no auto-fixes needed"),n;log("Found "+r.length+" repeat opponent instances to attempt fixing"),r.forEach((t,r)=>{log(`\n--- Attempting to fix repeat opponent: ${t.player1} vs ${t.player2} (Match ${t.matchIndex}) ---`);let o=!1,l=0;for(let r=1;r<=5&&!o;r++){l++,log(`  Attempt ${r} for ${t.player1} vs ${t.player2}`);const s=[t.player1,t.player2];for(let t of s){if(o)break;let r=null,l=null,s=null;for(let e=0;e<n.length;e++){const a=n[e];for(let n=0;n<a.team1.length;n++)if(a.team1[n].name===t){r=e,l=1,s=n;break}if(null===r)for(let n=0;n<a.team2.length;n++)if(a.team2[n].name===t){r=e,l=2,s=n;break}if(null!==r)break}if(null===r){log(`    ❌ Could not find player ${t} in any match`);continue}const c=n[r],d=(1===l?c.team1:c.team2)[s],i=getPlayerGender(d.name,e),m=d.grade;for(let t=0;t<n.length&&!o;t++){if(t===r)continue;const c=n[t];for(let u=1;u<=2&&!o;u++){const g=1===u?c.team1:c.team2;for(let c=0;c<g.length&&!o;c++){const p=g[c],h=getPlayerGender(p.name,e),f=p.grade;if(i!==h||m!==f)continue;log(`    Testing swap: ${d.name} ↔ ${p.name} (both ${i}, grade ${m})`);const y={player1:{matchIndex:r,teamNum:l,positionIndex:s,playerData:JSON.parse(JSON.stringify(d))},player2:{matchIndex:t,teamNum:u,positionIndex:c,playerData:JSON.parse(JSON.stringify(p))}},S=JSON.parse(JSON.stringify(n)),b=S[y.player1.matchIndex],v=S[y.player2.matchIndex],M=1===y.player1.teamNum?b.team1:b.team2,x=1===y.player2.teamNum?v.team1:v.team2;M[y.player1.positionIndex]=y.player2.playerData,x[y.player2.positionIndex]=y.player1.playerData;const E=checkForRepeatPartnerships(a,S),I=checkForRepeatPartnerships(a,n);if(E.length>I.length){log("      ❌ Swap would create new repeat partnerships - rejected");continue}const w=checkForRepeatOpponents(a,S),C=checkForRepeatOpponents(a,n);if(w.length<C.length){const e=n[y.player1.matchIndex],t=n[y.player2.matchIndex],a=1===y.player1.teamNum?e.team1:e.team2,r=1===y.player2.teamNum?t.team1:t.team2;a[y.player1.positionIndex]=y.player2.playerData,r[y.player2.positionIndex]=y.player1.playerData,log(`      ✅ Successful swap: ${y.player1.playerData.name} ↔ ${y.player2.playerData.name}`),log(`      Repeat opponents reduced from ${C.length} to ${w.length}`),o=!0;break}log("      ❌ Swap did not reduce repeat opponents")}}}}}o||log(`  ❌ Could not fix repeat opponent after ${l} attempts: ${t.player1} vs ${t.player2}`)});const o=checkForRepeatOpponents(a,n);return o.length>0?log(`⚠️ Could not resolve all repeat opponents. Remaining: ${o.length}`):log("🎉 Successfully resolved all repeat opponents!"),n}function wouldCreateBalancedTeams(e,t,a,n,r,o,l=null){const s=null!==l?l:t,c=e[t],d=e[s],i=1===n?c.team1:c.team2,m=1===o?d.team1:d.team2,u=i[a],g=m[r];if(null===l)return!0;const p=[i[1-a],g],h=[m[1-r],u],f=1===n?c.team2:c.team1,y=1===o?d.team2:d.team1,S=isMatchupBalanced(p,f),b=isMatchupBalanced(h,y);return S&&b}function fixUncompetitiveMatches(e,t){log("=== FINAL COMPETITIVENESS OPTIMIZATION ===");const a=[];if(t.forEach((e,t)=>{isUncompetitive(e)&&a.push({index:t,match:e})}),log(`Found ${a.length} uncompetitive matches`),a.length<=1)return log("≤1 uncompetitive match found - leaving for operator to handle"),t;const n=Math.floor(a.length/2);log(`Processing ${n} pairs of uncompetitive matches`);for(let r=0;r<n;r++){const n=a[2*r],o=a[2*r+1];log(`\n--- Processing pair ${r+1}: Match ${n.index} & Match ${o.index} ---`),attemptCompetitivenessSwap(e,t,n.index,o.index)?log(`✓ Successful competitiveness swap between matches ${n.index} & ${o.index}`):log(`❌ No beneficial swap found between matches ${n.index} & ${o.index}`)}const r=t.filter(e=>isUncompetitive(e)).length;return log("\n=== COMPETITIVENESS OPTIMIZATION COMPLETE ==="),log(`Uncompetitive matches reduced from ${a.length} to ${r}`),t}function balanceIndividualMatches(e,t){log("=== FINAL INDIVIDUAL MATCH BALANCING ===");let a=0;return t.forEach((t,n)=>{const r=t.team1.reduce((e,t)=>e+t.grade,0),o=t.team2.reduce((e,t)=>e+t.grade,0),l=Math.abs(r-o);if(l<2)return;log(`Match ${n} needs balancing: ${r} vs ${o} (gap=${l})`);let s=null,c=l;for(let a=0;a<2;a++)for(let n=0;n<2;n++){if(1===a&&1===n)continue;const r=JSON.parse(JSON.stringify(t)),o=r.team1[a];if(r.team1[a]=r.team2[n],r.team2[n]=o,creates2Mvs2F(r,e))continue;const l=r.team1.reduce((e,t)=>e+t.grade,0),d=r.team2.reduce((e,t)=>e+t.grade,0),i=Math.abs(l-d);i<c&&(c=i,s={t1Player:a,t2Player:n})}if(s){const e=t.team1[s.t1Player];t.team1[s.t1Player]=t.team2[s.t2Player],t.team2[s.t2Player]=e,updateMatchFormat(t),log(`  ✓ Swapped players: Gap reduced from ${l} to ${c}`),a++}else log(`  No valid improvement found for match ${n}`)}),log(`=== INDIVIDUAL MATCH BALANCING COMPLETE: ${a} matches improved ===`),t}function isUncompetitive(e){const t=e.team1.map(e=>e.grade).sort((e,t)=>t-e),a=e.team2.map(e=>e.grade).sort((e,t)=>t-e),n=t[0]-t[1],r=a[0]-a[1],o=n>=2||r>=2;return o&&log(`Uncompetitive match: [${t.join(",")}] vs [${a.join(",")}] - gaps: ${n}, ${r}`),o}function attemptCompetitivenessSwap(e,t,a,n){const r=t[a],o=t[n],l=[...r.team1.map((e,t)=>({...e,match:a,team:1,position:t})),...r.team2.map((e,t)=>({...e,match:a,team:2,position:t}))],s=[...o.team1.map((e,t)=>({...e,match:n,team:1,position:t})),...o.team2.map((e,t)=>({...e,match:n,team:2,position:t}))];l.sort((e,t)=>e.grade-t.grade),s.sort((e,t)=>t.grade-e.grade);const c=l.slice(0,2),d=s.slice(0,2);log("Swapping (no competitiveness check needed):"),log(`  Weakest from Match ${a}: ${c.map(e=>`${e.name}(${e.grade})`).join(", ")}`),log(`  Strongest from Match ${n}: ${d.map(e=>`${e.name}(${e.grade})`).join(", ")}`);const i=JSON.parse(JSON.stringify(r)),m=JSON.parse(JSON.stringify(o)),u=c[0],g=d[0],p=1===u.team?i.team1:i.team2,h=1===g.team?m.team1:m.team2,f={...p[u.position]};p[u.position]={...h[g.position]},h[g.position]=f;const y=c[1],S=d[1],b=1===y.team?i.team1:i.team2,v=1===S.team?m.team1:m.team2,M={...b[y.position]};return b[y.position]={...v[S.position]},v[S.position]=M,creates2Mvs2F(i,e)||creates2Mvs2F(m,e)?(log("  ❌ Swap would create 2M vs 2F - rejected"),!1):(t[a]=i,t[n]=m,updateMatchFormat(t[a]),updateMatchFormat(t[n]),log("  ✓ Swap completed"),!0)}function creates2Mvs2F(e,t){const a=e.team1.filter(e=>"M"===getPlayerGender(e.name,t)).length,n=e.team1.filter(e=>"F"===getPlayerGender(e.name,t)).length,r=e.team2.filter(e=>"M"===getPlayerGender(e.name,t)).length,o=e.team2.filter(e=>"F"===getPlayerGender(e.name,t)).length;return 2===a&&0===n&&0===r&&2===o||0===a&&2===n&&2===r&&0===o}function isMatchupBalanced(e,t){const a=e.map(e=>e.grade).sort((e,t)=>t-e),n=t.map(e=>e.grade).sort((e,t)=>t-e),r=a[0],o=a[1],l=n[0],s=n[1];if(Math.abs(r-l)>1)return!1;const c=r+o,d=l+s,i=a.includes(5),m=n.includes(5);return i&&!m?4===l&&4===s:m&&!i?4===r&&4===o:Math.abs(c-d)<=2}function getPlayerGender(e,t){let a=t.sortedMen?t.sortedMen.find(t=>t.name===e):null,n=t.sortedWomen?t.sortedWomen.find(t=>t.name===e):null;return!a&&t.availableMen&&(a=t.availableMen.find(t=>t.name===e)),!n&&t.availableWomen&&(n=t.availableWomen.find(t=>t.name===e)),a?"M":n?"F":null}function testSwapReducesConflicts(e,t,a,n,r,o,l,s){const c=JSON.parse(JSON.stringify(e)),d=c[t],i=c[r],m=1===a?d.team1:d.team2,u=1===o?i.team1:i.team2,g=checkForRepeatPartnerships(s,e).length,p=m[n];m[n]=u[l],u[l]=p;return checkForRepeatPartnerships(s,c).length<g}function displayResults(e,t){currentSetNumber=parseInt(document.getElementById("setNumberSelector").value);const a=[...manualMatches,...t];allSetsData[currentSetNumber]={data:JSON.parse(JSON.stringify(e)),matches:JSON.parse(JSON.stringify(a)),satOffPlayers:[]};const n=playerRows.filter(e=>e.name&&e.so).map(e=>e.name);n.length>0?(allSetsData[currentSetNumber].satOffPlayers=[...n],log("Stored "+allSetsData[currentSetNumber].satOffPlayers.length+" sat-off players for Set "+currentSetNumber)):log("No players sat off for Set "+currentSetNumber+" (evenly divisible by 4)"),log("Set "+currentSetNumber+" data saved to memory");const r=document.getElementById("matches"),o=document.getElementById("matchResults"),l=checkForRepeatPartnerships(currentSetNumber,a),s=checkForRepeatOpponents(currentSetNumber,a);let c='<div class="success">✓ '+a.length+" Matches Generated for Set "+document.getElementById("setNumberSelector").value;manualMatches.length>0&&(c+=" ("+manualMatches.length+" manual + "+t.length+" automatic)"),c+="</div>",c+='<p style="color: #666; font-style: italic;">Drag players or courts to swap them</p>';const d=t=>{let a=e.availableMen?e.availableMen.find(e=>e.name===t):null,n=e.availableWomen?e.availableWomen.find(e=>e.name===t):null;!a&&e.sortedMen&&(a=e.sortedMen.find(e=>e.name===t)),!n&&e.sortedWomen&&(n=e.sortedWomen.find(e=>e.name===t));const r=a||n;return r&&r.nhc},i=t=>{let a=e.availableMen?e.availableMen.find(e=>e.name===t):null,n=e.availableWomen?e.availableWomen.find(e=>e.name===t):null;!a&&e.sortedMen&&(a=e.sortedMen.find(e=>e.name===t)),!n&&e.sortedWomen&&(n=e.sortedWomen.find(e=>e.name===t));const r=a||n;return r&&r.nxd};c+='<table style="width: 100%; border-collapse: collapse; margin: 20px 0;">',c+='<tr style="background: #f8f9fa; border-bottom: 2px solid #333;">',c+='<th style="padding: 12px; text-align: center; font-weight: bold; border: 1px solid #ddd; width: 40px;">Court #</th>',c+='<th style="padding: 12px; text-align: center; font-weight: bold; border: 1px solid #ddd; width: 45%;">Team 1</th>',c+='<th style="padding: 12px; text-align: center; font-weight: bold; border: 1px solid #ddd; width: 45%;">Team 2</th>',c+="</tr>",a.forEach((e,t)=>{const a=e.isManual||!1;c+="<tr "+(a?'style="background: #fff8dc;"':"")+">";c+='<td style="padding: 8px; text-align: center; border: 1px solid #ddd; vertical-align: middle;">',c+='<div class="'+(a?"court-box manual":"court-box")+'" draggable="true" data-type="court" data-match="'+t+'" data-court="'+e.court+'" ',c+='style="display: inline-block; background: white; color: black; border: 2px solid #333; ',c+='padding: 6px 10px; border-radius: 5px; font-weight: bold; cursor: move; user-select: none;">',c+=e.court,c+="</div></td>",c+='<td style="padding: 8px; border: 1px solid #ddd; vertical-align: middle;">',e.team1.forEach((e,n)=>{const r=d(e.name)?" nhc":"",o=i(e.name)?" nxd":"",m=a?" manual-match":"",u=l.some(a=>a.matchIndex===t&&1===a.team&&a.players.includes(e.name)),g=s.some(a=>a.matchIndex===t&&(a.player1===e.name||a.player2===e.name));c+='<span class="player-box'+r+o+(u?" repeat-partner":"")+(g?" repeat-opponent":"")+m+'" draggable="true" ',c+='data-type="player" data-match="'+t+'" data-team="1" data-player="'+n+'" ',c+='data-name="'+e.name+'" data-grade="'+e.grade+'" ',c+='style="display: inline-block; background: white; border: 2px solid #ddd; padding: 4px 8px; margin: 2px; ',c+="border-radius: 5px; cursor: move; user-select: none; transition: all 0.2s ease;",d(e.name)&&i(e.name)?c+=" font-weight: bold;":d(e.name)?c+=" background-color: #add8e6; font-weight: bold;":i(e.name)&&(c+=" background-color: #ffffe0; font-weight: bold;"),u&&(c+=" background-color: #ff9800; border: 2px solid #f57c00; font-weight: bold;"),a&&(c+=" background-color: #fff8dc; border: 2px solid #ffc107;"),c+='">',c+=e.name+" ("+translateGrade(e.grade)+")",c+="</span>",0===n&&(c+=", ")}),c+="</td>",c+='<td style="padding: 8px; border: 1px solid #ddd; vertical-align: middle;">',e.team2.forEach((e,n)=>{const r=d(e.name)?" nhc":"",o=i(e.name)?" nxd":"",m=a?" manual-match":"",u=l.some(a=>a.matchIndex===t&&2===a.team&&a.players.includes(e.name)),g=s.some(a=>a.matchIndex===t&&(a.player1===e.name||a.player2===e.name));c+='<span class="player-box'+r+o+(u?" repeat-partner":"")+(g?" repeat-opponent":"")+m+'" draggable="true" ',c+='data-type="player" data-match="'+t+'" data-team="2" data-player="'+n+'" ',c+='data-name="'+e.name+'" data-grade="'+e.grade+'" ',c+='style="display: inline-block; background: white; border: 2px solid #ddd; padding: 4px 8px; margin: 2px; ',c+="border-radius: 5px; cursor: move; user-select: none; transition: all 0.2s ease;",d(e.name)&&i(e.name)?c+=" font-weight: bold;":d(e.name)?c+=" background-color: #add8e6; font-weight: bold;":i(e.name)&&(c+=" background-color: #ffffe0; font-weight: bold;"),u&&(c+=" background-color: #ff9800; border: 2px solid #f57c00; font-weight: bold;"),a&&(c+=" background-color: #fff8dc; border: 2px solid #ffc107;"),c+='">',c+=e.name+" ("+translateGrade(e.grade)+")",c+="</span>",0===n&&(c+=", ")}),c+="</td>",c+="</tr>"}),c+="</table>",o.innerHTML=c,r.style.display="block",currentMatches=a,setTimeout(()=>initializeDragAndDrop(),100),saveDataToStorage()}function initializeDragAndDrop(){log("Initializing drag and drop");let e=null,t=null;const a=document.getElementById("matchResults");if(!a)return;const n=a.cloneNode(!0);a.parentNode.replaceChild(n,a),n.addEventListener("dragstart",function(a){"true"===a.target.getAttribute("draggable")&&(e=a.target,t={type:a.target.dataset.type,match:parseInt(a.target.dataset.match),team:a.target.dataset.team,player:parseInt(a.target.dataset.player),court:a.target.dataset.court,name:a.target.dataset.name,grade:a.target.dataset.grade},a.target.classList.add("dragging"),log("Dragging: "+(t.name||t.court)))}),n.addEventListener("dragend",function(e){"true"===e.target.getAttribute("draggable")&&(e.target.classList.remove("dragging"),n.querySelectorAll(".drag-over").forEach(e=>e.classList.remove("drag-over")))}),n.addEventListener("dragover",function(e){e.preventDefault()}),n.addEventListener("dragenter",function(e){(e.target.classList.contains("player-box")||e.target.classList.contains("court-box"))&&e.target.classList.add("drag-over")}),n.addEventListener("dragleave",function(e){(e.target.classList.contains("player-box")||e.target.classList.contains("court-box"))&&e.target.classList.remove("drag-over")}),n.addEventListener("drop",function(a){if(a.preventDefault(),!e||!t)return;const n=a.target;if(n!==e){if(n.classList.remove("drag-over"),"player"===t.type&&n.classList.contains("player-box")){const e={match:parseInt(n.dataset.match),team:n.dataset.team,player:parseInt(n.dataset.player),name:n.dataset.name};log("Swapping players: "+t.name+" ↔ "+e.name),swapPlayers(t,e),allSetsData[currentSetNumber]&&(allSetsData[currentSetNumber].matches=JSON.parse(JSON.stringify(currentMatches))),refreshDisplay()}else if("court"===t.type&&n.classList.contains("court-box")){const e=parseInt(n.dataset.match),a=n.dataset.court;log("Swapping courts: "+t.court+" ↔ "+a),swapCourts(t.match,e),allSetsData[currentSetNumber]&&(allSetsData[currentSetNumber].matches=JSON.parse(JSON.stringify(currentMatches))),refreshDisplay()}e=null,t=null}})}function swapPlayers(e,t){const a=currentMatches[e.match],n=currentMatches[t.match],r="1"===e.team?a.team1:a.team2,o="1"===t.team?n.team1:n.team2,l={...r[e.player]};r[e.player]={...o[t.player]},o[t.player]=l,updateMatchFormat(currentMatches[e.match]),updateMatchFormat(currentMatches[t.match])}function updateMatchFormat(e){if(!e||!e.team1||!e.team2)return;console.log("currentData:",currentData),console.log("sortedMen:",currentData.sortedMen),console.log("sortedWomen:",currentData.sortedWomen),console.log("First player from team1:",e.team1[0]);const t=e.team1.filter(e=>"M"===getPlayerGender(e.name,currentData)).length,a=e.team1.filter(e=>"F"===getPlayerGender(e.name,currentData)).length,n=e.team2.filter(e=>"M"===getPlayerGender(e.name,currentData)).length,r=e.team2.filter(e=>"F"===getPlayerGender(e.name,currentData)).length;e.format=1===t&&1===a&&1===n&&1===r?"Mixed Doubles":2===t&&2===n?"Same-Sex Doubles (Men)":2===a&&2===r?"Same-Sex Doubles (Women)":"Mixed Gender"}function getPlayerGender(e,t){let a=t.sortedMen?t.sortedMen.find(t=>t.name===e):null,n=t.sortedWomen?t.sortedWomen.find(t=>t.name===e):null;return!a&&t.availableMen&&(a=t.availableMen.find(t=>t.name===e)),!n&&t.availableWomen&&(n=t.availableWomen.find(t=>t.name===e)),a?"M":n?"F":null}function swapCourts(e,t){const a=currentMatches[e].court;currentMatches[e].court=currentMatches[t].court,currentMatches[t].court=a}function refreshDisplay(){displayResults(currentData,currentMatches.filter(e=>!e.isManual))}function printMatchSheet(e,t){try{const a=window.open("","_blank","width=800,height=600"),n=playerRows.filter(e=>e.name&&e.so).map(e=>e.name);let r=`\n<!DOCTYPE html>\n<html>\n<head>\n  <meta charset="UTF-8">\n  <title>Tennis Match Sheet - Set ${document.getElementById("setNumberSelector").value}</title>\n  <style>\n    body { \n      font-family: Arial, sans-serif; \n      margin: 20px; \n      background: white; \n      color: black;\n      line-height: 1.3;\n    }\n    .header { \n      text-align: center; \n      margin-bottom: 30px; \n      border-bottom: 2px solid black; \n      padding-bottom: 15px;\n    }\n    .header h1 { \n      margin: 0; \n      font-size: 24px; \n      font-weight: bold;\n    }\n    .header-info { \n      font-size: 16px; \n      margin: 8px 0;\n    }\n    .sat-off-section { \n      background: #f0f0f0; \n      border: 2px solid black; \n      padding: 15px; \n      margin: 20px 0; \n      border-radius: 5px;\n    }\n    .sat-off-title { \n      font-size: 18px; \n      font-weight: bold; \n      margin-bottom: 10px;\n    }\n    .sat-off-list { \n      font-size: 16px; \n      font-weight: bold;\n    }\n    .match-table {\n      width: 100%;\n      border-collapse: collapse;\n      margin: 20px 0;\n    }\n    .match-table th {\n      background: #f8f9fa;\n      border: 2px solid #333;\n      padding: 12px;\n      text-align: center;\n      font-weight: bold;\n      font-size: 16px;\n    }\n    .match-table td {\n      border: 1px solid #333;\n      padding: 8px;\n      vertical-align: middle;\n    }\n    .match-table tr.manual {\n      background: #fff8dc;\n    }\n    .court-number {\n      background: white;\n      color: black;\n      border: 2px solid #333;\n      padding: 6px 10px;\n      border-radius: 5px;\n      font-weight: bold;\n      display: inline-block;\n    }\n    .team-cell {\n      font-size: 18px;\n    }\n    .match-table th:nth-child(1) {\n      width: 40px;\n    }\n    .match-table th:nth-child(2), .match-table th:nth-child(3) {\n      width: 45%;\n    }\n    @media print {\n      body { margin: 15px; }\n      .match-table { page-break-inside: auto; }\n    }\n  </style>\n</head>\n<body>\n  <div class="header">\n    <h1>Tennis Match Sheet</h1>\n    <div class="header-info">Date: ${(new Date).toLocaleDateString()}</div>\n    <div class="header-info">Set Number: ${document.getElementById("setNumberSelector").value}</div>\n    <div class="header-info">Format: ${e.setFormatPreference}</div>\n  </div>\n`;n.length>0&&(r+=`\n  <div class="sat-off-section">\n    <div class="sat-off-title">Players Sitting Off This Set:</div>\n    <div class="sat-off-list">${n.join(", ")}</div>\n  </div>\n`),r+='\n  <table class="match-table">\n    <tr>\n      <th>Court #</th>\n      <th>Team 1</th>\n      <th>Team 2</th>\n    </tr>\n',t.forEach((e,t)=>{const a=e.team1.map(e=>`${e.name} (${translateGrade(e.grade)})`).join(", "),n=e.team2.map(e=>`${e.name} (${translateGrade(e.grade)})`).join(", "),o=e.isManual||!1;r+=`\n    <tr${o?' class="manual"':""}>\n      <td style="text-align: center;">\n        <div class="court-number">${e.court}</div>\n      </td>\n      <td class="team-cell">${a}</td>\n      <td class="team-cell">${n}</td>\n    </tr>\n`}),r+="\n  </table>\n</body>\n</html>",a.document.write(r),a.document.close(),setTimeout(()=>{a.focus(),a.print()},250),log("Print dialog opened for match sheet")}catch(e){alert("Error creating print sheet: "+e.message),log("Error creating print sheet: "+e.message)}}function downloadResults(e,t){try{const a=XLSX.utils.book_new(),n=Object.keys(allSetsData).sort((e,t)=>parseInt(e)-parseInt(t));0===n.length?createSingleSetSheet(a,e,t,currentSetNumber):n.forEach(e=>{const t=allSetsData[e];createSingleSetSheet(a,t.data,t.matches,e,t.satOffPlayers)});const r=(new Date).toISOString().slice(0,19).replace(/:/g,"-"),o=`Tennis_Matches_${n.length||1}_Sets_${r}.xlsx`;XLSX.writeFile(a,o),log("Excel file downloaded: "+o+" with "+(n.length||1)+" sheets")}catch(e){alert("Error creating Excel file: "+e.message),log("Error creating Excel file: "+e.message)}}function createSingleSetSheet(e,t,a,n,r=[]){const o=[];o.push(["Date",(new Date).toISOString().split("T")[0]]),o.push(["Set Number","Set "+n]),o.push(["Set Format Preference",t.setFormatPreference]),o.push([]),o.push(["Court","Team 1","Team 2","Match Format","Match Type","Sat Off Players","","Total Men Players","Grade","NHC","Resting","PSO","","Total Women Players","Grade","NHC","Resting","PSO"]);const l=Math.max(a.length,t.availableMen.length,t.availableWomen.length);for(let e=0;e<l;e++){const n=["","","","","","",""];if(e<a.length){const t=a[e],o=t.team1.map(e=>`${e.name} (${translateGrade(e.grade)})`).join(", "),l=t.team2.map(e=>`${e.name} (${translateGrade(e.grade)})`).join(", "),s=e<r.length?r[e]:"",c=t.isManual?"Manual":"Auto";n[0]=t.court,n[1]=o,n[2]=l,n[3]=t.format,n[4]=c,n[5]=s,n[6]=""}if(e<t.availableMen.length){const a=t.availableMen[e];n[7]=a.name,n[8]=a.grade,n[9]=a.nhc?"y":"",n[10]=a.resting?"y":"",n[11]=a.pso?"y":""}if(n[12]="",e<t.availableWomen.length){const a=t.availableWomen[e];n[13]=a.name,n[14]=a.grade,n[15]=a.nhc?"y":"",n[16]=a.resting?"y":"",n[17]=a.pso?"y":""}o.push(n)}const s=XLSX.utils.aoa_to_sheet(o);s["!cols"]=[{wch:20},{wch:50},{wch:50},{wch:25},{wch:10},{wch:20},{wch:3},{wch:20},{wch:8},{wch:6},{wch:8},{wch:6},{wch:3},{wch:20},{wch:8},{wch:6},{wch:8},{wch:6}],XLSX.utils.book_append_sheet(e,s,"Set "+n+" Summary")}function parseGrade(e){return e?reverseTranslateGrade(e.toString().trim()):null}function parseBoolean(e){if(!e)return!1;if("boolean"==typeof e)return e;if("string"==typeof e){const t=e.toString().trim().toLowerCase();return"y"===t||"yes"===t||"true"===t||"1"===t}return"number"==typeof e&&1===e}function refreshPlayerTable(){document.getElementById("playerTableBody").innerHTML="",playerRows.forEach((e,t)=>{addPlayerRowAtIndex(t),e.name&&(document.querySelector(`[data-row="${t}"]`).value=e.name,document.getElementById(`grade-${t}`).value=e.grade,document.getElementById(`gender-${t}`).value=e.gender,document.getElementById(`nhc-${t}`).checked=e.nhc,document.getElementById(`nxd-${t}`).checked=e.nxd,document.getElementById(`resting-${t}`).checked=e.resting,document.getElementById(`pso-${t}`).checked=e.pso,document.getElementById(`so-${t}`).checked=e.so,e.name&&e.grade&&e.gender&&(document.querySelector(`[data-row="${t}"].delete-player-btn`).style.display="block"))})}availableCourtsDiv.addEventListener("dragover",e=>{e.preventDefault(),availableCourtsDiv.classList.add("drag-over")}),availableCourtsDiv.addEventListener("dragleave",e=>{availableCourtsDiv.classList.remove("drag-over")}),availableCourtsDiv.addEventListener("drop",e=>{e.preventDefault(),availableCourtsDiv.classList.remove("drag-over");const t=e.dataTransfer.getData("text/plain");if(t&&!availableCourts.includes(t)){availableCourts.push(t),updateAvailableCourtsDisplay();const e=document.querySelector(`[data-court="${t}"]`);e&&"courtPool"===e.parentElement.id&&e.remove()}}),document.getElementById("clearCourts").addEventListener("click",()=>{availableCourts=[],updateAvailableCourtsDisplay(),initializeCourts()}),document.getElementById("addMoreRows").addEventListener("click",()=>{for(let e=0;e<10;e++)addPlayerRow()}),document.getElementById("updateMasterList").addEventListener("click",generateUpdatedMasterList),document.getElementById("setNumberSelector").addEventListener("change",function(){const e=parseInt(this.value),t=e-1;if(e>1&&allSetsData[t]){const a=allSetsData[t].satOffPlayers||[];playerRows.forEach((e,t)=>{if(a.includes(e.name)){e.so=!1,e.pso=!0;const a=document.getElementById(`so-${t}`),n=document.getElementById(`pso-${t}`);a&&(a.checked=!1),n&&(n.checked=!0)}}),console.log(`Moved ${a.length} players from SO to PSO for Set ${e}`)}playerRows.forEach((e,t)=>{if(!e.pso){e.so=!1;const a=document.getElementById(`so-${t}`);a&&(a.checked=!1)}}),updateSitOffCalculation(),updateProceedButton(),document.getElementById("manualMatchSection").style.display="none",document.getElementById("matches").style.display="none",document.getElementById("generateMatches").textContent=`Generate Remaining Matches for Set ${e}`}),document.getElementById("proceedToMatches").addEventListener("click",()=>{processPlayersAndProceed(),setTimeout(()=>{scrollToElement("manualMatchSection")},100)}),document.getElementById("toggleManualSetup").addEventListener("click",function(){const e=document.getElementById("manualSetupPanel"),t="none"!==e.style.display;e.style.display=t?"none":"block",this.textContent=t?"Setup Manual Match":"Hide Manual Setup"}),document.getElementById("addManualMatch").addEventListener("click",addManualMatch),document.getElementById("clearManualSetup").addEventListener("click",clearManualSetup),document.getElementById("generateMatches").addEventListener("click",()=>{processMatchesWithManualSetup(),setTimeout(()=>{scrollToElement("matches")},500)}),document.addEventListener("DOMContentLoaded",()=>{initializeCourts(),loadMemberListOnStartup(),setTimeout(()=>{loadDataFromStorage()},500)}),document.getElementById("downloadBtn").onclick=function(){currentData&&currentMatches?downloadResults(currentData,currentMatches):alert("No matches to download. Please generate matches first.")},document.getElementById("printBtn").onclick=function(){currentData&&currentMatches?printMatchSheet(currentData,currentMatches):alert("No matches to print. Please generate matches first.")},document.getElementById("importExcelBtn").addEventListener("click",()=>{document.getElementById("excelFileInput").click()}),document.getElementById("excelFileInput").addEventListener("change",async e=>{const t=e.target.files[0];if(t){try{const e=await t.arrayBuffer(),a=XLSX.read(e,{type:"array"});if(!a.SheetNames.includes("Today's Players"))return void alert('Error: Excel file must contain a sheet named "Today\'s Players"');if(!a.SheetNames.includes("Available Courts"))return void alert('Error: Excel file must contain a sheet named "Available Courts"');const n=a.Sheets["Today's Players"],r=XLSX.utils.sheet_to_json(n,{header:1}),o=a.Sheets["Available Courts"],l=XLSX.utils.sheet_to_json(o,{header:1}),s=[];for(let e=1;e<r.length;e++){const t=r[e];if(t&&0!==t.length){if(t[0]&&"string"==typeof t[0]&&""!==t[0].trim()){const e=parseGrade(t[1]);null!==e&&s.push({name:t[0].trim(),grade:e,gender:"M",nhc:parseBoolean(t[2]),nxd:parseBoolean(t[3]),resting:!1,pso:!1,so:!1})}if(t[5]&&"string"==typeof t[5]&&""!==t[5].trim()){const e=parseGrade(t[6]);null!==e&&s.push({name:t[5].trim(),grade:e,gender:"F",nhc:parseBoolean(t[7]),nxd:parseBoolean(t[8]),resting:!1,pso:!1,so:!1})}}}const c=[];console.log("Courts sheet data:",l);for(let e=1;e<l.length;e++){const t=l[e];if(console.log(`Row ${e}:`,t),!t||t.length<2){console.log(`Skipping row ${e} - insufficient data`);continue}const a=parseInt(t[0]),n=t[1];console.log(`Row ${e}: priority=${a}, courtName="${n}"`);const r=!isNaN(a)&&a>0,o=null!=n&&""!==n.toString().trim();if(r&&o){const e={priority:a,court:n.toString().trim()};console.log("Adding court:",e),c.push(e)}else console.log(`Skipping row ${e} - invalid data: priority=${a}, courtName="${n}"`)}for(console.log("Final imported courts:",c),c.sort((e,t)=>e.priority-t.priority),playerRows=[],availableCourts=[],playerRows=[...s];playerRows.length<10;)playerRows.push({name:"",grade:"",gender:"",nhc:!1,nxd:!1,resting:!1,pso:!1,so:!1});availableCourts=c.map(e=>e.court),refreshPlayerTable(),updateAvailableCourtsDisplay(),initializeCourts(),availableCourts.forEach(e=>{const t=document.querySelector(`[data-court="${e}"]`);t&&"courtPool"===t.parentElement.id&&t.remove()}),updateSitOffCalculation(),updateProceedButton(),document.getElementById("memberLoadStatus").innerHTML=`<div class="success">✓ Imported ${s.length} players and ${c.length} courts from Excel file</div>`,saveDataToStorage()}catch(e){alert(`Error reading Excel file: ${e.message}`),console.error("Excel import error:",e)}e.target.value=""}})</script></body></html>