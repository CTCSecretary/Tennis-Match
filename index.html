<!DOCTYPE html><html><head><meta charset=UTF-8><title>Social Tennis Match Maker</title><script src=https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js></script><script src="Member Master List.js"></script><style>body{font-family:Arial,sans-serif;padding:20px;background:#f4f4f4}.logo-section{text-align:center;margin-bottom:20px;padding:15px;background:#fff;box-shadow:0 2px 4px rgba(0,0,0,.1)}.step-header{background:linear-gradient(135deg,#1e40af 0,#3b82f6 100%);color:#fff;font-size:24px;font-weight:700;padding:20px 30px;margin:-15px -15px 20px -15px;border-radius:8px 8px 0 0;text-align:left;box-shadow:0 2px 8px rgba(30,64,175,.3)}.logo{max-height:80px;max-width:100%;height:auto;border-radius:8px;transition:all .3s ease}.logo:hover{transform:scale(1.02);box-shadow:0 4px 12px rgba(0,0,0,.15)}h1{text-align:center;color:#333}.section{background:#fff;margin:15px 0;padding:15px;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,.1)}.error{color:red;font-weight:700}.success{color:green;font-weight:700}.warning{color:orange;font-weight:700}button{padding:10px 20px;margin:10px 5px;border:none;border-radius:5px;cursor:pointer}.primary{background:#007acc;color:#fff}.secondary{background:#6c757d;color:#fff}.danger{background:#dc3545;color:#fff}.court-pool{display:grid;grid-template-columns:repeat(auto-fill,minmax(80px,1fr));gap:8px;margin:15px 0;padding:15px;border:2px dashed #ddd;border-radius:8px;background:#fafafa;min-height:120px}.court-item{background:#007acc;color:#fff;padding:10px;text-align:center;border-radius:5px;cursor:move;user-select:none;font-weight:700;transition:all .2s}.court-item.grass-court{background:#28a745!important}.court-item.grass-court:hover{background:#1e7e34!important}.court-item.hard-court{background:#007acc!important}.court-item.hard-court:hover{background:#005a99!important}.available-courts .court-item.grass-court{background:#28a745!important}.available-courts .court-item.grass-court:hover{background:#1e7e34!important}.available-courts .court-item.hard-court{background:#007acc!important}.available-courts .court-item.hard-court:hover{background:#005a99!important}.court-item:hover{background:#005a99;transform:scale(1.05)}.court-item:hover{background:#005a99;transform:scale(1.05)}.court-item.dragging{opacity:.5}.available-courts{min-height:80px;padding:15px;border:2px dashed #28a745;border-radius:8px;background:#f8fff8;margin:15px 0}.available-courts.drag-over{border-color:#007acc;background:#e3f2fd}.available-courts .court-item{background:#28a745;margin:5px;display:inline-block}.available-courts .court-item:hover{background:#1e7e34}.player-table{width:100%;border-collapse:collapse;margin:15px 0}.player-table td,.player-table th{border:1px solid #ddd;padding:8px;text-align:left}.player-table th{background:#f8f9fa;font-weight:700}.player-table tr:nth-child(2n){background:#f9f9f9}.player-table tr:hover{background:#e8f4fd}.name-input{width:100%;padding:5px;border:1px solid #ddd;border-radius:3px;font-size:16px}.name-input:focus{border-color:#007acc;outline:3px solid #007acc!important;outline-offset:2px;background-color:#fffbf0!important}.autocomplete-suggestions{position:absolute;background:#fff;border:1px solid #ddd;border-top:none;max-height:200px;overflow-y:auto;z-index:1000;width:100%}.autocomplete-suggestion{padding:8px;cursor:pointer;border-bottom:1px solid #eee;font-size:16px}.autocomplete-suggestion:hover{background:#e8f4fd}.autocomplete-suggestion.selected{background:#007acc;color:#fff}.checkbox-cell{text-align:center;width:60px}.status-checkbox{width:18px;height:18px;cursor:pointer}.gender-select,.grade-select{width:100%;padding:4px;border:1px solid #ddd;border-radius:3px;font-size:14px;background:#fff}.gender-select:focus,.grade-select:focus{border-color:#007acc;outline:3px solid #007acc!important;outline-offset:2px;background-color:#fffbf0!important}.format-buttons,.set-buttons{display:flex;gap:8px;margin:15px 0}.format-btn,.set-btn{flex:1;padding:12px 20px;border:2px solid #ddd;background:#fff;border-radius:8px;cursor:pointer;text-align:center;font-size:16px;font-weight:500;transition:all .3s ease;color:#666}.format-btn:hover,.set-btn:hover{border-color:#007acc;background:#f8f9fa}.format-btn.active{background:#007acc;border-color:#005a99;color:#fff;font-weight:700}.set-btn.active{background:#007acc;border-color:#005a99;color:#fff;font-weight:700}.format-section,.set-section{margin-bottom:20px}.format-label,.set-label{display:flex;align-items:center;font-weight:700;margin-bottom:10px;font-size:16px;color:#666}.sit-off-calculator{background:#fff3cd;border:1px solid #ffc107;padding:15px;border-radius:5px;margin:15px 0;text-align:center;font-size:18px;font-weight:700}.sit-off-good{background:#d4edda;border-color:#28a745;color:#155724}.sit-off-bad{background:#f8d7da;border-color:#dc3545;color:#721c24}.manual-match-setup{border:2px solid #ffc107;background:#fff8dc;border-radius:8px;padding:15px;margin:15px 0}.manual-match-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}.manual-match-title{font-size:18px;font-weight:700;color:#856404}.manual-matches-list{margin:15px 0}.manual-match-item{background:#fff;border:1px solid #ffc107;border-radius:5px;padding:12px;margin:8px 0;display:flex;justify-content:space-between;align-items:center}.manual-match-details{flex:1}.manual-match-court{font-weight:700;color:#007acc;margin-bottom:5px}.manual-match-teams{font-size:14px;color:#333}.manual-player-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin:15px 0}.manual-player-item{background:#fff;border:1px solid #ddd;border-radius:5px;padding:8px;cursor:pointer;transition:all .2s;user-select:none}.manual-player-item:hover{border-color:#007acc;background:#f8f9fa}.manual-player-item.selected{background:#007acc;color:#fff;border-color:#0056b3}.manual-player-item.excluded{background:#f8f9f9;color:#6c757d;border-color:#dee2e6;cursor:not-allowed}.team-formation{display:grid;grid-template-columns:1fr auto 1fr;gap:20px;margin:20px 0;align-items:center}.team-slot{border:2px dashed #ddd;border-radius:8px;padding:15px;min-height:100px;background:#fafafa}.team-slot.has-players{border-color:#007acc;background:#e3f2fd}.team-slot-title{font-weight:700;margin-bottom:10px;text-align:center}.team-player{background:#fff;border:1px solid #007acc;border-radius:4px;padding:5px 8px;margin:3px 0;font-size:14px}.vs-divider{font-size:24px;font-weight:700;text-align:center;color:#666}.court-selector{margin:15px 0}.court-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(80px,1fr));gap:8px;margin:10px 0}.court-option{background:#fff;border:2px solid #ddd;border-radius:5px;padding:10px;text-align:center;cursor:pointer;transition:all .2s}.court-option:hover{border-color:#007acc}.court-option.selected{background:#007acc;color:#fff;border-color:#0056b3}.court-option.excluded{background:#f8f9f9;color:#6c757d;border-color:#dee2e6;cursor:not-allowed}.match-container{background:#f9f9f9;border:1px solid #ddd;padding:15px;margin:8px 0;border-radius:6px;border-left:4px solid #007acc}.match-container.manual-match{border-left:4px solid #666;background:#e6e6e6}.court-box{display:inline-block;background:#007acc;color:#fff;padding:8px 12px;border-radius:5px;margin-bottom:10px;font-weight:700;cursor:move;user-select:none}.court-box.manual{background:#ffc107;color:#856404}.court-box:hover{background:#005a99}.court-box.manual:hover{background:#e0a800}.court-box.dragging{opacity:.5}.court-box.drag-over{background:#28a745}.teams-row{display:flex;gap:20px;align-items:flex-start}.team-column{flex:1;min-height:80px}.team-header{font-weight:700;margin-bottom:8px;text-align:center;padding:5px;background:#e9e9e9;border-radius:3px}.player-box{background:#fff;border:2px solid #ddd;padding:8px;margin:4px 0;border-radius:5px;cursor:move;user-select:none;text-align:center;transition:all .2s ease}.player-box.grade-gap{background:repeating-linear-gradient(45deg,#fff 0,#fff 6px,#ff8c42 6px,#ff8c42 7px)!important;border:2px solid #ff8c42!important;font-weight:700}.player-box:hover{border-color:#007acc;box-shadow:0 2px 5px rgba(0,0,0,.2)}.player-box.dragging{opacity:.5;transform:rotate(2deg)}.player-box.nhc{background-color:#add8e6;font-weight:700}.player-box.nxd{background-color:#ffffe0;font-weight:700}.player-box.nhc.nxd{background:linear-gradient(90deg,#add8e6 0,#ffffe0 100%)!important;font-weight:700}.player-box.repeat-partner{background-color:#ff9800;border:2px solid #f57c00;font-weight:700}.player-box.repeat-opponent{border:3px dashed #dc3545!important;box-shadow:0 0 5px rgba(220,53,69,.5)}.playing-down-arrow{color:#c00;font-weight:700;margin-right:2px}.player-box.manual-match{background-color:#fff8dc;border:2px solid #ffc107}.player-box.drag-over{border-color:#28a745;border-width:3px;background-color:#e8f5e8}.format{font-style:italic;color:#666;margin-top:8px;font-size:.9em}.info-box{background:#cff4fc;border:1px solid #0dcaf0;padding:15px;border-radius:5px;margin:15px 0}.warning-box{background:#fff3cd;border:1px solid #ffc107;padding:15px;border-radius:5px;margin:15px 0}.info-box{background:#cff4fc;border:1px solid #0dcaf0;padding:15px;border-radius:5px;margin:15px 0}.warning-box{background:#fff3cd;border:1px solid #ffc107;padding:15px;border-radius:5px;margin:15px 0}.selection-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:10px;margin:15px 0}.player-checkbox{display:flex;align-items:center;padding:8px;border:1px solid #ddd;border-radius:5px;background:#fff;cursor:pointer;transition:all .2s}.player-checkbox:hover{border-color:#007acc;background:#f8f9fa}.player-checkbox.pso{background-color:#fff3cd;border-color:#ffc107}.player-checkbox.selected{background-color:#d4edda;border-color:#28a745}.player-checkbox input{margin-right:10px}.save-status{position:fixed;top:20px;right:20px;background:#28a745;color:#fff;padding:8px 16px;border-radius:4px;font-size:14px;z-index:10000;transition:opacity .3s;opacity:0}.save-status.show{opacity:1}.sat-off-player{background:#fff8dc!important;border:2px solid #ffc107!important;font-weight:700}.sat-off-player:hover{background:khaki!important;transform:scale(1.05)}.sat-off-player.dragging{opacity:.5}#satOffPlayersContainer{display:flex;flex-wrap:wrap;gap:8px;min-height:50px;padding:10px;border:2px dashed #ffc107;border-radius:5px;background:#fffbf0}#satOffPlayersContainer.drag-over{border-color:#007acc;background:#e3f2fd}</style></head><body><div class=logo-section style=position:relative><div style=display:flex;align-items:center;justify-content:center;gap:20px><img src=CTClogo.jpg alt="Tennis Club Logo" class=logo><h1 style=margin:0;color:#333>Social Tennis Match Maker</h1></div><div style=position:absolute;bottom:10px;right:15px;font-size:11px;color:#999>© 2025 Problems?: Paul Oen 0438 374 643</div></div><div id=memberLoadStatus style="margin:15px 0"></div><div style="text-align:center;margin:15px 0;padding:10px;background:#e3f2fd;border-radius:5px"><button id=importExcelBtn class=secondary style=background:#007acc>📋 Import Excel File</button> <button onclick=clearSavedData() class=danger style=margin-left:10px>Start New Session</button> <input type=file id=excelFileInput accept=.xlsx,.xls style=display:none></div><div class=section><div class=step-header>Step 1: Select available courts</div><h4>Selected Courts</h4><div id=availableCourts class=available-courts><em style=color:#666>Click or Drag courts here in the order they will initially be used</em></div><h4>Unselected Courts:</h4><div id=courtPool class=court-pool></div><button id=clearCourts class=secondary>Clear All Courts</button></div><div class=section><div class=step-header>Step 2: Choose match format and set number</div><div class=format-section><div class=format-label>Set Format Preference</div><div class=format-buttons><button type=button class="format-btn active" data-format=Same-Sex>Same-Sex Doubles</button> <button type=button class=format-btn data-format=Mixed>Mixed Doubles</button></div></div><div class=set-section><div class=set-label>Set Number</div><div class=set-buttons><button type=button class="set-btn active" data-set=1>Set 1</button> <button type=button class=set-btn data-set=2>Set 2</button> <button type=button class=set-btn data-set=3>Set 3</button> <button type=button class=set-btn data-set=4>Set 4</button> <button type=button class=set-btn data-set=5>Set 5</button> <button type=button class=set-btn data-set=6>Set 6</button></div></div><select id=formatSelector style=display:none><option value=Same-Sex selected=selected>Same-Sex Doubles</option><option value=Mixed>Mixed Doubles</option></select> <select id=setNumberSelector style=display:none><option value=1 selected=selected>Set 1</option><option value=2>Set 2</option><option value=3>Set 3</option><option value=4>Set 4</option><option value=5>Set 5</option><option value=6>Set 6</option></select></div><div id=playerSelectionSection class=section style=display:none><div class=step-header>Step 3: Player Input</div><table class=player-table><thead><tr><th style=width:200px>Name</th><th style=width:80px>Grade</th><th style=width:80px>Gender</th><th style=width:60px>NHC</th><th style=width:60px>NXD</th><th style=width:50px>+/-</th><th style=width:80px>Resting</th><th style=width:60px>PSO</th><th style=width:60px>SO</th></tr></thead><tbody id=playerTableBody></tbody><tfoot><tr style="background:#f8f9fa;border-top:2px solid #333"><th style=width:200px>Name</th><th style=width:80px>Grade</th><th style=width:80px>Gender</th><th style=width:60px>NHC</th><th style=width:60px>NXD</th><th style=width:50px>+/-</th><th style=width:80px>Resting</th><th style=width:60px>PSO</th><th style=width:60px>SO</th></tr></tfoot></table><div id=changeWarningBanner class=warning-box style=display:none><h4>⚠️ Changes Detected</h4><p>Player or court information has been modified after matches were generated. After sitting off the needed number of players, please click "Update Players and Proceed" to incorporate these changes.</p></div><div style="text-align:center;margin:15px 0"><button id=addMoreRows class=secondary>Add 10 More Rows</button> <button id=sortPlayersBtn class=secondary style=background:#6f42c1>Sort Alphabetically by First Name</button> <button id=updateMasterList class=secondary style=background:#28a745>Update Master List</button> <button id=generateMatchesBtn class=primary disabled=disabled>Generate Matches for Set 1</button></div><div id=sitOffCalculator class=sit-off-calculator><span id=sitOffCount>Players to sit off: -</span></div><div id=matches class=section style=display:none><div class=step-header>Step 4: Generated Matches</div><div style=margin-bottom:15px;display:flex;justify-content:space-between;align-items:center><div><button id=downloadBtn class=primary style=background:#28a745>📋 Download Results as Excel</button> <button id=printBtn class=primary style=background:#007acc;margin-left:10px>🖨️ Print Match Sheet</button> <button id=fullScreenBtn class=primary style=background:#6f42c1;margin-left:10px>📺 Full Screen Display</button></div><div><button id=exportInputBtn class=primary style=background:#17a2b8>📤 Output Results as Input Files</button></div></div><div id=matchResults></div></div><script>let hasPlayerChanges=!1,hasPlayerChangesAfterMatches=!1,masterListData=[],availableCourts=[],playerRows=[],debugLog=[],currentData=null,currentMatches=null,allSetsData={},currentSetNumber=1,currentSortState="first",autoScrollInterval=null,autoScrollSpeed=0;const SCROLL_ZONE_SIZE=50,SCROLL_SPEED_MAX=8;function splitAB(e){const t=Math.ceil(e.length/2);return[e.slice(0,t),e.slice(t)]}function rotateRight(e,t){const a=e.length;if(0===a)return e.slice();const n=(t%a+a)%a;return 0===n?e.slice():e.slice(a-n).concat(e.slice(0,a-n))}function interleaveAB(e,t){const a=[],n=Math.max(e.length,t.length);for(let r=0;r<n;r++)r<e.length&&a.push(e[r]),r<t.length&&a.push(t[r]);return a}function mixABSmart(e,t){if(e.length<=1)return e.slice();let[a,n]=splitAB(e);const r=2*(t-1);return a=rotateRight(a,t-1),n=rotateRight(n,r),interleaveAB(a,n)}const MIXING_MODE="ab-smart";let manualMatches=[];function getPerfect16Schedule(e){return{1:[[0,1,2,3],[4,5,6,7],[8,9,10,11],[12,13,14,15]],2:[[0,4,8,12],[1,5,9,13],[2,6,10,14],[3,7,11,15]],3:[[0,5,10,15],[1,4,11,14],[2,7,8,13],[3,6,9,12]],4:[[0,6,11,13],[1,7,10,12],[2,4,9,15],[3,5,8,14]],5:[[0,7,9,14],[1,6,8,15],[2,5,11,12],[3,4,10,13]]}[e]||null}function generatePerfect16Matches(e){log("Generating Perfect 16 matches for Set "+e);const t=playerRows.filter(e=>e.name&&""!==e.name.trim()&&""!==e.grade&&""!==e.gender&&!e.resting&&!e.so);if(16!==t.length)return log("ERROR: Expected 16 players, found "+t.length),null;const a=t.map((e,t)=>({...e,id:t})),n=getPerfect16Schedule(e);if(!n)return log("ERROR: No schedule found for Set "+e),null;const r=[];let o=0;return n.forEach(n=>{if(o>=currentData.courts.length)return log("ERROR: Not enough courts for Perfect 16"),null;const l=currentData.courts[o].court,s=[a[n[0]],a[n[1]]],c=[a[n[2]],a[n[3]]],i="M"===t[0].gender?"Same-Sex Doubles (Men)":"Same-Sex Doubles (Women)";r.push({court:l,team1:s,team2:c,format:i,note:"Perfect 16 Set "+e}),o++}),log("Perfect 16: Generated "+r.length+" matches for Set "+e),r}function detectPerfect16Scenario(){const e=parseInt(document.getElementById("setNumberSelector").value);if(e<1||e>5)return!1;for(let e=1;e<=5;e++)if(allSetsData[e]&&allSetsData[e].matches){if(allSetsData[e].matches.some(e=>e.isManual))return log("Perfect 16 disabled: Manual matches detected in Set "+e),!1}if(manualMatches&&manualMatches.length>0)return log("Perfect 16 disabled: Manual matches selected for current set"),!1;const t=playerRows.filter(e=>e.name&&""!==e.name.trim()&&""!==e.grade&&""!==e.gender&&!e.resting&&!e.so);if(16!==t.length)return!1;const a=[...new Set(t.map(e=>e.gender))];if(1!==a.length)return!1;const n=[...new Set(t.map(e=>e.grade))];return 1===n.length&&(log("=== PERFECT 16 DETECTED ==="),log("16 players, all "+a[0]+", all grade "+translateGrade(n[0])),!0)}let selectedManualPlayers=[],selectedCourt=null,manualTeam1=[],manualTeam2=[];function saveDataToStorage(){try{const e={version:"1.0",timestamp:(new Date).toISOString(),availableCourts:availableCourts,playerRows:playerRows,currentSetNumber:parseInt(document.getElementById("setNumberSelector").value),allSetsData:allSetsData,manualMatches:manualMatches,currentData:currentData,currentMatches:currentMatches,setFormatPreference:document.getElementById("formatSelector").value};localStorage.setItem("tennisMatchMaker_autoSave",JSON.stringify(e)),localStorage.setItem("tennisMatchMaker_lastSave",(new Date).toISOString()),showSaveIndicator()}catch(e){console.warn("Failed to auto-save data:",e)}}function loadDataFromStorage(){try{const e=localStorage.getItem("tennisMatchMaker_autoSave"),t=localStorage.getItem("tennisMatchMaker_lastSave");if(!e)return!1;const a=JSON.parse(e),n=new Date(t);if((new Date-n)/36e5>24)return localStorage.removeItem("tennisMatchMaker_autoSave"),localStorage.removeItem("tennisMatchMaker_lastSave"),!1;const r=`\n  <div id="restoreDialog" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;">\n    <div style="background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); max-width: 400px; text-align: center;">\n      <h3 style="margin-top: 0; color: #333;">Previous Session Found</h3>\n      <p style="color: #666; margin: 15px 0;">Data saved on ${n.toLocaleString()}</p>\n      <div style="margin: 25px 0;">\n  <button id="freshBtn" style="background: #28a745; color: white; border: none; padding: 12px 20px; margin: 5px; border-radius: 5px; cursor: pointer; font-size: 16px;">Start Fresh</button>\n  <button id="restoreBtn" style="background: #007acc; color: white; border: none; padding: 12px 20px; margin: 5px; border-radius: 5px; cursor: pointer; font-size: 16px;">Restore Old</button>\n</div>\n    </div>\n  </div>\n`;return document.body.insertAdjacentHTML("beforeend",r),document.getElementById("restoreBtn").onclick=()=>{document.getElementById("restoreDialog").remove(),restoreDataFromSave(a)},document.getElementById("freshBtn").onclick=()=>{document.getElementById("restoreDialog").remove(),localStorage.removeItem("tennisMatchMaker_autoSave"),localStorage.removeItem("tennisMatchMaker_lastSave")},!1}catch(e){console.warn("Failed to load saved data:",e)}return!1}function restoreDataFromSave(e){try{availableCourts=e.availableCourts||[],playerRows=e.playerRows||[],allSetsData=e.allSetsData||{},manualMatches=e.manualMatches||[],currentData=e.currentData,currentMatches=e.currentMatches,document.getElementById("setNumberSelector").value=e.currentSetNumber||1,document.getElementById("formatSelector").value=e.setFormatPreference||"Same-Sex",document.querySelectorAll(".set-btn").forEach(t=>{t.classList.remove("active"),t.dataset.set==(e.currentSetNumber||1)&&t.classList.add("active")}),document.querySelectorAll(".format-btn").forEach(t=>{t.classList.remove("active"),t.dataset.format===(e.setFormatPreference||"Same-Sex")&&t.classList.add("active")}),updateAvailableCourtsDisplay(),initializeCourts(),availableCourts.forEach(e=>{const t=document.querySelector(`[data-court="${e}"]`);t&&"courtPool"===t.parentElement.id&&t.remove()}),restorePlayerTable(),playerRows.some(e=>e.name&&""!==e.name.trim())&&(document.getElementById("playerSelectionSection").style.display="block"),currentMatches&&currentMatches.length>0&&(document.getElementById("matches").style.display="block",displayResults(currentData,currentMatches)),updateSitOffCalculation(),updateProceedButton(),alert("Data restored successfully!")}catch(e){alert("Error restoring data: "+e.message)}}function restorePlayerTable(){for(document.getElementById("playerTableBody").innerHTML="";playerRows.length<10;)playerRows.push({name:"",grade:"",gender:"",nhc:!1,nxd:!1,plusMinus:"",resting:!1,pso:!1,so:!1});playerRows.forEach((e,t)=>{if(addPlayerRowAtIndex(t),e.name){const a=document.querySelector(`.name-input[data-row="${t}"]`);a.value=e.name,a.dataset.skipAutocomplete="true";const n=new Event("input",{bubbles:!0});a.dispatchEvent(n),setTimeout(()=>{delete a.dataset.skipAutocomplete},100),playerRows[t].name=e.name,document.getElementById(`grade-${t}`).value=e.grade,document.getElementById(`gender-${t}`).value=e.gender,document.getElementById(`nhc-${t}`).checked=e.nhc,document.getElementById(`nxd-${t}`).checked=e.nxd,document.getElementById(`plusminus-${t}`).value=e.plusMinus||"",document.getElementById(`resting-${t}`).checked=e.resting,document.getElementById(`pso-${t}`).checked=e.pso,document.getElementById(`so-${t}`).checked=e.so,e.name&&e.grade&&e.gender&&(document.querySelector(`[data-row="${t}"].delete-player-btn`).style.display="block")}})}function addPlayerRowAtIndex(e){const t=document.getElementById("playerTableBody"),a=document.createElement("tr");a.innerHTML=`\n    <td style="position: relative;">\n      <div style="display: flex; align-items: center; gap: 5px;">\n        <input type="text" class="name-input" placeholder="Start typing name..." \n               data-row="${e}" autocomplete="off" style="flex: 1;">\n        <button type="button" class="delete-player-btn" data-row="${e}" \n                style="background: #dc3545; color: white; border: none; border-radius: 3px; \n                       padding: 3px 6px; font-size: 12px; cursor: pointer; display: none;"\n                title="Remove player">×</button>\n      </div>\n      <div class="autocomplete-suggestions" id="suggestions-${e}" style="display: none;"></div>\n    </td>\n    <td>\n      <select class="grade-select" id="grade-${e}" data-row="${e}">\n        <option value="">-</option>\n        <option value="5">2</option>\n        <option value="4">2A</option>\n        <option value="3">2B</option>\n        <option value="2">3</option>\n        <option value="1">3A</option>\n      </select>\n    </td>\n    <td>\n      <select class="gender-select" id="gender-${e}" data-row="${e}">\n        <option value="">-</option>\n        <option value="M">M</option>\n        <option value="F">F</option>\n      </select>\n    </td>\n    <td class="checkbox-cell">\n      <input type="checkbox" class="status-checkbox" id="nhc-${e}" data-row="${e}">\n    </td>\n    <td class="checkbox-cell">\n      <input type="checkbox" class="status-checkbox" id="nxd-${e}" data-row="${e}">\n    </td>\n<td>\n  <select class="grade-select" id="plusminus-${e}" data-row="${e}">\n    <option value=""></option>\n    <option value="+">+</option>\n    <option value="-">-</option>\n  </select>\n</td>\n    <td class="checkbox-cell">\n      <input type="checkbox" class="status-checkbox" id="resting-${e}" data-row="${e}">\n    </td>\n    <td class="checkbox-cell">\n      <input type="checkbox" class="status-checkbox" id="pso-${e}" data-row="${e}">\n    </td>\n    <td class="checkbox-cell">\n      <input type="checkbox" class="status-checkbox" id="so-${e}" data-row="${e}">\n    </td>\n  `,t.appendChild(a);const n=a.querySelector(".name-input");attachNameInputHandlers(a,n,e);a.querySelector(`#resting-${e}`).addEventListener("change",t=>{playerRows[e].resting=t.target.checked,updateSitOffCalculation(),updateProceedButton(),saveDataToStorage(),checkForPlayerChangesAfterMatches()});a.querySelector(`#pso-${e}`).addEventListener("change",t=>{playerRows[e].pso=t.target.checked,saveDataToStorage()});a.querySelector(`#so-${e}`).addEventListener("change",t=>{playerRows[e].so=t.target.checked,updateSitOffCalculation(),updateProceedButton(),saveDataToStorage(),checkForPlayerChangesAfterMatches()});a.querySelector(`[data-row="${e}"].delete-player-btn`).addEventListener("click",()=>{clearPlayerRow(e),saveDataToStorage()});a.querySelector(`#grade-${e}`).addEventListener("change",t=>{playerRows[e].grade=""===t.target.value?"":parseInt(t.target.value),updateSitOffCalculation(),updateProceedButton(),saveDataToStorage(),checkForPlayerChangesAfterMatches()});a.querySelector(`#gender-${e}`).addEventListener("change",t=>{playerRows[e].gender=t.target.value,updateSitOffCalculation(),updateProceedButton(),saveDataToStorage(),checkForPlayerChangesAfterMatches()});a.querySelector(`#nhc-${e}`).addEventListener("change",t=>{playerRows[e].nhc=t.target.checked,saveDataToStorage()});a.querySelector(`#nxd-${e}`).addEventListener("change",t=>{playerRows[e].nxd=t.target.checked,saveDataToStorage()});a.querySelector(`#plusminus-${e}`).addEventListener("change",t=>{playerRows[e].plusMinus=t.target.value,saveDataToStorage()})}function showSaveIndicator(){let e=document.getElementById("saveIndicator");e||(e=document.createElement("div"),e.id="saveIndicator",e.style.cssText="\n      position: fixed;\n      top: 20px;\n      right: 20px;\n      background: #28a745;\n      color: white;\n      padding: 8px 16px;\n      border-radius: 4px;\n      font-size: 14px;\n      z-index: 10000;\n      transition: opacity 0.3s;\n    ",document.body.appendChild(e)),e.textContent="Saved ✓",e.style.opacity="1",setTimeout(()=>{e.style.opacity="0"},2e3)}function checkForPlayerChangesAfterMatches(){"block"===document.getElementById("matches").style.display&&(hasPlayerChangesAfterMatches=!0,showChangeWarning())}function showChangeWarning(){document.getElementById("changeWarningBanner").style.display="block",document.getElementById("matches").style.display="none"}function clearChangeWarning(){hasPlayerChangesAfterMatches=!1,document.getElementById("changeWarningBanner").style.display="none"}function clearSavedData(){confirm("Are you sure you want to clear all saved data and refresh the screen? This cannot be undone.")&&(localStorage.removeItem("tennisMatchMaker_autoSave"),localStorage.removeItem("tennisMatchMaker_lastSave"),alert("Saved data cleared successfully. The page will now refresh."),window.location.reload())}function log(e){console.log(e),debugLog.push(e)}function scrollToElement(e){const t=document.getElementById(e);t&&t.scrollIntoView({behavior:"smooth",block:"start"})}function translateGrade(e){switch(e){case 5:return"2";case 4:return"2A";case 3:return"2B";case 2:return"3";case 1:return"3A";default:return e}}function reverseTranslateGrade(e){switch(e){case"2":return 5;case"2A":return 4;case"2B":return 3;case"3":return 2;case"3A":return 1;default:return e}}function generateJSFileContent(e){let t="// Tennis Club Member Master List\n";return t+="// Generated on: "+(new Date).toLocaleString()+"\n",t+="// Total Members: "+e.length+"\n\n",t+="const MEMBERS = [\n",e.forEach((a,n)=>{t+="  {\n",t+=`    name: "${a.name}",\n`,t+=`    grade: "${translateGrade(a.grade)}",\n`,t+=`    gender: "${a.gender}",\n`,t+=`    nhc: ${!!a.nhc},\n`,t+=`    nxd: ${!!a.nxd},\n`,t+=`    plusMinus: ${a.plusMinus?`"${a.plusMinus}"`:'""'}\n`,t+="  }",n<e.length-1&&(t+=","),t+="\n"}),t+="];\n",t}function downloadJSFile(e){const t=new Blob([e],{type:"text/javascript"}),a=URL.createObjectURL(t),n=document.createElement("a");n.href=a;const r=(new Date).toISOString().slice(0,19).replace(/:/g,"-");n.download=`Member Master List - Updated ${r}.js`,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(a)}function initializeCourts(){const e=document.getElementById("courtPool");e.innerHTML="";const t=[];for(let e=1;e<=27;e++)t.push(e.toString());for(let e=1;e<=10;e++)t.push("H"+e);t.forEach(t=>{const a=document.createElement("div"),n=t.toString().toUpperCase().startsWith("H");a.className=n?"court-item hard-court":"court-item grass-court",a.textContent=t,a.draggable=!0,a.dataset.court=t,a.addEventListener("dragstart",handleCourtDragStart),a.addEventListener("dragend",handleCourtDragEnd),a.addEventListener("click",()=>moveCourtToSelected(t,a)),e.appendChild(a)})}function handleCourtDragStart(e){e.dataTransfer.setData("text/plain",e.target.dataset.court),e.target.classList.add("dragging")}function handleCourtDragEnd(e){e.target.classList.remove("dragging")}const availableCourtsDiv=document.getElementById("availableCourts");function generateUpdatedMasterList(){try{let e=[...masterListData];const t=[];Object.keys(allSetsData).forEach(e=>{const a=allSetsData[e];a&&a.data&&(a.data.availableMen&&a.data.availableMen.forEach(e=>{e.name&&e.grade&&!t.some(t=>t.name===e.name)&&t.push({...e,gender:"M"})}),a.data.availableWomen&&a.data.availableWomen.forEach(e=>{e.name&&e.grade&&!t.some(t=>t.name===e.name)&&t.push({...e,gender:"F"})}))});const a=playerRows.filter(e=>e.name&&""!==e.name.trim()&&""!==e.grade&&""!==e.gender&&!t.some(t=>t.name===e.name)),n=[...t,...a];let r=0,o=0;n.forEach(t=>{const a=e.findIndex(e=>e.name.toLowerCase()===t.name.toLowerCase());if(a>=0){const n=e[a],r=n.nhc;(n.grade!==t.grade||n.gender!==t.gender||!!n.nxd!=!!t.nxd||(n.plusMinus||"")!==(t.plusMinus||""))&&(e[a]={name:t.name,grade:t.grade,gender:t.gender,nhc:r,nxd:!!t.nxd,plusMinus:t.plusMinus||""},o++)}else e.push({name:t.name,grade:t.grade,gender:t.gender,nhc:!1,nxd:!!t.nxd,plusMinus:t.plusMinus||""}),r++}),e.sort((e,t)=>e.name.localeCompare(t.name));downloadJSFile(generateJSFileContent(e));const l=`Master list updated successfully!\nAdded: ${r} new players\nUpdated: ${o} existing players\nTotal players: ${e.length}`;alert(l),log(`Master list generated: ${r} added, ${o} updated, ${e.length} total`)}catch(e){alert(`Error generating master list: ${e.message}`),log(`Error generating master list: ${e.message}`)}}function updateAvailableCourtsDisplay(){const e=document.getElementById("availableCourts");0!==availableCourts.length?(e.innerHTML="",availableCourts.forEach((t,a)=>{const n=document.createElement("div"),r=t.toString().toUpperCase().startsWith("H");n.className=r?"court-item hard-court":"court-item grass-court",n.textContent=t,n.style.cursor="pointer",n.title="Click to remove from selection",n.addEventListener("click",()=>{moveCourtBackToPool(t,a)}),e.appendChild(n)})):e.innerHTML='<em style="color: #666;">Click or Drag courts here in the order they will initially be used</em>'}function moveCourtBackToPool(e,t){availableCourts.splice(t,1),updateAvailableCourtsDisplay(),initializeCourts(),availableCourts.forEach(e=>{const t=document.querySelector(`[data-court="${e}"]`);t&&"courtPool"===t.parentElement.id&&t.remove()}),updateSitOffCalculation(),updateProceedButton(),saveDataToStorage(),checkForPlayerChangesAfterMatches()}function addCourtToPool(e){const t=document.getElementById("courtPool"),a=document.createElement("div"),n=e.toString().toUpperCase().startsWith("H");a.className=n?"court-item hard-court":"court-item grass-court",a.textContent=e,a.draggable=!0,a.dataset.court=e,a.style.cursor="pointer",a.title="Click to add to selection, or drag to specific position",a.addEventListener("dragstart",handleCourtDragStart),a.addEventListener("dragend",handleCourtDragEnd),a.addEventListener("click",()=>{availableCourts.includes(e)||moveCourtToSelected(e,a)});const r=Array.from(t.children);let o=r.length;for(let t=0;t<r.length;t++){const a=r[t].dataset.court;if(shouldCourtComeBefore(e,a)){o=t;break}}o>=r.length?t.appendChild(a):t.insertBefore(a,r[o])}function shouldCourtComeBefore(e,t){const a=e.toString().toUpperCase().startsWith("H"),n=t.toString().toUpperCase().startsWith("H");if(!a&&n)return!0;if(a&&!n)return!1;if(a||n){return parseInt(e.substring(1))<parseInt(t.substring(1))}return parseInt(e)<parseInt(t)}function moveCourtToSelected(e,t){availableCourts.includes(e)||(availableCourts.push(e),updateAvailableCourtsDisplay(),updateSitOffCalculation(),updateProceedButton(),saveDataToStorage(),checkForPlayerChangesAfterMatches(),t.remove())}function loadMemberListOnStartup(){try{if("undefined"==typeof MEMBERS)return void(document.getElementById("memberLoadStatus").innerHTML='<div class="error">❌ Member Master List.js file not found. Please ensure the file is in the same folder as this HTML file.</div>');masterListData=MEMBERS.map(e=>({name:e.name,grade:reverseTranslateGrade(e.grade),gender:e.gender,nhc:e.nhc,nxd:e.nxd,plusMinus:e.plusMinus,originalGrade:e.grade})),document.getElementById("memberLoadStatus").innerHTML=`<div class="success">✓ Loaded ${masterListData.length} players from member list</div>`,document.getElementById("playerSelectionSection").style.display="block",initializePlayerTable()}catch(e){document.getElementById("memberLoadStatus").innerHTML=`<div class="error">Error loading member list: ${e.message}</div>`}}function initializePlayerTable(){playerRows=[];document.getElementById("playerTableBody").innerHTML="";for(let e=0;e<10;e++)addPlayerRow();updateSitOffCalculation()}function addPlayerRow(){const e=document.getElementById("playerTableBody"),t=playerRows.length;playerRows.push({name:"",grade:"",gender:"",nhc:!1,nxd:!1,plusMinus:"",resting:!1,pso:!1,so:!1});const a=document.createElement("tr");a.innerHTML=`\n    <td style="position: relative;">\n      <div style="display: flex; align-items: center; gap: 5px;">\n        <input type="text" class="name-input" placeholder="Start typing name..." \n               data-row="${t}" autocomplete="off" style="flex: 1;">\n        <button type="button" class="delete-player-btn" data-row="${t}" \n                style="background: #dc3545; color: white; border: none; border-radius: 3px; \n                       padding: 3px 6px; font-size: 12px; cursor: pointer; display: none;"\n                title="Remove player">×</button>\n      </div>\n      <div class="autocomplete-suggestions" id="suggestions-${t}" style="display: none;"></div>\n    </td>\n    <td>\n      <select class="grade-select" id="grade-${t}" data-row="${t}">\n        <option value="">-</option>\n        <option value="5">2</option>\n        <option value="4">2A</option>\n        <option value="3">2B</option>\n        <option value="2">3</option>\n        <option value="1">3A</option>\n      </select>\n    </td>\n    <td>\n      <select class="gender-select" id="gender-${t}" data-row="${t}">\n        <option value="">-</option>\n        <option value="M">M</option>\n        <option value="F">F</option>\n      </select>\n    </td>\n    <td class="checkbox-cell">\n      <input type="checkbox" class="status-checkbox" id="nhc-${t}" data-row="${t}">\n    </td>\n    <td class="checkbox-cell">\n      <input type="checkbox" class="status-checkbox" id="nxd-${t}" data-row="${t}">\n    </td>\n    <td>\n      <select class="grade-select" id="plusminus-${t}" data-row="${t}">\n        <option value=""></option>\n        <option value="+">+</option>\n        <option value="-">-</option>\n      </select>\n    </td>\n    <td class="checkbox-cell">\n      <input type="checkbox" class="status-checkbox" id="resting-${t}" data-row="${t}">\n    </td>\n    <td class="checkbox-cell">\n      <input type="checkbox" class="status-checkbox" id="pso-${t}" data-row="${t}">\n    </td>\n    <td class="checkbox-cell">\n      <input type="checkbox" class="status-checkbox" id="so-${t}" data-row="${t}">\n    </td>\n  `,e.appendChild(a);const n=a.querySelector(".name-input");attachNameInputHandlers(a,n,t);a.querySelector(`#resting-${t}`).addEventListener("change",e=>{playerRows[t].resting=e.target.checked,updateSitOffCalculation(),updateProceedButton(),saveDataToStorage(),checkForPlayerChangesAfterMatches()});a.querySelector(`#pso-${t}`).addEventListener("change",e=>{playerRows[t].pso=e.target.checked,saveDataToStorage(),checkForPlayerChangesAfterMatches()});a.querySelector(`#so-${t}`).addEventListener("change",e=>{playerRows[t].so=e.target.checked,updateSitOffCalculation(),updateProceedButton(),saveDataToStorage(),checkForPlayerChangesAfterMatches()});a.querySelector(`[data-row="${t}"].delete-player-btn`).addEventListener("click",()=>{clearPlayerRow(t),saveDataToStorage()});a.querySelector(`#grade-${t}`).addEventListener("change",e=>{playerRows[t].grade=""===e.target.value?"":parseInt(e.target.value);const n=a.querySelector(".name-input"),r=a.querySelector(`[data-row="${t}"].delete-player-btn`);""!==n.value.trim()&&""!==playerRows[t].grade&&""!==playerRows[t].gender&&(r.style.display="block"),updateSitOffCalculation(),updateProceedButton(),saveDataToStorage(),checkForPlayerChangesAfterMatches()});a.querySelector(`#gender-${t}`).addEventListener("change",e=>{playerRows[t].gender=e.target.value;const n=a.querySelector(".name-input"),r=a.querySelector(`[data-row="${t}"].delete-player-btn`);""!==n.value.trim()&&""!==playerRows[t].grade&&""!==playerRows[t].gender&&(r.style.display="block"),updateSitOffCalculation(),updateProceedButton(),saveDataToStorage(),checkForPlayerChangesAfterMatches()});a.querySelector(`#nhc-${t}`).addEventListener("change",e=>{playerRows[t].nhc=e.target.checked,saveDataToStorage(),checkForPlayerChangesAfterMatches()});a.querySelector(`#nxd-${t}`).addEventListener("change",e=>{playerRows[t].nxd=e.target.checked,saveDataToStorage(),checkForPlayerChangesAfterMatches()});a.querySelector(`#plusminus-${t}`).addEventListener("change",e=>{playerRows[t].plusMinus=e.target.value,saveDataToStorage(),checkForPlayerChangesAfterMatches()})}function handleNameInput(e,t){if("true"===e.target.dataset.skipAutocomplete)return;const a=e.target.value.toLowerCase(),n=document.getElementById(`suggestions-${t}`);if(0===a.length)return void hideSuggestions(t);const r=playerRows.map((e,a)=>a!==t?e.name:null).filter(e=>e&&""!==e.trim()),o=masterListData.filter(e=>{if(r.includes(e.name))return!1;const t=e.name.toLowerCase(),n=t.split(" ");return!!t.startsWith(a)||n.some(e=>e.startsWith(a))}).sort((e,t)=>e.name.localeCompare(t.name)).slice(0,10);0!==o.length?(n.innerHTML="",o.forEach((e,a)=>{const r=document.createElement("div");r.className="autocomplete-suggestion",0===a&&r.classList.add("selected"),r.textContent=`${e.name} (${e.originalGrade||translateGrade(e.grade)})`,r.addEventListener("click",()=>selectPlayer(t,e)),n.appendChild(r)}),n.style.display="block"):hideSuggestions(t)}function handleNameKeydown(e,t){const a=document.getElementById(`suggestions-${t}`),n=a&&"block"===a.style.display,r=n?a.querySelectorAll(".autocomplete-suggestion"):[];if("Enter"===e.key&&(!n||0===r.length)){e.preventDefault();const a=e.target.value.trim();a&&(playerRows[t].name=a,saveDataToStorage(),checkForPlayerChangesAfterMatches?.()),hideSuggestions(t);const n=document.getElementById(`grade-${t}`);return void(n&&n.focus())}if(!n||0===r.length)return;let o=-1;if(r.forEach((e,t)=>{e.classList.contains("selected")&&(o=t)}),"ArrowDown"===e.key)e.preventDefault(),o>=0&&r[o].classList.remove("selected"),o=o<r.length-1?o+1:0,r[o].classList.add("selected"),r[o].scrollIntoView({block:"nearest"});else if("ArrowUp"===e.key)e.preventDefault(),o>=0&&r[o].classList.remove("selected"),o=o>0?o-1:r.length-1,r[o].classList.add("selected"),r[o].scrollIntoView({block:"nearest"});else if("Enter"===e.key){e.preventDefault();const t=o>=0?r[o]:r[0];t?.click()}}function selectPlayer(e,t){playerRows[e]={name:t.name,grade:t.grade,gender:t.gender,nhc:t.nhc,nxd:t.nxd,plusMinus:t.plusMinus||"",resting:playerRows[e].resting,pso:playerRows[e].pso,so:playerRows[e].so},document.querySelector(`[data-row="${e}"]`).value=t.name,document.getElementById(`grade-${e}`).value=t.grade,document.getElementById(`gender-${e}`).value=t.gender,document.getElementById(`nhc-${e}`).checked=t.nhc,document.getElementById(`nxd-${e}`).checked=t.nxd,document.getElementById(`plusminus-${e}`).value=t.plusMinus||"",document.querySelector(`[data-row="${e}"].delete-player-btn`).style.display="block",hideSuggestions(e),updateSitOffCalculation(),updateProceedButton(),saveDataToStorage(),setTimeout(()=>{for(let t=e+1;t<playerRows.length;t++)if(!playerRows[t].name||""===playerRows[t].name.trim()){const e=document.querySelector(`[data-row="${t}"]`);if(e){e.focus();break}}},100)}function getPlayerPlusMinus(e,t){const a=playerRows.find(t=>t.name===e);if(a&&a.plusMinus)return a.plusMinus;if(void 0!==masterListData){const t=masterListData.find(t=>t.name===e);if(t&&t.plusMinus)return t.plusMinus}return""}function clearPlayerRow(e){playerRows[e]={name:"",grade:"",gender:"",nhc:!1,nxd:!1,plusMinus:"",resting:!1,pso:!1,so:!1},document.querySelector(`[data-row="${e}"]`).value="",document.getElementById(`grade-${e}`).value="",document.getElementById(`gender-${e}`).value="",document.getElementById(`nhc-${e}`).checked=!1,document.getElementById(`nxd-${e}`).checked=!1,document.getElementById(`plusminus-${e}`).value="",document.getElementById(`resting-${e}`).checked=!1,document.getElementById(`pso-${e}`).checked=!1,document.getElementById(`so-${e}`).checked=!1,document.querySelector(`[data-row="${e}"].delete-player-btn`).style.display="none",updateSitOffCalculation(),updateProceedButton()}function attachNameInputHandlers(e,t,a){t.addEventListener("input",t=>{handleNameInput(t,a),playerRows[a].name=t.target.value;const n=e.querySelector(`[data-row="${a}"].delete-player-btn`),r=""!==t.target.value.trim()&&""!==playerRows[a].grade&&""!==playerRows[a].gender;n.style.display=r?"block":"none",updateSitOffCalculation(),updateProceedButton(),saveDataToStorage(),checkForPlayerChangesAfterMatches()}),t.addEventListener("keydown",e=>handleNameKeydown(e,a)),t.addEventListener("blur",()=>setTimeout(()=>hideSuggestions(a),150))}function hideSuggestions(e){const t=document.getElementById(`suggestions-${e}`);t&&(t.style.display="none",t.innerHTML="")}function updateSitOffCalculation(){const e=playerRows.filter(e=>e.name&&""!==e.name.trim()&&""!==e.grade&&""!==e.gender&&!e.resting&&!e.so),t=playerRows.filter(e=>e.name&&""!==e.name.trim()&&""!==e.grade&&""!==e.gender&&!e.resting&&e.so),a=e.length,n=4*availableCourts.length,r=a%4,o=Math.max(0,a-n),l=Math.max(r,o),s=t.length,c=Math.max(0,l-s),i=document.getElementById("sitOffCount"),d=document.getElementById("sitOffCalculator"),u=availableCourts.filter(e=>!e.toString().toUpperCase().startsWith("H")).length,m=availableCourts.filter(e=>e.toString().toUpperCase().startsWith("H")).length;availableCourts.length;let p=`Grass courts available: ${u}, hard courts available: ${m}, total courts needed: ${Math.floor(a/4)}, players to sit off: ${c}<br>`;p+=`Total Men: ${e.filter(e=>"M"===e.gender).length}, Total Women: ${e.filter(e=>"F"===e.gender).length}, Total Players: ${a}`,i.innerHTML=p,d.className="sit-off-calculator",(0===l||0===c)&&d.classList.add("sit-off-good")}function autoSelectSitOffPlayers(){const e=parseInt(document.getElementById("setNumberSelector").value),t=playerRows.filter(e=>e.name&&""!==e.name.trim()&&""!==e.grade&&""!==e.gender&&!e.resting),a=4*availableCourts.length,n=t.length%4,r=Math.max(0,t.length-a),o=Math.max(n,r);if(0===o)return;playerRows.forEach((e,t)=>{if(!e.pso){e.so=!1;const a=document.getElementById(`so-${t}`);a&&(a.checked=!1)}});let l=[];if(1===e)l=t.filter(e=>!e.pso).sort((e,t)=>(void 0!==e.arrivalOrder?e.arrivalOrder:playerRows.findIndex(t=>t.name===e.name))-(void 0!==t.arrivalOrder?t.arrivalOrder:playerRows.findIndex(e=>e.name===t.name))).slice(-o);else{const a=t.filter(e=>!e.pso).map(t=>{let a=0;for(let n=1;n<e;n++){if(!allSetsData[n]||!allSetsData[n].matches)continue;allSetsData[n].matches.some(e=>e.team1.some(e=>e.name===t.name)||e.team2.some(e=>e.name===t.name))&&a++}return{player:t,setsPlayed:a}});for(let e=Math.max(...a.map(e=>e.setsPlayed));e>=0&&l.length<o;e--){const t=a.filter(t=>t.setsPlayed===e).map(e=>e.player).sort((e,t)=>(void 0!==e.arrivalOrder?e.arrivalOrder:playerRows.findIndex(t=>t.name===e.name))-(void 0!==t.arrivalOrder?t.arrivalOrder:playerRows.findIndex(e=>e.name===t.name))),n=o-l.length,r=t.slice(-n);if(l=l.concat(r),l.length>=o){log(`Selected from players with ${e} sets played`);break}}}l.forEach(e=>{const t=playerRows.findIndex(t=>t.name===e.name);if(t>=0){playerRows[t].so=!0;const e=document.getElementById(`so-${t}`);e&&(e.checked=!0)}}),updateSitOffCalculation(),updateProceedButton(),saveDataToStorage(),log(`Auto-selected ${l.length} players to sit off for Set ${e}: ${l.map(e=>e.name).join(", ")}`)}function updateProceedButton(){const e=playerRows.filter(e=>e.name&&""!==e.name.trim()&&""!==e.grade&&""!==e.gender&&!e.resting),t=playerRows.filter(e=>e.name&&""!==e.name.trim()&&""!==e.gender&&!e.resting&&e.so),a=document.getElementById("generateMatchesBtn"),n=document.getElementById("setNumberSelector").value;if(e.length>=4&&availableCourts.length>0){const r=e.length,o=4*availableCourts.length,l=r%4,s=Math.max(0,r-o),c=Math.max(l,s),i=t.length;if(0===c&&0===i)a.disabled=!1,a.textContent="Generate Matches for Set "+n,a.dataset.action="generate";else if(c>0&&i===c)a.disabled=!1,a.textContent="Generate Matches for Set "+n,a.dataset.action="generate";else if(c>0&&i<c)a.disabled=!1,a.textContent="Suggest names to sit off",a.dataset.action="suggest";else if(c>0&&i>c){const e=i-c;a.disabled=!1,a.textContent=`Remove ${e} sit-off selections`,a.dataset.action="clear-excess"}else 0===c&&i>0&&(a.disabled=!1,a.textContent=`Remove ${i} sit-off selections (none needed)`,a.dataset.action="clear-so")}else a.disabled=!0,a.textContent="Generate Matches for Set "+n,a.dataset.action="disabled"}function toggleSortOrder(){const e=playerRows.map((e,t)=>({...e,arrivalOrder:void 0!==e.arrivalOrder?e.arrivalOrder:t})).filter(e=>e.name&&""!==e.name.trim()&&""!==e.grade&&""!==e.gender);if(0===e.length)return void alert("No players to sort. Please add some players first.");"first"===currentSortState?(e.sort((e,t)=>{const a=e.name.trim().split(" ")[0].toLowerCase(),n=t.name.trim().split(" ")[0].toLowerCase();return a.localeCompare(n)}),console.log(`Sorted ${e.length} players alphabetically by first name`)):"last"===currentSortState?(e.sort((e,t)=>{const a=e.name.trim().split(" ").pop().toLowerCase(),n=t.name.trim().split(" ").pop().toLowerCase();return a.localeCompare(n)}),console.log(`Sorted ${e.length} players alphabetically by last name`)):(e.sort((e,t)=>e.arrivalOrder-t.arrivalOrder),console.log(`Sorted ${e.length} players by arrival order`));const t=document.getElementById("sortPlayersBtn");"first"===currentSortState?(currentSortState="last",t.textContent="Sort Alphabetically by Last Name"):"last"===currentSortState?(currentSortState="arrival",t.textContent="Sort by Arrival Order"):(currentSortState="first",t.textContent="Sort Alphabetically by First Name");const a=[],n=new Set;for(e.forEach(e=>{a.push(e),n.add(e)});a.length<10;)a.push({name:"",grade:"",gender:"",nhc:!1,nxd:!1,plusMinus:"",resting:!1,pso:!1,so:!1});playerRows=a,refreshPlayerTable(),updateSitOffCalculation(),updateProceedButton(),saveDataToStorage(),console.log("Arrival order preserved in arrivalOrder property for sit-off calculations")}function processPlayersAndGenerateMatches(){clearChangeWarning();const e=[...manualMatches],t=playerRows.filter(e=>e.name&&""!==e.name.trim()&&""!==e.grade&&""!==e.gender&&void 0!==e.arrivalOrder);if(t.length>0){t.sort((e,t)=>e.arrivalOrder-t.arrivalOrder);const e=playerRows.filter(e=>void 0===e.arrivalOrder);playerRows=[...t,...e]}const a=playerRows.filter(e=>e.name&&""!==e.name.trim()&&""!==e.grade&&""!==e.gender&&!e.resting&&!e.so),n=a.filter(e=>"M"===e.gender),r=a.filter(e=>"F"===e.gender),o=mixCourts(availableCourts.map((e,t)=>({priority:t+1,court:e})),parseInt(document.getElementById("setNumberSelector").value));currentData={setFormatPreference:document.getElementById("formatSelector").value,availableMen:n,availableWomen:r,courts:o},console.log("Processed data:",currentData),processMatchesWithManualSetup(),restoreValidManualMatches(e,a),saveDataToStorage(),setTimeout(()=>{scrollToElement("matches")},500)}function restoreValidManualMatches(e,t){if(!e||0===e.length)return;const a=t.map(e=>e.name),n=[];if(e.forEach(e=>{const t=[...e.team1,...e.team2].every(e=>a.includes(e.name)),r=availableCourts.includes(e.court);if(t&&r){n.push(e),[...e.team1,...e.team2].forEach(e=>{const t=document.querySelector(`[data-player-name="${e.name}"]`);t&&t.classList.add("excluded")});const t=document.querySelector(`[data-court="${e.court}"]`);t&&t.classList.add("excluded")}else t||console.log(`Manual match on Court ${e.court} not restored: one or more players are now sitting off or resting`),r||console.log(`Manual match on Court ${e.court} not restored: court no longer available`)}),manualMatches=n,updateManualMatchDisplay(),n.length>0){console.log(`Restored ${n.length} valid manual matches`);const e=document.createElement("div");e.style.cssText="\n      position: fixed;\n      top: 50px;\n      right: 20px;\n      background: #28a745;\n      color: white;\n      padding: 12px 20px;\n      border-radius: 5px;\n      box-shadow: 0 2px 10px rgba(0,0,0,0.2);\n      z-index: 10000;\n      font-weight: bold;\n    ",e.textContent=`✓ Restored ${n.length} manual match${n.length>1?"es":""}`,document.body.appendChild(e),setTimeout(()=>{e.style.opacity="0",e.style.transition="opacity 0.5s",setTimeout(()=>e.remove(),500)},3e3)}}function processMatchesWithManualSetup(){const e=[],t=[];manualMatches.forEach(a=>{a.team1.forEach(t=>e.push(t.name)),a.team2.forEach(t=>e.push(t.name)),t.push(a.court)});const a={...currentData,availableMen:currentData.availableMen.filter(t=>!e.includes(t.name)),availableWomen:currentData.availableWomen.filter(t=>!e.includes(t.name)),courts:currentData.courts.filter(e=>!t.includes(e.court))};console.log(`Excluded ${e.length} players and ${t.length} courts for manual matches`);const n=(a.availableMen.length+a.availableWomen.length)%4;if(0===n){const e=generateMatches(a);currentData=e.sortedData;const t=[...manualMatches,...e.matches];currentMatches=t,displayResults(currentData,t)}else alert(`Cannot proceed: ${n} players remaining after manual matches. Need multiple of 4.`)}function generateMatches(e){if(log("=== MAIN MATCH PROCESSING STARTED ==="),log("Current set number: "+document.getElementById("setNumberSelector").value),log("Format preference: "+e.setFormatPreference),log("Total players: "+(e.availableMen.length+e.availableWomen.length)),log("Available courts: "+e.courts.length),detectPerfect16Scenario()){const t=generatePerfect16Matches(parseInt(document.getElementById("setNumberSelector").value));if(t){const a=processCourtPreferences(e,t);return currentMatches=a,void displayResults(e,a)}6===parseInt(document.getElementById("setNumberSelector").value)&&log("=== EXITING PERFECT 16 MODE - SWITCHING TO NORMAL ALGORITHMS ==="),log("Perfect 16 failed, falling back to normal algorithm")}log("=== STARTING MATCH FORMATION ==="),log(">>> Phase 1: Sorting and mixing players");const t=sortPlayers(e);log("<<< Phase 1 complete: Players sorted and mixed"),log(">>> Phase 2: Forming initial matches");const a=formMatchesStrict(t);log("<<< Phase 2 complete: "+a.length+" matches created"),log(">>> Phase 3: Balancing all matches");const n=balanceIndividualMatches(t,a.map(e=>balanceTeamsIfNeeded(e)));log("<<< Phase 3 complete: All matches balanced"),log(">>> Phase 4: Processing court preferences");const r=processCourtPreferences(t,n);log("<<< Phase 4 complete"),log(">>> Phase 5: Competitiveness optimization");const o=fixUncompetitiveMatches(t,r);log("<<< Phase 5 complete"),log(">>> Phase 6: Auto-fixing repeat partnerships");const l=autoFixRepeatPartnerships(t,o);log("<<< Phase 6 complete"),log(">>> Phase 7: Auto-fixing repeat opponents");const s=autoFixRepeatOpponents(t,l);log("<<< Phase 7 complete"),log("=== MAIN MATCH PROCESSING COMPLETE ===");return{sortedData:t,matches:s.map(e=>manualMatches.find(t=>t.court===e.court&&t.team1.length===e.team1.length&&t.team1.every((t,a)=>t.name===e.team1[a].name))?{...e,isManual:!0}:e)}}function mixCourts(e,t){if(!e||0===e.length||1===t)return e;const a=e.filter(e=>!e.court.toString().toUpperCase().startsWith("H")),n=e.filter(e=>e.court.toString().toUpperCase().startsWith("H"));if(a.length<=1)return e;const r=[...a];for(let e=r.length-1;e>0;e--){const t=Math.floor(Math.random()*(e+1));[r[e],r[t]]=[r[t],r[e]]}log(`Court mixing: Randomly shuffled ${a.length} grass courts for Set ${t}`),log(`Original grass order: ${a.map(e=>e.court).join(", ")}`),log(`Shuffled grass order: ${r.map(e=>e.court).join(", ")}`);return[...r,...n].map((e,t)=>({priority:t+1,court:e.court}))}function sortPlayers(e){const t=(e,t)=>t.grade-e.grade,a=(e,t)=>{if(t.grade!==e.grade)return t.grade-e.grade;const a="+"===e.plusMinus?1:"-"===e.plusMinus?-1:0;return("+"===t.plusMinus?1:"-"===t.plusMinus?-1:0)-a},n=parseInt(document.getElementById("setNumberSelector").value);let r,o,l,s,c=!1;if("Mixed"===document.getElementById("formatSelector").value&&n>1){c=!0;for(let e=1;e<n;e++)if(allSetsData[e]&&allSetsData[e].data&&"Mixed"===allSetsData[e].data.setFormatPreference){c=!1;break}}if(1===n?(r=e.availableMen.slice().sort(t),o=e.availableWomen.slice().sort(t),log("Set 1: Sorting by grade only, preserving arrival order within grades")):(r=e.availableMen.slice().sort(a),o=e.availableWomen.slice().sort(a),log("Set "+n+": Sorting by grade and +/-")),1===n)l=r.slice(),s=o.slice(),log("Set 1: Using arrival order within grades (no mixing applied)");else if(2===n||c)l=r.slice(),s=o.slice(),log(c?"First Mixed Doubles Set: Using +/- sorting without A/B mixing":"Set 2: Using +/- sorting without A/B mixing");else{l=[],s=[];for(let e=5;e>=1;e--){const t=r.filter(t=>t.grade===e);if(t.length>0){const e=mixABSmart(t,n);l.push(...e)}}for(let e=5;e>=1;e--){const t=o.filter(t=>t.grade===e);if(t.length>0){const e=mixABSmart(t,n);s.push(...e)}}log("Applied A/B Smart Mixing WITHIN GRADES for Set "+n)}log("=== SORTED PLAYERS (after mixing) ==="),log(`=== DETAILED SET ${n} PLAYER ORDER ===`);for(let e=5;e>=1;e--){const t=l.filter(t=>t.grade===e);t.length>0&&(log(`Grade ${translateGrade(e)} MEN (${t.length} total):`),t.forEach((e,t)=>{const a=e.plusMinus||"";log(`  ${t+1}. ${e.name} ${a?"("+a+")":""}`)}))}log("---");for(let e=5;e>=1;e--){const t=s.filter(t=>t.grade===e);t.length>0&&(log(`Grade ${translateGrade(e)} WOMEN (${t.length} total):`),t.forEach((e,t)=>{const a=e.plusMinus||"";log(`  ${t+1}. ${e.name} ${a?"("+a+")":""}`)}))}log("=== END DETAILED PLAYER ORDER ===");for(let e=5;e>=1;e--){const t=l.filter(t=>t.grade===e).length,a=s.filter(t=>t.grade===e).length;(t>0||a>0)&&log("Grade "+translateGrade(e)+": "+t+" men, "+a+" women")}return{...e,sortedMen:l,sortedWomen:s}}function formMatchesStrict(e){return log("=== STRICT MATCH FORMATION ==="),"Mixed"===e.setFormatPreference?formMixedDoublesMatches(e):formSameSexDoublesMatches(e)}function formMixedDoublesMatches(e){log("Using Mixed Doubles Logic");const t=[],a=new Set;let n=0;const r=(t,r,o,l)=>{if(n>=e.courts.length)return log("ERROR: No more courts available"),null;const s=t.filter(t=>e.sortedMen.find(e=>e.name===t.name)).length,c=t.filter(t=>e.sortedWomen.find(e=>e.name===t.name)).length,i=r.filter(t=>e.sortedMen.find(e=>e.name===t.name)).length,d=r.filter(t=>e.sortedWomen.find(e=>e.name===t.name)).length;if(2===s&&0===c&&0===i&&2===d||0===s&&2===c&&2===i&&0===d)return log("ERROR: Attempted prohibited 2M vs 2W match"),null;const u=e.courts[n].court;return n++,t.forEach(e=>a.add(e.name)),r.forEach(e=>a.add(e.name)),log("Created match on Court "+u+": "+t.map(e=>e.name+"("+e.grade+")").join(",")+" vs "+r.map(e=>e.name+"("+e.grade+")").join(",")+" - "+o),{court:u,team1:t,team2:r,format:o,note:l}};for(let n=5;n>=1;n--){log("=== PROCESSING GRADE "+n+" ===");const o=e.sortedMen.filter(e=>e.grade===n&&!a.has(e.name)),l=e.sortedWomen.filter(e=>e.grade===n&&!a.has(e.name)),s=e.sortedMen.filter(e=>e.grade===n-1&&!a.has(e.name)),c=e.sortedWomen.filter(e=>e.grade===n-1&&!a.has(e.name));if(1===o.length&&1===l.length&&s.length>=1&&c.length>=1){const e=r([o[0],c[0]],[s[0],l[0]],"Mixed Doubles","Cross-grade balanced");if(e){t.push(e);continue}}for(;;){const o=e.sortedMen.filter(e=>e.grade===n&&!a.has(e.name)),l=e.sortedWomen.filter(e=>e.grade===n&&!a.has(e.name));if(!(o.length>=2&&l.length>=2))break;{const e=r([o[0],l[0]],[o[1],l[1]],"Mixed Doubles","In-grade");e&&t.push(e)}}log("MANDATORY COMPLETION: All Grade "+n+" players must be assigned");let i=0;for(;i<100;){i++;const o=e.sortedMen.filter(e=>e.grade===n&&!a.has(e.name)),l=e.sortedWomen.filter(e=>e.grade===n&&!a.has(e.name));if(0===o.length&&0===l.length){log("✓ SUCCESS: ALL Grade "+n+" players assigned");break}const s=e.sortedMen.filter(e=>e.grade<n&&!a.has(e.name)).sort((e,t)=>t.grade-e.grade),c=e.sortedWomen.filter(e=>e.grade<n&&!a.has(e.name)).sort((e,t)=>t.grade-e.grade);log("Attempt "+i+": Grade "+n+" remaining: "+o.length+"M + "+l.length+"F"),log("Available lower: "+s.length+"M + "+c.length+"F");let d=!1;if(o.length>=4){const e=r([o[0],o[1]],[o[2],o[3]],"Same-Sex Doubles (Men)","Mandatory completion");e&&(t.push(e),d=!0)}else if(l.length>=4){const e=r([l[0],l[1]],[l[2],l[3]],"Same-Sex Doubles (Women)","Mandatory completion");e&&(t.push(e),d=!0)}else if(3===o.length&&l.length>=1){const e=r([o[0],l[0]],[o[1],o[2]],"Mixed Gender","Mandatory completion 3M+1W");e&&(t.push(e),d=!0)}else if(3===l.length&&o.length>=1){const e=r([o[0],l[0]],[l[1],l[2]],"Mixed Gender","Mandatory completion 1M+3W");e&&(t.push(e),d=!0)}else if(o.length>=2&&c.length>=2){const e=r([o[0],c[0]],[o[1],c[1]],"Mixed Doubles","Cross-grade completion");e&&(t.push(e),d=!0)}else if(l.length>=2&&s.length>=2){const e=r([s[0],l[0]],[s[1],l[1]],"Mixed Doubles","Cross-grade completion");e&&(t.push(e),d=!0)}else if(o.length>=1&&s.length>=3){const e=r([o[0],s[0]],[s[1],s[2]],"Same-Sex Doubles (Men)","Cross-grade completion");e&&(t.push(e),d=!0)}else if(l.length>=1&&c.length>=3){const e=r([l[0],c[0]],[c[1],c[2]],"Same-Sex Doubles (Women)","Cross-grade completion");e&&(t.push(e),d=!0)}else if(o.length>=1&&s.length>=1&&c.length>=2){const e=r([o[0],c[0]],[s[0],c[1]],"Mixed Doubles","Cross-grade completion");e&&(t.push(e),d=!0)}else if(l.length>=1&&c.length>=1&&s.length>=2){const e=r([s[0],l[0]],[s[1],c[0]],"Mixed Doubles","Cross-grade completion");e&&(t.push(e),d=!0)}if(!d){log("❌ CRITICAL ERROR: Cannot complete Grade "+n),log("Remaining target players: "+o.map(e=>e.name).join(",")+" | "+l.map(e=>e.name).join(",")),log("Available lower players: "+s.length+"M + "+c.length+"F");break}}}log("=== FINAL CLEANUP PHASE ===");let o=0;for(;o<20;){o++;const n=e.sortedMen.filter(e=>!a.has(e.name)),l=e.sortedWomen.filter(e=>!a.has(e.name));if(0===n.length&&0===l.length){log("✓ CLEANUP SUCCESS: All players assigned");break}log("Cleanup attempt "+o+": "+n.length+"M + "+l.length+"W remaining");let s=!1;if(n.length>=4){const e=r([n[0],n[1]],[n[2],n[3]],"Same-Sex Doubles (Men)","Final cleanup");e&&(t.push(e),s=!0)}else if(l.length>=4){const e=r([l[0],l[1]],[l[2],l[3]],"Same-Sex Doubles (Women)","Final cleanup");e&&(t.push(e),s=!0)}else if(n.length>=2&&l.length>=2){const e=r([n[0],l[0]],[n[1],l[1]],"Mixed Doubles","Final cleanup");e&&(t.push(e),s=!0)}else if(3===n.length&&1===l.length){const e=r([n[0],l[0]],[n[1],n[2]],"Mixed Gender","Final cleanup 3M+1W");e&&(t.push(e),s=!0)}else if(3===l.length&&1===n.length){const e=r([n[0],l[0]],[l[1],l[2]],"Mixed Gender","Final cleanup 1M+3W");e&&(t.push(e),s=!0)}if(!s){log("❌ CLEANUP FAILED: Cannot form matches from remaining players");break}}const l=e.sortedMen.filter(e=>!a.has(e.name)),s=e.sortedWomen.filter(e=>!a.has(e.name));return log("=== FINAL STATUS ==="),log("Total matches created: "+t.length),log("Unassigned players: "+(l.length+s.length)),(l.length>0||s.length>0)&&(log("❌ ERROR: Players remain unassigned!"),log("Unassigned men: "+l.map(e=>e.name+"("+e.grade+")").join(", ")),log("Unassigned women: "+s.map(e=>e.name+"("+e.grade+")").join(", "))),t}function formSameSexDoublesMatches(e){log("Using Same-Sex Doubles Logic");const t=[],a=new Set;let n=0;const r=(t,r,o,l)=>{if(n>=e.courts.length)return null;const s=e.courts[n].court;return n++,t.forEach(e=>a.add(e.name)),r.forEach(e=>a.add(e.name)),log("Created match on Court "+s+": "+t.map(e=>e.name+"("+e.grade+")").join(",")+" vs "+r.map(e=>e.name+"("+e.grade+")").join(",")),{court:s,team1:t,team2:r,format:o,note:l}};for(let n=5;n>=1;n--){for(log("=== PROCESSING GRADE "+n+" ===");;){const o=e.sortedMen.filter(e=>e.grade===n&&!a.has(e.name));if(!(o.length>=4))break;{const e=r([o[0],o[1]],[o[2],o[3]],"Same-Sex Doubles (Men)","In-grade");e&&t.push(e)}}for(;;){const o=e.sortedWomen.filter(e=>e.grade===n&&!a.has(e.name));if(!(o.length>=4))break;{const e=r([o[0],o[1]],[o[2],o[3]],"Same-Sex Doubles (Women)","In-grade");e&&t.push(e)}}let o=0;for(;o<20;){o++;const l=e.sortedMen.filter(e=>e.grade===n&&!a.has(e.name)),s=e.sortedWomen.filter(e=>e.grade===n&&!a.has(e.name));if(0===l.length&&0===s.length){log("✓ SUCCESS: ALL Grade "+n+" players assigned");break}const c=e.sortedMen.filter(e=>e.grade<n&&!a.has(e.name)).sort((e,t)=>t.grade-e.grade),i=e.sortedWomen.filter(e=>e.grade<n&&!a.has(e.name)).sort((e,t)=>t.grade-e.grade);let d=!1;if(!d&&3===l.length&&c.length>=1){const e=r([l[0],l[1]],[l[2],c[0]],"Same-Sex Doubles (Men)","Cross-grade 3+1 (preferred for exactly 3 leftovers)");e&&(t.push(e),d=!0)}else if(!d&&3===s.length&&i.length>=1){const e=r([s[0],s[1]],[s[2],i[0]],"Same-Sex Doubles (Women)","Cross-grade 3+1 (preferred for exactly 3 leftovers)");e&&(t.push(e),d=!0)}else if(!d&&l.length>=2&&c.length>=2){const e=r([l[0],c[0]],[l[1],c[1]],"Same-Sex Doubles (Men)","Cross-grade 2+2 (preferred after 3+1)");e&&(t.push(e),d=!0)}else if(!d&&s.length>=2&&i.length>=2){const e=r([s[0],i[0]],[s[1],i[1]],"Same-Sex Doubles (Women)","Cross-grade 2+2 (preferred after 3+1)");e&&(t.push(e),d=!0)}else if(d||3!==l.length||1!==s.length)if(d||3!==s.length||1!==l.length){if(!d&&l.length>=2&&i.length>=2){const e=r([l[0],i[0]],[l[1],i[1]],"Mixed Doubles","Cross-grade mixed completion");e&&(t.push(e),d=!0)}else if(!d&&s.length>=2&&c.length>=2){const e=r([c[0],s[0]],[c[1],s[1]],"Mixed Doubles","Cross-grade mixed completion");e&&(t.push(e),d=!0)}else if(!d&&l.length>=1&&c.length>=3){const e=r([l[0],c[0]],[c[1],c[2]],"Same-Sex Doubles (Men)","Cross-grade 1+3 fallback (last resort)");e&&(t.push(e),d=!0)}else if(!d&&s.length>=1&&i.length>=3){const e=r([s[0],i[0]],[i[1],i[2]],"Same-Sex Doubles (Women)","Cross-grade 1+3 fallback (last resort)");e&&(t.push(e),d=!0)}}else{const e=r([l[0],s[0]],[s[1],s[2]],"Mixed Gender","1M+3W completion");e&&(t.push(e),d=!0)}else{const e=r([l[0],s[0]],[l[1],l[2]],"Mixed Gender","3M+1W completion");e&&(t.push(e),d=!0)}if(!d){log("Cannot complete Grade "+n+" - remaining: "+l.length+"M + "+s.length+"F");break}}}log("=== FINAL CLEANUP PHASE ===");let o=0;for(;o<20;){o++;const n=e.sortedMen.filter(e=>!a.has(e.name)),l=e.sortedWomen.filter(e=>!a.has(e.name));if(0===n.length&&0===l.length){log("✓ CLEANUP SUCCESS: All players assigned");break}log("Cleanup attempt "+o+": "+n.length+"M + "+l.length+"W remaining");let s=!1;if(n.length>=4){const e=r([n[0],n[1]],[n[2],n[3]],"Same-Sex Doubles (Men)","Final cleanup");e&&(t.push(e),s=!0)}else if(l.length>=4){const e=r([l[0],l[1]],[l[2],l[3]],"Same-Sex Doubles (Women)","Final cleanup");e&&(t.push(e),s=!0)}else if(n.length>=2&&l.length>=2){const e=r([n[0],l[0]],[n[1],l[1]],"Mixed Doubles","Final cleanup");e&&(t.push(e),s=!0)}else if(3===n.length&&1===l.length){const e=r([n[0],l[0]],[n[1],n[2]],"Mixed Gender","Final cleanup 3M+1W");e&&(t.push(e),s=!0)}else if(3===l.length&&1===n.length){const e=r([n[0],l[0]],[l[1],l[2]],"Mixed Gender","Final cleanup 1M+3W");e&&(t.push(e),s=!0)}if(!s){log("❌ CLEANUP FAILED: Cannot form matches from remaining players");break}}return log("=== FINAL STATUS ==="),log("Total matches created: "+t.length),t}function balanceTeamsIfNeeded(e){if("Same-Sex Doubles (Men)"!==e.format&&"Same-Sex Doubles (Women)"!==e.format)return e;const t=e.team1.map(e=>e.grade),a=e.team2.map(e=>e.grade),n=t.filter(e=>e>=4).length,r=a.filter(e=>e>=4).length;if(2===n&&0===r){const n=t[0]<t[1]?0:1,r=a[0]>a[1]?0:1,o=e.team1[n];e.team1[n]=e.team2[r],e.team2[r]=o,log("⚖️ Balanced teams: Swapped "+o.name+" ↔ "+e.team1[n].name)}else if(0===n&&2===r){const n=a[0]<a[1]?0:1,r=t[0]>t[1]?0:1,o=e.team2[n];e.team2[n]=e.team1[r],e.team1[r]=o,log("⚖️ Balanced teams: Swapped "+o.name+" ↔ "+e.team2[n].name)}return e}function processCourtPreferences(e,t){log("=== COURT PREFERENCES ===");const a=t=>[...t.team1,...t.team2].some(t=>{const a=e.sortedMen?e.sortedMen.find(e=>e.name===t.name):null,n=e.sortedWomen?e.sortedWomen.find(e=>e.name===t.name):null,r=!a&&e.availableMen?e.availableMen.find(e=>e.name===t.name):null,o=!n&&e.availableWomen?e.availableWomen.find(e=>e.name===t.name):null,l=a||n||r||o;return l&&l.nhc}),n=[],r=[];t.forEach((e,t)=>{var o;(o=e.court)&&o.toString().toUpperCase().startsWith("H")&&a(e)?n.push({index:t,match:e}):(e=>{const t=e&&e.toString().toUpperCase();return t&&(t.startsWith("G")||!t.startsWith("H")&&/^\d+$/.test(t))})(e.court)&&!a(e)&&r.push({index:t,match:e})});const o=Math.min(n.length,r.length);for(let e=0;e<o;e++){const a=n[e].match.court;t[n[e].index].court=r[e].match.court,t[r[e].index].court=a,log("Court swap: "+a+" ↔ "+r[e].match.court)}return t}function checkSpecificPartnershipsAreRepeats(e,t){let a=0;for(let n of e){const e=[n.player1,n.player2].sort().join("-");for(let n=1;n<t;n++){if(!allSetsData[n]||!allSetsData[n].matches)continue;let t=!1;for(let r of allSetsData[n].matches){if(2===r.team1.length){if([r.team1[0].name,r.team1[1].name].sort().join("-")===e){a++,t=!0;break}}if(2===r.team2.length){if([r.team2[0].name,r.team2[1].name].sort().join("-")===e){a++,t=!0;break}}}if(t)break}}return a}function checkForRepeatPartnerships(e,t,a=!1){if(e<=1)return[];const n=[],r=[];t.forEach((e,t)=>{2===e.team1.length&&r.push({matchIndex:t,team:1,players:[e.team1[0].name,e.team1[1].name].sort()}),2===e.team2.length&&r.push({matchIndex:t,team:2,players:[e.team2[0].name,e.team2[1].name].sort()})});for(let t=1;t<e;t++){if(!allSetsData[t]||!allSetsData[t].matches)continue;const e=allSetsData[t].matches,o=[];e.forEach(e=>{2===e.team1.length&&o.push([e.team1[0].name,e.team1[1].name].sort()),2===e.team2.length&&o.push([e.team2[0].name,e.team2[1].name].sort())}),r.forEach(e=>{o.forEach(r=>{e.players[0]===r[0]&&e.players[1]===r[1]&&(n.push({matchIndex:e.matchIndex,team:e.team,players:e.players,previousSet:t}),a||log("Repeat partnership found: "+e.players.join(" & ")+" (previously in Set "+t+")"))})})}return n.length>0&&(a||log(`Found ${n.length} repeat partnerships in initial check`)),n}function checkForRepeatOpponents(e,t){const a=new Set;if(e<=1)return[];const n=[],r=[];for(let t=Math.max(1,e-2);t<e;t++)allSetsData[t]&&allSetsData[t].matches&&r.push({setNum:t,matches:allSetsData[t].matches});return 0===r.length?[]:(t.forEach((e,t)=>{const o=[...e.team1,...e.team2];for(let l=0;l<o.length;l++)for(let s=l+1;s<o.length;s++){const c=o[l],i=o[s],d=c.name<i.name?`${c.name}—${i.name}`:`${i.name}—${c.name}`;if(a.has(d))continue;a.add(d);(e.team1.some(e=>e.name===c.name)?1:2)!==(e.team1.some(e=>e.name===i.name)?1:2)&&r.forEach(({setNum:e,matches:a})=>{a.forEach(e=>{const a=e.team1.some(e=>e.name===c.name)?1:e.team2.some(e=>e.name===c.name)?2:0,r=e.team1.some(e=>e.name===i.name)?1:e.team2.some(e=>e.name===i.name)?2:0;0!==a&&0!==r&&a!==r&&n.push({matchIndex:t,player1:c.name,player2:i.name})})})}}),n)}function autoFixRepeatPartnerships(e,t){const a=parseInt(document.getElementById("setNumberSelector").value);if(a<=1)return t;log("=== AUTO-FIXING REPEAT PARTNERSHIPS ===");const n=JSON.parse(JSON.stringify(t)),r=checkForRepeatPartnerships(a,n);if(log(`Initial check found ${r.length} repeat partnerships`),0===r.length)return log("No repeat partnerships found - no auto-fixes needed"),n;log("Found "+r.length+" repeat partnerships to attempt fixing");log("Repeat partnership limit set to: 20"),r.length>20&&(log("=== REPEAT PARTNERSHIP THRESHOLD EXCEEDED ==="),log("Found "+r.length+" repeat partnerships (>20)"),log("Skipping Phase 2 inter-match fixes to prevent memory issues"),log("Phase 1 intra-match fixes will still be attempted"),log("Remaining repeat partnerships must be resolved manually by operator")),log("=== PHASE 1: INTRA-MATCH FIXES ==="),r.forEach((t,r)=>{const o=t.matchIndex,l=parseInt(t.team),s=n[o],c=1===l?s.team1:s.team2,i=1===l?s.team2:s.team1;log("Attempting intra-match fix for: "+t.players.join(" & ")+" (Match "+o+", Team "+l+")");let d=!1;if(s.format.includes("Same-Sex")){checkForRepeatPartnerships(a,n,!0).length;for(let t=0;t<c.length&&!d;t++)for(let r=0;r<i.length&&!d;r++){const s=c[t],u=i[r];if(getPlayerGender(s.name,e)!==getPlayerGender(u.name,e))continue;const m=JSON.parse(JSON.stringify(n))[o],p=1===l?m.team1:m.team2,g=1===l?m.team2:m.team1,h=p[t];p[t]=g[r],g[r]=h;const f=[];2===p.length&&f.push({player1:p[0].name,player2:p[1].name}),2===g.length&&f.push({player1:g[0].name,player2:g[1].name});const y=[];2===c.length&&y.push({player1:c[0].name,player2:c[1].name}),2===i.length&&y.push({player1:i[0].name,player2:i[1].name});const S=checkSpecificPartnershipsAreRepeats(y,a),b=checkSpecificPartnershipsAreRepeats(f,a);if(b<S){c[t]=u,i[r]=s,log("✅ Intra-match fix (Same-Sex): Swapped "+s.name+" ↔ "+u.name),log("  Repeat partnerships reduced from "+S+" to "+b),d=!0;break}}}else if("Mixed Doubles"===s.format){const t=checkForRepeatPartnerships(a,n,!0).length,r=[...s.team1,...s.team2],l=r.filter(t=>"M"===getPlayerGender(t.name,e)),c=r.filter(t=>"F"===getPlayerGender(t.name,e));if(2===l.length&&!d){const e=JSON.parse(JSON.stringify(n)),r=e[o];let c=null,i=null,u=null,m=null;if(r.team1.forEach((e,t)=>{e.name===l[0].name&&(c=r.team1,i=t),e.name===l[1].name&&(u=r.team1,m=t)}),r.team2.forEach((e,t)=>{e.name===l[0].name&&(c=r.team2,i=t),e.name===l[1].name&&(u=r.team2,m=t)}),c&&u&&null!==i&&null!==m){const n=c[i];c[i]=u[m],u[m]=n;const r=checkForRepeatPartnerships(a,e).length;if(r<t){let e=null,a=null,n=null,o=null;s.team1.forEach((t,r)=>{t.name===l[0].name&&(e=s.team1,a=r),t.name===l[1].name&&(n=s.team1,o=r)}),s.team2.forEach((t,r)=>{t.name===l[0].name&&(e=s.team2,a=r),t.name===l[1].name&&(n=s.team2,o=r)});const c=e[a];e[a]=n[o],n[o]=c,log("✅ Intra-match fix (Mixed Doubles - Men): Swapped "+l[0].name+" ↔ "+l[1].name),log("  Repeat partnerships reduced from "+t+" to "+r),d=!0}}}if(2===c.length&&!d){const e=JSON.parse(JSON.stringify(n)),r=e[o];let l=null,i=null,u=null,m=null;if(r.team1.forEach((e,t)=>{e.name===c[0].name&&(l=r.team1,i=t),e.name===c[1].name&&(u=r.team1,m=t)}),r.team2.forEach((e,t)=>{e.name===c[0].name&&(l=r.team2,i=t),e.name===c[1].name&&(u=r.team2,m=t)}),l&&u&&null!==i&&null!==m){const n=l[i];l[i]=u[m],u[m]=n;const r=checkForRepeatPartnerships(a,e).length;if(r<t){let e=null,a=null,n=null,o=null;s.team1.forEach((t,r)=>{t.name===c[0].name&&(e=s.team1,a=r),t.name===c[1].name&&(n=s.team1,o=r)}),s.team2.forEach((t,r)=>{t.name===c[0].name&&(e=s.team2,a=r),t.name===c[1].name&&(n=s.team2,o=r)});const l=e[a];e[a]=n[o],n[o]=l,log("✅ Intra-match fix (Mixed Doubles - Women): Swapped "+c[0].name+" ↔ "+c[1].name),log("  Repeat partnerships reduced from "+t+" to "+r),d=!0}}}}d||log("❌ Could not fix intra-match: "+t.players.join(" & "))});const o=checkForRepeatPartnerships(a,n);if(0===o.length)return log("🎉 Phase 1 resolved all repeat partnerships!"),n;if(r.length<=20){log("=== PHASE 2: INTER-MATCH FIXES ==="),log("Remaining repeats after Phase 1: "+o.length);const t=e.setFormatPreference;o.forEach((r,o)=>{const l=r.matchIndex,s=parseInt(r.team),c=n[l],i=1===s?c.team1:c.team2;1===s?c.team2:c.team1;log("Attempting inter-match fix for: "+r.players.join(" & ")+" (Match "+l+", Team "+s+")");let d=!1;const u=[];"Same-Sex"===t?u.push({name:"Same grade, same gender",criteria:(t,a)=>t.grade===a.grade&&getPlayerGender(t.name,e)===getPlayerGender(a.name,e)}):u.push({name:"Same grade, cross gender",criteria:(t,a)=>t.grade===a.grade&&getPlayerGender(t.name,e)!==getPlayerGender(a.name,e)});for(let e of u){if(d)break;log("  Trying inter-match strategy: "+e.name);for(let t=0;t<n.length&&!d;t++){if(t===l)continue;const r=n[t];for(let t=1;t<=2&&!d;t++){const n=1===t?r.team1:r.team2;for(let t=0;t<i.length&&!d;t++)for(let r=0;r<n.length&&!d;r++){const o=i[t],l=n[r];if(!e.criteria(o,l))continue;const s=[];2===i.length&&s.push({player1:i[0].name,player2:i[1].name}),2===n.length&&s.push({player1:n[0].name,player2:n[1].name});const c=checkSpecificPartnershipsAreRepeats(s,a);i[t]=l,n[r]=o;const u=[];2===i.length&&u.push({player1:i[0].name,player2:i[1].name}),2===n.length&&u.push({player1:n[0].name,player2:n[1].name});const m=checkSpecificPartnershipsAreRepeats(u,a);if(m<c){log("✓ Inter-match fix ("+e.name+"): Swapped "+o.name+" ↔ "+l.name),log("  Repeat partnerships reduced from "+c+" to "+m),d=!0;break}i[t]=o,n[r]=l}}}}d||log("❌ Could not auto-fix: "+r.players.join(" & ")+" - leaving for manual adjustment")});const r=checkForRepeatPartnerships(a,n);r.length>0?(log("⚠ Could not resolve all repeat partnerships. Remaining: "+r.length),r.forEach(e=>{log("  - "+e.players.join(" & ")+" (previously in Set "+e.previousSet+")")})):log("🎉 Successfully resolved all repeat partnerships!")}else log("=== PHASE 2 SKIPPED DUE TO THRESHOLD ==="),log("Phase 1 intra-match fixes completed only"),log("Operator must manually resolve remaining repeat partnerships");return n}function tryIntraMatchOpponentToPartnerSwap(e,t){const a=parseInt(document.getElementById("setNumberSelector").value);if(a<=1)return t;log("=== ATTEMPTING INTRA-MATCH OPPONENT-TO-PARTNER SWAPS ===");const n=JSON.parse(JSON.stringify(t)),r=checkForRepeatOpponents(a,n);if(0===r.length)return n;const o=new Set;return r.forEach(t=>{const r=t.player1<t.player2?`${t.player1}-${t.player2}`:`${t.player2}-${t.player1}`;if(o.has(r))return;o.add(r);const l=n[t.matchIndex];let s=null,c=null,i=null,d=null;if(l.team1.forEach((e,a)=>{e.name===t.player1&&(s=1,c=a),e.name===t.player2&&(i=1,d=a)}),l.team2.forEach((e,a)=>{e.name===t.player1&&(s=2,c=a),e.name===t.player2&&(i=2,d=a)}),s===i)return;const u=0===d?1:0,m=1===s?l.team1:l.team2,p=1===i?l.team1:l.team2;if(2!==p.length)return;log(`Trying intra-match swap in Match ${t.matchIndex}: ${t.player1} ↔ ${p[u].name}`);const g=JSON.parse(JSON.stringify(n)),h=g[t.matchIndex],f=1===s?h.team1:h.team2,y=1===i?h.team1:h.team2,S=f[c];f[c]=y[u],y[u]=S;const b=f.filter(t=>"M"===getPlayerGender(t.name,e)).length,v=y.filter(t=>"M"===getPlayerGender(t.name,e)).length;if(2===b&&0===v||0===b&&2===v)return void log("  ✗ Swap would create prohibited 2M vs 2F match - rejected");const x=e=>e.reduce((e,t)=>e+(e=>"number"==typeof e.grade?e.grade:reverseTranslateGrade(e.grade))(t),0),M=Math.abs(x(m)-x(p)),w=Math.abs(x(f)-x(y));if("function"==typeof isUncompetitive&&isUncompetitive(h)||w>M||w>=2)return void log("  ✗ Swap rejected: reduces competitiveness (gap would worsen or hit balancing threshold)");const E=checkForRepeatPartnerships(a,n).length;if(checkForRepeatPartnerships(a,g).length<=E){const e=m[c];m[c]=p[u],p[u]=e,log(`  ✓ Successful swap! ${t.player1} and ${t.player2} are now partners`)}}),n}function autoFixRepeatOpponents(e,t){const a=new Set,n=new Set,r=parseInt(document.getElementById("setNumberSelector").value);if(r<=1)return t;log("=== AUTO-FIXING REPEAT OPPONENTS ===");const o=JSON.parse(JSON.stringify(t)),l=checkForRepeatOpponents(r,o);if(0===l.length)return log("No repeat opponents found - no auto-fixes needed"),o;log("Found "+l.length+" repeat opponent instances to attempt fixing"),l.forEach((t,l)=>{const s=new Set,c=(e,t,a,n)=>`${e<t?e:t}↔${e<t?t:e}@${Math.min(a,n)}-${Math.max(a,n)}`;log(`\n--- Attempting to fix repeat opponent: ${t.player1} vs ${t.player2} (Match ${t.matchIndex}) ---`);let i=!1,d=0;for(let l=1;l<=1&&!i;l++){d=1,log(`  Attempt 1 for ${t.player1} vs ${t.player2}`);const l=[t.player1,t.player2];for(let t of l){if(log(`  ↳ Trying candidates for ${t}`),i)break;let l=null,d=null,u=null;for(let e=0;e<o.length;e++){const a=o[e];for(let n=0;n<a.team1.length;n++)if(a.team1[n].name===t){l=e,d=1,u=n;break}if(null===l)for(let n=0;n<a.team2.length;n++)if(a.team2[n].name===t){l=e,d=2,u=n;break}if(null!==l)break}if(null===l){log(`    ❌ Could not find player ${t} in any match`);continue}const m=o[l],p=(1===d?m.team1:m.team2)[u],g=getPlayerGender(p.name,e),h=p.grade;for(let t=0;t<o.length&&!i;t++){if(t===l)continue;const m=o[t];for(let f=1;f<=2&&!i;f++){const y=1===f?m.team1:m.team2;for(let m=0;m<y.length&&!i;m++){const S=y[m],b=getPlayerGender(S.name,e),v=S.grade;if(g!==b||h!==v)continue;if(n.has(p.name)||n.has(S.name))continue;const x=c(p.name,S.name,l,t);if(s.has(x)||a.has(x)){log(`      ↩️ Skipping previously tried swap (global): ${p.name} ↔ ${S.name}`);continue}if(log(`    Considering (pre-balance): ${p.name} ↔ ${S.name}`),!wouldCreateBalancedTeams(o,l,u,d,m,f,t)){s.add(x),a.add(x);continue}log(`    Testing swap: ${p.name} ↔ ${S.name} (both ${g}, grade ${h})`);const M={player1:{matchIndex:l,teamNum:d,positionIndex:u,playerData:JSON.parse(JSON.stringify(p))},player2:{matchIndex:t,teamNum:f,positionIndex:m,playerData:JSON.parse(JSON.stringify(S))}},w=JSON.parse(JSON.stringify(o)),E=w[M.player1.matchIndex],$=w[M.player2.matchIndex],I=1===M.player1.teamNum?E.team1:E.team2,C=1===M.player2.teamNum?$.team1:$.team2;I[M.player1.positionIndex]=M.player2.playerData,C[M.player2.positionIndex]=M.player1.playerData;const D=checkForRepeatPartnerships(r,o,!0),P=checkForRepeatPartnerships(r,w,!0).length-D.length;if(P>0){log(`      ❌ Swap would create ${P} new repeat partnership(s) - rejected`),s.add(x),a.add(x);continue}const k=checkForRepeatOpponents(r,o),R=checkForRepeatOpponents(r,w).length-k.length;if(R<0){const e=o[M.player1.matchIndex],t=o[M.player2.matchIndex],a=1===M.player1.teamNum?e.team1:e.team2,r=1===M.player2.teamNum?t.team1:t.team2;a[M.player1.positionIndex]=M.player2.playerData,r[M.player2.positionIndex]=M.player1.playerData,log(`      ✅ Successful swap: ${M.player1.playerData.name} ↔ ${M.player2.playerData.name}`),log(`         Opponents: ${R}, Partnerships: ${0===P?"unchanged":P}`),n.add(M.player1.playerData.name),n.add(M.player2.playerData.name),i=!0;break}log("      ❌ Swap did not reduce repeat opponents - rejected"),s.add(x),a.add(x)}}}}}i||log(`  ❌ Could not fix repeat opponent after ${d} attempts: ${t.player1} vs ${t.player2}`)});return tryIntraMatchOpponentToPartnerSwap(e,o)}function wouldCreateBalancedTeams(e,t,a,n,r,o,l=null){const s=null!==l?l:t,c=e[t],i=e[s],d=1===n?c.team1:c.team2,u=1===o?i.team1:i.team2,m=d[a],p=u[r];if(null===l)return!0;const g=[d[1-a],p],h=[u[1-r],m],f=1===n?c.team2:c.team1,y=1===o?i.team2:i.team1,S=isMatchupBalanced(g,f),b=isMatchupBalanced(h,y);return S&&b}function fixUncompetitiveMatches(e,t){log("=== FINAL COMPETITIVENESS OPTIMIZATION ===");const a=[];if(t.forEach((e,t)=>{isUncompetitive(e)&&a.push({index:t,match:e})}),log(`Found ${a.length} uncompetitive matches`),a.length<=1)return log("≤1 uncompetitive match found - leaving for operator to handle"),t;const n=Math.floor(a.length/2);log(`Processing ${n} pairs of uncompetitive matches`);for(let r=0;r<n;r++){const n=a[2*r],o=a[2*r+1];log(`\n--- Processing pair ${r+1}: Match ${n.index} & Match ${o.index} ---`),attemptCompetitivenessSwap(e,t,n.index,o.index)?log(`✓ Successful competitiveness swap between matches ${n.index} & ${o.index}`):log(`❌ No beneficial swap found between matches ${n.index} & ${o.index}`)}const r=t.filter(e=>isUncompetitive(e)).length;return log("\n=== COMPETITIVENESS OPTIMIZATION COMPLETE ==="),log(`Uncompetitive matches reduced from ${a.length} to ${r}`),t}function balanceIndividualMatches(e,t){log("=== FINAL INDIVIDUAL MATCH BALANCING ===");let a=0;return t.forEach((t,n)=>{const r=t.team1.reduce((e,t)=>e+t.grade,0),o=t.team2.reduce((e,t)=>e+t.grade,0),l=Math.abs(r-o);if(l<2)return;log(`Match ${n} needs balancing: ${r} vs ${o} (gap=${l})`);let s=null,c=l;for(let a=0;a<2;a++)for(let n=0;n<2;n++){if(1===a&&1===n)continue;const r=JSON.parse(JSON.stringify(t)),o=r.team1[a];if(r.team1[a]=r.team2[n],r.team2[n]=o,creates2Mvs2F(r,e))continue;const l=r.team1.reduce((e,t)=>e+t.grade,0),i=r.team2.reduce((e,t)=>e+t.grade,0),d=Math.abs(l-i);d<c&&(c=d,s={t1Player:a,t2Player:n})}if(s){const e=t.team1[s.t1Player];t.team1[s.t1Player]=t.team2[s.t2Player],t.team2[s.t2Player]=e,updateMatchFormat(t),log(`  ✓ Swapped players: Gap reduced from ${l} to ${c}`),a++}else log(`  No valid improvement found for match ${n}`)}),log(`=== INDIVIDUAL MATCH BALANCING COMPLETE: ${a} matches improved ===`),t}function isUncompetitive(e){const t=e.team1.map(e=>e.grade).sort((e,t)=>t-e),a=e.team2.map(e=>e.grade).sort((e,t)=>t-e),n=t[0]-t[1],r=a[0]-a[1],o=n>=2||r>=2;return o&&log(`Uncompetitive match: [${t.join(",")}] vs [${a.join(",")}] - gaps: ${n}, ${r}`),o}function attemptCompetitivenessSwap(e,t,a,n){const r=t[a],o=t[n],l=[...r.team1.map((e,t)=>({...e,match:a,team:1,position:t})),...r.team2.map((e,t)=>({...e,match:a,team:2,position:t}))],s=[...o.team1.map((e,t)=>({...e,match:n,team:1,position:t})),...o.team2.map((e,t)=>({...e,match:n,team:2,position:t}))];l.sort((e,t)=>e.grade-t.grade),s.sort((e,t)=>t.grade-e.grade);const c=l.slice(0,2),i=s.slice(0,2);log("Swapping (no competitiveness check needed):"),log(`  Weakest from Match ${a}: ${c.map(e=>`${e.name}(${e.grade})`).join(", ")}`),log(`  Strongest from Match ${n}: ${i.map(e=>`${e.name}(${e.grade})`).join(", ")}`);const d=JSON.parse(JSON.stringify(r)),u=JSON.parse(JSON.stringify(o)),m=c[0],p=i[0],g=1===m.team?d.team1:d.team2,h=1===p.team?u.team1:u.team2,f={...g[m.position]};g[m.position]={...h[p.position]},h[p.position]=f;const y=c[1],S=i[1],b=1===y.team?d.team1:d.team2,v=1===S.team?u.team1:u.team2,x={...b[y.position]};return b[y.position]={...v[S.position]},v[S.position]=x,creates2Mvs2F(d,e)||creates2Mvs2F(u,e)?(log("  ❌ Swap would create 2M vs 2F - rejected"),!1):(t[a]=d,t[n]=u,updateMatchFormat(t[a]),updateMatchFormat(t[n]),log("  ✓ Swap completed"),!0)}function creates2Mvs2F(e,t){const a=e.team1.filter(e=>"M"===getPlayerGender(e.name,t)).length,n=e.team1.filter(e=>"F"===getPlayerGender(e.name,t)).length,r=e.team2.filter(e=>"M"===getPlayerGender(e.name,t)).length,o=e.team2.filter(e=>"F"===getPlayerGender(e.name,t)).length;return 2===a&&0===n&&0===r&&2===o||0===a&&2===n&&2===r&&0===o}function isMatchupBalanced(e,t){const a=e.map(e=>e.grade).sort((e,t)=>t-e),n=t.map(e=>e.grade).sort((e,t)=>t-e),r=a[0],o=a[1],l=n[0],s=n[1];if(Math.abs(r-l)>1)return!1;const c=r+o,i=l+s,d=a.includes(5),u=n.includes(5);return d&&!u?4===l&&4===s:u&&!d?4===r&&4===o:Math.abs(c-i)<=2}function getPlayerGender(e,t){let a=t.sortedMen?t.sortedMen.find(t=>t.name===e):null,n=t.sortedWomen?t.sortedWomen.find(t=>t.name===e):null;return!a&&t.availableMen&&(a=t.availableMen.find(t=>t.name===e)),!n&&t.availableWomen&&(n=t.availableWomen.find(t=>t.name===e)),a?"M":n?"F":null}function checkPlayingDownStatus(e,t){const a=[];return t.forEach((e,t)=>{const n=[...e.team1,...e.team2];n.forEach(e=>{const r=e.grade,o=n.filter(t=>t.name!==e.name);if(o.some(e=>r-e.grade>=2)){const n=Math.min(...o.map(e=>e.grade)),l=r-n;a.push({matchIndex:t,playerName:e.name,playerGrade:r,lowestOpponentGrade:n,gradeDifference:l})}})}),a}function hasPlayedDownBefore(e,t){for(let a=1;a<t;a++){if(!allSetsData[a]||!allSetsData[a].matches)continue;if(allSetsData[a].matches.some(t=>{const a=[...t.team1,...t.team2],n=a.find(t=>t.name===e);if(!n)return!1;return a.filter(t=>t.name!==e).some(e=>n.grade-e.grade>=1)}))return!0}return!1}function testSwapReducesConflicts(e,t,a,n,r,o,l,s){const c=JSON.parse(JSON.stringify(e)),i=c[t],d=c[r],u=1===a?i.team1:i.team2,m=1===o?d.team1:d.team2,p=checkForRepeatPartnerships(s,e).length,g=u[n];u[n]=m[l],m[l]=g;return checkForRepeatPartnerships(s,c).length<p}function createSatOffPlayerBox(e,t){const a=playerRows.find(t=>t.name===e);if(!a)return"";const n=a.nhc,r=a.nxd,o=a.plusMinus||"",l=hasPlayedDownBefore(e,currentSetNumber)?"↓":"";let s="player-box sat-off-player";return n&&(s+=" nhc"),r&&(s+=" nxd"),`\n    <span class="${s}" draggable="true" \n          data-type="sat-off-player" data-name="${e}" data-grade="${a.grade}"\n          style="display: inline-block; background: #fff8dc; border: 2px solid #ffc107; \n                 padding: 6px 10px; margin: 3px; border-radius: 5px; cursor: move; \n                 user-select: none; font-weight: bold; transition: all 0.2s ease;">\n      ${l}${e} (${translateGrade(a.grade)}${o})\n    </span>`}function displayResults(e,t){currentSetNumber=parseInt(document.getElementById("setNumberSelector").value);const a=t;allSetsData[currentSetNumber]={data:JSON.parse(JSON.stringify(e)),matches:JSON.parse(JSON.stringify(a)),satOffPlayers:[]};const n=playerRows.filter(e=>e.name&&e.so).map(e=>e.name);n.length>0?(allSetsData[currentSetNumber].satOffPlayers=[...n],log("Stored "+allSetsData[currentSetNumber].satOffPlayers.length+" sat-off players for Set "+currentSetNumber)):log("No players sat off for Set "+currentSetNumber+" (evenly divisible by 4)"),log("Set "+currentSetNumber+" data saved to memory");const r=document.getElementById("matches"),o=document.getElementById("matchResults"),l=checkForRepeatPartnerships(currentSetNumber,a),s=checkForRepeatOpponents(currentSetNumber,a);let c='<div class="success">✓ '+a.length+" Matches Generated for Set "+document.getElementById("setNumberSelector").value;manualMatches.length>0&&(c+=" ("+manualMatches.length+" manual + "+t.length+" automatic)"),c+="</div>",c+='<p style="color: #666; font-style: italic;">Drag players or courts to swap them</p>',n.length>0&&(c+=`\n    <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 15px; margin: 20px 0;">\n      <h4 style="margin-top: 0; color: #856404;">Players Sitting Off This Set:</h4>\n      <div id="satOffPlayersContainer">\n        ${n.map(t=>createSatOffPlayerBox(t,e)).join("")}\n      </div>\n      <p style="margin-bottom: 0; font-size: 14px; color: #856404; font-style: italic;">\n        Drag these players into matches to swap them with playing players\n      </p>\n    </div>`);const i=t=>{let a=e.availableMen?e.availableMen.find(e=>e.name===t):null,n=e.availableWomen?e.availableWomen.find(e=>e.name===t):null;!a&&e.sortedMen&&(a=e.sortedMen.find(e=>e.name===t)),!n&&e.sortedWomen&&(n=e.sortedWomen.find(e=>e.name===t));const r=a||n;return r&&r.nhc},d=t=>{let a=e.availableMen?e.availableMen.find(e=>e.name===t):null,n=e.availableWomen?e.availableWomen.find(e=>e.name===t):null;!a&&e.sortedMen&&(a=e.sortedMen.find(e=>e.name===t)),!n&&e.sortedWomen&&(n=e.sortedWomen.find(e=>e.name===t));const r=a||n;return r&&r.nxd};c+='<table style="width: 100%; border-collapse: collapse; margin: 20px 0;">';const u=a.every(e=>e.isManual);c+='<tr style="background: #f8f9fa; border-bottom: 2px solid #333;">',c+='<th style="padding: 12px; text-align: center; font-weight: bold; border: 1px solid #ddd; width: 40px;">Court #</th>',c+='<th style="padding: 12px; text-align: center; font-weight: bold; border: 1px solid #ddd; width: 45%;">Team 1</th>',c+='<th style="padding: 12px; text-align: center; font-weight: bold; border: 1px solid #ddd; width: 45%;">Team 2</th>',c+='<th style="padding: 12px; text-align: center; font-weight: bold; border: 1px solid #ddd; width: 80px;">',c+=`<button onclick="${u?"unlockAllMatches()":"lockAllMatches()"}" style="padding: 4px 8px; font-size: 12px; cursor: pointer; font-weight: bold;">${u?"Unlock All":"Lock All"}</button>`,c+="</th>",c+="</tr>",a.forEach((t,a)=>{const n=t.isManual||!1;c+="<tr "+(n?'style="background: #e6e6e6;"':"")+">";const r=e=>2===e.length&&Math.abs(e[0].grade-e[1].grade)>1,o=r(t.team1),u=r(t.team2);if(c+='<td style="padding: 8px; text-align: center; border: 1px solid #ddd; vertical-align: middle;">',c+='<div class="'+(n?"court-box manual":"court-box")+'" draggable="true" data-type="court" data-match="'+a+'" data-court="'+t.court+'" ',c+='style="display: inline-block; background: white; color: black; border: 2px solid #333; ',c+='padding: 6px 10px; border-radius: 5px; font-weight: bold; cursor: move; user-select: none;">',c+=t.court,c+="</div></td>",c+='<td style="padding: 8px; border: 1px solid #ddd; vertical-align: middle;">',t.team1.forEach((t,r)=>{const u=i(t.name)?" nhc":"",m=d(t.name)?" nxd":"",p=n?" manual-match":"",g=o?" grade-gap":"",h=l.some(e=>e.matchIndex===a&&1===e.team&&e.players.includes(t.name)),f=s.some(e=>e.matchIndex===a&&(e.player1===t.name||e.player2===t.name));c+='<span class="player-box'+u+m+(h?" repeat-partner":"")+(f?" repeat-opponent":"")+p+g+'" draggable="true" ',c+='data-type="player" data-match="'+a+'" data-team="1" data-player="'+r+'" ',c+='data-name="'+t.name+'" data-grade="'+t.grade+'" ',c+='style="display: inline-block; background: white; border: 2px solid #ddd; padding: 4px 8px; margin: 2px; ',c+="border-radius: 5px; cursor: move; user-select: none; transition: all 0.2s ease;",i(t.name)&&d(t.name)?c+=" font-weight: bold;":i(t.name)?c+=" background-color: #add8e6; font-weight: bold;":d(t.name)&&(c+=" background-color: #ffffe0; font-weight: bold;"),h&&(c+=" background-color: #ff9800; border: 2px solid #f57c00; font-weight: bold;"),n&&(c+=" background-color: #fff8dc; border: 2px solid #ffc107;"),c+='">';const y=hasPlayedDownBefore(t.name,currentSetNumber)?"↓":"",S=getPlayerPlusMinus(t.name,e);c+=y+t.name+" ("+translateGrade(t.grade)+S+")",c+="</span>",0===r&&(c+=", ")}),c+="</td>",c+='<td style="padding: 8px; border: 1px solid #ddd; vertical-align: middle;">',t.team2.forEach((t,r)=>{const o=i(t.name)?" nhc":"",m=d(t.name)?" nxd":"",p=n?" manual-match":"",g=u?" grade-gap":"",h=l.some(e=>e.matchIndex===a&&2===e.team&&e.players.includes(t.name)),f=s.some(e=>e.matchIndex===a&&(e.player1===t.name||e.player2===t.name));c+='<span class="player-box'+o+m+(h?" repeat-partner":"")+(f?" repeat-opponent":"")+p+g+'" draggable="true" ',c+='data-type="player" data-match="'+a+'" data-team="2" data-player="'+r+'" ',c+='data-name="'+t.name+'" data-grade="'+t.grade+'" ',c+='style="display: inline-block; background: white; border: 2px solid #ddd; padding: 4px 8px; margin: 2px; ',c+="border-radius: 5px; cursor: move; user-select: none; transition: all 0.2s ease;",i(t.name)&&d(t.name)?c+=" font-weight: bold;":i(t.name)?c+=" background-color: #add8e6; font-weight: bold;":d(t.name)&&(c+=" background-color: #ffffe0; font-weight: bold;"),h&&(c+=" background-color: #ff9800; border: 2px solid #f57c00; font-weight: bold;"),n&&(c+=" background-color: #fff8dc; border: 2px solid #ffc107;"),c+='">';const y=hasPlayedDownBefore(t.name,currentSetNumber)?"↓":"",S=getPlayerPlusMinus(t.name,e);c+=y+t.name+" ("+translateGrade(t.grade)+S+")",c+="</span>",0===r&&(c+=", ")}),c+="</td>",c+='<td style="padding: 8px; text-align: center; border: 1px solid #ddd;">',t.isManual){const e=manualMatches.findIndex(e=>e.court===t.court&&e.team1.length===t.team1.length&&e.team1.every((e,a)=>e.name===t.team1[a].name));c+=`<button onclick="removeManualMatch(${e})" style="padding: 4px 8px; font-size: 12px; cursor: pointer; background: #28a745; color: white; border: none; border-radius: 3px;">Unlock</button>`}else c+=`<button onclick="lockMatch(${a})" style="padding: 4px 8px; font-size: 12px; cursor: pointer;">Lock</button>`;c+="</td>",c+="</tr>"}),c+="</table>",c+='\n<div style="background: #f8f9fa; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin: 20px 0;">\n  <div style="font-weight: bold; font-size: 16px; margin-bottom: 10px; color: #333;">Player Color Legend:</div>\n  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px;">\n    <div style="display: flex; align-items: center; gap: 8px; font-size: 14px;">\n      <div style="width: 40px; height: 20px; border: 2px solid #ddd; border-radius: 4px; font-size: 11px; text-align: center; line-height: 16px; font-weight: bold; background-color: #add8e6;">NHC</div>\n      <span>No Hard Courts</span>\n    </div>\n    <div style="display: flex; align-items: center; gap: 8px; font-size: 14px;">\n      <div style="width: 40px; height: 20px; border: 2px solid #ddd; border-radius: 4px; font-size: 11px; text-align: center; line-height: 16px; font-weight: bold; background-color: #ffffe0;">NXD</div>\n      <span>No Mixed Doubles</span>\n    </div>\n    <div style="display: flex; align-items: center; gap: 8px; font-size: 14px;">\n      <div style="width: 40px; height: 20px; border: 2px solid #ddd; border-radius: 4px; font-size: 11px; text-align: center; line-height: 16px; font-weight: bold; background: linear-gradient(90deg, #add8e6 0%, #ffffe0 100%);">Both</div>\n      <span>NHC + NXD</span>\n    </div>\n<div style="display: flex; align-items: center; gap: 8px; font-size: 14px;">\n  <div style="width: 40px; height: 20px; border: 2px solid #ff8c42; border-radius: 4px; font-size: 11px; text-align: center; line-height: 16px; font-weight: bold; background: repeating-linear-gradient(45deg, white 0px, white 6px, #ff8c42 6px, #ff8c42 7px);">GAP</div>\n  <span>Grade gap >1</span>\n</div>\n    <div style="display: flex; align-items: center; gap: 8px; font-size: 14px;">\n      <div style="width: 40px; height: 20px; border: 2px solid #f57c00; border-radius: 4px; font-size: 11px; text-align: center; line-height: 16px; font-weight: bold; background-color: #ff9800;">RPP</div>\n      <span>Repeat Partner (all)</span>\n    </div>\n    <div style="display: flex; align-items: center; gap: 8px; font-size: 14px;">\n      <div style="width: 40px; height: 20px; border: 3px dashed #dc3545; border-radius: 4px; font-size: 11px; text-align: center; line-height: 14px; font-weight: bold; background-color: white;">RO</div>\n      <span>Repeat Opponent (last 2 sets)</span>\n    </div>\n    <div style="display: flex; align-items: center; gap: 8px; font-size: 14px;">\n      <div style="display: flex; align-items: center; gap: 8px; font-size: 14px;">\n  <div style="width: 40px; height: 20px; border: 2px solid #666666; border-radius: 4px; font-size: 11px; text-align: center; line-height: 16px; font-weight: bold; background-color: #e6e6e6;">MAN</div>\n  <span>Manual Match</span>\n</div>\n    </div>\n<div style="display: flex; align-items: center; gap: 8px; font-size: 14px;">\n      <div style="color: #cc0000; font-weight: bold; font-size: 16px;">↓</div>\n      <span>Played down previously</span>\n    </div>\n  </div>\n</div>',o.innerHTML=c,r.style.display="block",currentMatches=a,setTimeout(()=>initializeDragAndDrop(),100),saveDataToStorage()}function updateManualMatchDisplay(){}function removeManualMatch(e){const t=manualMatches[e];if(currentMatches){const e=currentMatches.findIndex(e=>e.court===t.court&&e.team1.length===t.team1.length&&e.team1.every((e,a)=>e.name===t.team1[a].name));-1!==e&&(currentMatches[e].isManual=!1)}manualMatches.splice(e,1),currentMatches&&currentMatches.length>0&&refreshDisplay(),saveDataToStorage(),console.log(`Manual match removed: Court ${t.court}`)}function lockAllMatches(){currentMatches.forEach((e,t)=>{if(!e.isManual){const a={court:e.court,team1:[...e.team1],team2:[...e.team2],format:e.format,note:"Locked after adjustments",isManual:!0};manualMatches.push(a),currentMatches[t].isManual=!0,[...e.team1,...e.team2].forEach(e=>{const t=document.querySelector(`[data-player-name="${e.name}"]`);t&&t.classList.add("excluded")});const n=document.querySelector(`[data-court="${e.court}"]`);n&&n.classList.add("excluded")}}),updateManualMatchDisplay(),refreshDisplay()}function unlockAllMatches(){[...manualMatches].forEach(()=>{manualMatches.length>0&&removeManualMatch(0)})}function lockMatch(e){if(currentMatches[e].isManual)return void alert("This match is already protected");const t=currentMatches[e],a={court:t.court,team1:[...t.team1],team2:[...t.team2],format:t.format,note:"Locked after adjustments",isManual:!0};manualMatches.push(a),currentMatches[e].isManual=!0,[...t.team1,...t.team2].forEach(e=>{const t=document.querySelector(`[data-player-name="${e.name}"]`);t&&t.classList.add("excluded")});const n=document.querySelector(`[data-court="${t.court}"]`);n&&n.classList.add("excluded"),updateManualMatchDisplay(),refreshDisplay()}function initializeDragAndDrop(){log("Initializing drag and drop");let e=null,t=null;const a=document.getElementById("matchResults");if(!a)return;const n=a.cloneNode(!0);a.parentNode.replaceChild(n,a),n.addEventListener("dragstart",function(a){"true"===a.target.getAttribute("draggable")&&(e=a.target,t=a.target.classList.contains("sat-off-player")?{type:"sat-off-player",name:a.target.dataset.name,grade:parseInt(a.target.dataset.grade)}:{type:a.target.dataset.type,match:parseInt(a.target.dataset.match),team:a.target.dataset.team,player:parseInt(a.target.dataset.player),court:a.target.dataset.court,name:a.target.dataset.name,grade:a.target.dataset.grade},a.target.classList.add("dragging"),log("Dragging: "+(t.name||t.court)))}),n.addEventListener("dragend",function(e){"true"===e.target.getAttribute("draggable")&&(e.target.classList.remove("dragging"),n.querySelectorAll(".drag-over").forEach(e=>e.classList.remove("drag-over")),stopAutoScroll())}),n.addEventListener("dragover",function(e){e.preventDefault(),checkAutoScroll(e)}),n.addEventListener("dragenter",function(e){(e.target.classList.contains("player-box")||e.target.classList.contains("court-box"))&&e.target.classList.add("drag-over")}),n.addEventListener("dragleave",function(e){(e.target.classList.contains("player-box")||e.target.classList.contains("court-box"))&&e.target.classList.remove("drag-over")}),n.addEventListener("drop",function(a){if(a.preventDefault(),!e||!t)return;const n=a.target;if(n!==e){if(n.classList.remove("drag-over"),"player"===t.type&&n.classList.contains("player-box")){const e={match:parseInt(n.dataset.match),team:n.dataset.team,player:parseInt(n.dataset.player),name:n.dataset.name};log("Swapping players: "+t.name+" ↔ "+e.name),swapPlayers(t,e),allSetsData[currentSetNumber]&&(allSetsData[currentSetNumber].matches=JSON.parse(JSON.stringify(currentMatches))),refreshDisplay()}else if("court"===t.type&&n.classList.contains("court-box")){const e=parseInt(n.dataset.match),a=n.dataset.court;log("Swapping courts: "+t.court+" ↔ "+a),swapCourts(t.match,e),allSetsData[currentSetNumber]&&(allSetsData[currentSetNumber].matches=JSON.parse(JSON.stringify(currentMatches))),refreshDisplay()}else if("sat-off-player"===t.type&&n.classList.contains("player-box")&&!n.classList.contains("sat-off-player")){const e={match:parseInt(n.dataset.match),team:n.dataset.team,player:parseInt(n.dataset.player),name:n.dataset.name};log("Swapping sat-off player: "+t.name+" ↔ "+e.name),swapSatOffWithPlayer(t,e),refreshDisplay()}e=null,t=null,stopAutoScroll()}})}function swapPlayers(e,t){const a=currentMatches[e.match],n=currentMatches[t.match],r="1"===e.team?a.team1:a.team2,o="1"===t.team?n.team1:n.team2,l={...r[e.player]};r[e.player]={...o[t.player]},o[t.player]=l,updateMatchFormat(currentMatches[e.match]),updateMatchFormat(currentMatches[t.match])}function updateMatchFormat(e){if(!e||!e.team1||!e.team2)return;console.log("currentData:",currentData),console.log("sortedMen:",currentData.sortedMen),console.log("sortedWomen:",currentData.sortedWomen),console.log("First player from team1:",e.team1[0]);const t=e.team1.filter(e=>"M"===getPlayerGender(e.name,currentData)).length,a=e.team1.filter(e=>"F"===getPlayerGender(e.name,currentData)).length,n=e.team2.filter(e=>"M"===getPlayerGender(e.name,currentData)).length,r=e.team2.filter(e=>"F"===getPlayerGender(e.name,currentData)).length;e.format=1===t&&1===a&&1===n&&1===r?"Mixed Doubles":2===t&&2===n?"Same-Sex Doubles (Men)":2===a&&2===r?"Same-Sex Doubles (Women)":"Mixed Gender"}function getPlayerGender(e,t){let a=t.sortedMen?t.sortedMen.find(t=>t.name===e):null,n=t.sortedWomen?t.sortedWomen.find(t=>t.name===e):null;return!a&&t.availableMen&&(a=t.availableMen.find(t=>t.name===e)),!n&&t.availableWomen&&(n=t.availableWomen.find(t=>t.name===e)),a?"M":n?"F":null}function swapCourts(e,t){const a=currentMatches[e].court;currentMatches[e].court=currentMatches[t].court,currentMatches[t].court=a}function swapSatOffWithPlayer(e,t){const a=playerRows.find(t=>t.name===e.name);a&&(a.so=!1);const n=playerRows.find(e=>e.name===t.name);n&&(n.so=!0);const r=currentMatches[t.match],o="1"===t.team?r.team1:r.team2;o[t.player];o[t.player]={name:e.name,grade:e.grade,nhc:a.nhc,nxd:a.nxd,plusMinus:a.plusMinus},updateMatchFormat(r),allSetsData[currentSetNumber]&&(allSetsData[currentSetNumber].matches=JSON.parse(JSON.stringify(currentMatches)),allSetsData[currentSetNumber].satOffPlayers=playerRows.filter(e=>e.so).map(e=>e.name)),saveDataToStorage(),log(`Swapped ${e.name} (was sitting off) with ${t.name} (now sitting off)`)}function refreshDisplay(){updatePlayerTableSOStatus(),displayResults(currentData,currentMatches)}function updatePlayerTableSOStatus(){const e=playerRows.filter(e=>e.so).map(e=>e.name);playerRows.forEach((e,t)=>{const a=document.getElementById(`so-${t}`);a&&(a.checked=e.so)}),log(`Updated player table SO status: ${e.length} players sitting off`)}function startAutoScroll(e,t){stopAutoScroll(),autoScrollSpeed=t,autoScrollInterval=setInterval(()=>{"up"===e?window.scrollBy(0,-autoScrollSpeed):"down"===e&&window.scrollBy(0,autoScrollSpeed)},16)}function stopAutoScroll(){autoScrollInterval&&(clearInterval(autoScrollInterval),autoScrollInterval=null,autoScrollSpeed=0)}function checkAutoScroll(e){const t=window.innerHeight,a=e.clientY;if(a<50){const e=(50-a)/50;startAutoScroll("up",Math.max(1,8*e))}else if(a>t-50){const e=(a-(t-50))/50;startAutoScroll("down",Math.max(1,8*e))}else stopAutoScroll()}function printMatchSheet(e,t){try{const n=window.open("","_blank","width=1200,height=800"),r=parseInt(document.getElementById("setNumberSelector").value),o=playerRows.filter(e=>e.name&&e.so).map(e=>e.name);let l=`\n<!DOCTYPE html>\n<html>\n<head>\n  <meta charset="UTF-8">\n  <title>Tennis Match Sheet - Set ${r}</title>\n  <style>\n    body { \n      font-family: Arial, sans-serif; \n      margin: 20px; \n      background: white; \n      color: black;\n      line-height: 1.4;\n    }\n   .header { \n  margin-bottom: 20px; \n  border-bottom: 1px solid black; \n  padding-bottom: 10px;\n}\n.header-info { \n  font-size: 16px; \n  font-weight: bold;\n  margin: 0;\n}\n    .sat-off-section { \n      background: #f0f0f0; \n      border: 2px solid black; \n      padding: 15px; \n      margin: 20px 0; \n      border-radius: 5px;\n    }\n    .sat-off-title { \n      font-size: 18px; \n      font-weight: bold; \n      margin-bottom: 10px;\n    }\n   .matches-grid {\n  display: grid;\n  grid-template-columns: repeat(3, 1fr);\n  gap: 15px;\n  margin: 20px 0;\n}\n    .match-card {\n      border: 2px solid #333;\n      padding: 15px;\n      border-radius: 8px;\n      background: white;\n      break-inside: avoid;\n    }\n    .match-card.manual {\n      background: #fff8dc;\n      border-color: #ffc107;\n    }\n    .team {\n      margin-bottom: 15px;\n    }\n    .player-line {\n  margin: 8px 0;\n  font-size: 14px;\n  display: flex;\n  align-items: center;\n z-index: 11;\n  position: relative;\n}\n.player-info {\n  width: 220px;\n  flex-shrink: 0;\noverflow: visible;\n  z-index: 1;\n}\n.player-name {\n  font-weight: bold;\n}\n.court-boxes { \n  display: flex; \n  gap: 2px; \n  z-index: 10;\n  position: relative;\n}\n.court-box {\n  width: 20px;\n  height: 20px;\n  border: 1px solid #333;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  font-size: 10px;\n  font-weight: bold;\n  background: white;\n  flex-shrink: 0;\n z-index: 11;\n  position: relative;\n}\n    .court-box.filled {\n      background: white;\n    }\n    .court-box.team2 {\n  background: white;\n}\n    .court-box.sat-off {\n      background: white;\n    }\n    @media print {\n      body { margin: 15px; font-size: 12px; }\n      .matches-grid { grid-template-columns: repeat(2, 1fr); gap: 15px; }\n      .match-card { padding: 10px; }\n      .player-line { font-size: 12px; }\n      .court-box { width: 18px; height: 18px; font-size: 9px; }\n    }\n  </style>\n</head>\n<body>\n  <div class="header">\n  <div style="display: flex; justify-content: space-between; align-items: center;">\n    <div class="header-info">Date: ${(new Date).toLocaleDateString()}</div>\n    <div class="header-info">Set Number: ${r}</div>\n    <div class="header-info">Format: ${e.setFormatPreference}</div>\n  </div>\n</div>\n`;function a(e){const a=[];for(let n=1;n<=6;n++){let l=!1,s="",c="court-box";n<=r&&(n===r?t.forEach(t=>{const a=t.team1.some(t=>t.name===e),n=t.team2.some(t=>t.name===e);a?(s=t.court,c="court-box filled",l=!0):n&&(s=t.court+".",c="court-box filled",l=!0)}):allSetsData[n]&&allSetsData[n].matches&&allSetsData[n].matches.forEach(t=>{const a=t.team1.some(t=>t.name===e),n=t.team2.some(t=>t.name===e);a?(s=t.court,c="court-box filled",l=!0):n&&(s=t.court+".",c="court-box filled",l=!0)}),l||(n<r&&allSetsData[n]&&allSetsData[n].satOffPlayers&&allSetsData[n].satOffPlayers.includes(e)||n===r&&o.includes(e))&&(s="X",c="court-box sat-off")),a.push(`<div class="${c}">${s}</div>`)}return a.join("")}o.length>0&&(l+=`\n  <div class="sat-off-section">\n    <div class="sat-off-title">Players Sitting Off This Set:</div>\n    <div class="sat-off-list">${o.join(", ")}</div>\n  </div>\n`),l+='<div class="matches-grid">',t.forEach((e,t)=>{const n=e.isManual||!1;l+=`<div class="${n?"match-card manual":"match-card"}">`,l+='<div class="team">',e.team1.forEach(e=>{l+='<div class="player-line">',l+='<div class="player-info">',l+=`<span class="player-name">${e.name}</span> (${translateGrade(e.grade)})`,l+="</div>",l+=`<div class="court-boxes">${a(e.name)}</div>`,l+="</div>"}),l+="</div>",l+='<div class="team" style="margin-top: 15px;">',e.team2.forEach(e=>{l+='<div class="player-line">',l+='<div class="player-info">',l+=`<span class="player-name">${e.name}</span> (${translateGrade(e.grade)})`,l+="</div>",l+=`<div class="court-boxes">${a(e.name)}</div>`,l+="</div>"}),l+="</div>",l+="</div>"}),l+="</div>",l+="</body></html>",n.document.write(l),n.document.close(),setTimeout(()=>{n.focus(),n.print()},250),log("Print dialog opened for match sheet with court history boxes")}catch(s){alert("Error creating print sheet: "+s.message),log("Error creating print sheet: "+s.message)}}function openFullScreenDisplay(){if(!currentData||!currentMatches)return void alert("No matches to display. Please generate matches first.");const e=window.open("","_blank","fullscreen=yes,scrollbars=no,menubar=no,toolbar=no,location=no,status=no"),t=parseInt(document.getElementById("setNumberSelector").value),a=playerRows.filter(e=>e.name&&e.so).map(e=>e.name);let n=`\n<!DOCTYPE html>\n<html>\n<head>\n  <meta charset="UTF-8">\n  <title>Tennis Match Sheet - Set ${t}</title>\n  <style>\n   <head>\n  <meta charset="UTF-8">\n  <title>Tennis Match Sheet - Set ${t}</title>\n  <style>\n    body { \n      font-family: Arial, sans-serif; \n      margin: 5px; \n      background: white; \n      color: black;\n      line-height: 1.3;\n    }\n@page { size: landscape; }\n   \n    .sat-off-section { \n      background: #f0f0f0; \n      border: 2px solid black; \n      padding: 15px; \n      margin: 20px 0; \n      border-radius: 5px;\n    }\n    .sat-off-title { \n      font-size: 18px; \n      font-weight: bold; \n      margin-bottom: 10px;\n    }\n    .sat-off-list { \n      font-size: 16px; \n      font-weight: bold;\n    }\n \n   .matches-container {\n  display: flex;\n  gap: 40px;\n  justify-content: space-between;\nmargin: 0;\n}\n\n.match-table {\n      width: 48%;\n      border-collapse: collapse;\n      margin: 20px 0;\n    }\n    .match-table th {\n      background: #f8f9fa;\n      border: 2px solid #333;\n      padding: 8px 12px;\n      text-align: center;\n      font-weight: bold;\n      font-size: 16px;\n    }\n    .match-table td {\n      border: 1px solid #333;\n     padding: 4px 8px;  /* Changed from 8px to 4px 8px */\n      vertical-align: middle;\n    }\n  \n    .court-number {\n  background: none;  /* Changed from white */\n  color: black;\n  border: none;      /* Changed from 2px solid #333 */\n  padding: 0;        /* Changed from 6px 10px */\n  border-radius: 0;  /* Changed from 5px */\n  font-weight: bold;\n  display: inline-block;\n}\n    .team-cell {\n      font-size: 18px;\n    }\n    .match-table th:nth-child(1) {\n      width: 60px;\n    }\n    .match-table th:nth-child(2), .match-table th:nth-child(3) {\n      width: 42%;\n    }\n  </style>\n</head>\n<body>\n\n`;a.length>0&&(n+=`\n  <div class="sat-off-section">\n    <div class="sat-off-title">Players Sitting Off This Set:</div>\n    <div class="sat-off-list">${a.join(", ")}</div>\n  </div>\n`);const r=Math.ceil(currentMatches.length/2);n+='\n<div class="matches-container">\n  <table class="match-table">\n    <tr>\n      <th>Court #</th>\n      <th>Team 1</th>\n      <th>Team 2</th>\n    </tr>\n';for(let e=0;e<r;e++){const t=currentMatches[e],a=t.team1.map(e=>`${e.name} (${translateGrade(e.grade)})`).join(", "),r=t.team2.map(e=>`${e.name} (${translateGrade(e.grade)})`).join(", ");n+=`\n  <tr${t.isManual||!1?' class="manual"':""}>\n    <td style="text-align: center;">\n      <div class="court-number">${t.court}</div>\n    </td>\n    <td class="team-cell">${a}</td>\n    <td class="team-cell">${r}</td>\n  </tr>\n`}n+='\n  </table>\n  <table class="match-table">\n    <tr>\n      <th>Court #</th>\n      <th>Team 1</th>\n      <th>Team 2</th>\n    </tr>\n';for(let e=r;e<currentMatches.length;e++){const t=currentMatches[e],a=t.team1.map(e=>`${e.name} (${translateGrade(e.grade)})`).join(", "),r=t.team2.map(e=>`${e.name} (${translateGrade(e.grade)})`).join(", ");n+=`\n  <tr${t.isManual||!1?' class="manual"':""}>\n    <td style="text-align: center;">\n      <div class="court-number">${t.court}</div>\n    </td>\n    <td class="team-cell">${a}</td>\n    <td class="team-cell">${r}</td>\n  </tr>\n`}n+="\n  </table>\n</div>\n",n+="\n  </table>\n</body>\n</html>",e.document.write(n),e.document.close(),e.focus()}function downloadResults(e,t){try{const a=XLSX.utils.book_new(),n=Object.keys(allSetsData).sort((e,t)=>parseInt(e)-parseInt(t));0===n.length?createSingleSetSheet(a,e,t,currentSetNumber):n.forEach(e=>{const t=allSetsData[e];createSingleSetSheet(a,t.data,t.matches,e,t.satOffPlayers)});const r=(new Date).toISOString().slice(0,19).replace(/:/g,"-"),o=`Tennis_Matches_${n.length||1}_Sets_${r}.xlsx`;XLSX.writeFile(a,o),log("Excel file downloaded: "+o+" with "+(n.length||1)+" sheets")}catch(e){alert("Error creating Excel file: "+e.message),log("Error creating Excel file: "+e.message)}}function createSingleSetSheet(e,t,a,n,r=[]){const o=[];o.push(["Date",(new Date).toISOString().split("T")[0]]),o.push(["Set Number","Set "+n]),o.push(["Set Format Preference",t.setFormatPreference]),o.push([]),o.push(["Court","Team 1","Team 2","Match Format","Match Type","Sat Off Players","","Total Men Players","Grade","NHC","Resting","+/-","PSO","","Total Women Players","Grade","NHC","Resting","+/-","PSO"]);const l=Math.max(a.length,t.availableMen.length,t.availableWomen.length);for(let e=0;e<l;e++){const n=["","","","","","",""];if(e<a.length){const t=a[e],o=t.team1.map(e=>`${e.name} (${translateGrade(e.grade)})`).join(", "),l=t.team2.map(e=>`${e.name} (${translateGrade(e.grade)})`).join(", "),s=e<r.length?r[e]:"",c=t.isManual?"Manual":"Auto";n[0]=t.court,n[1]=o,n[2]=l,n[3]=t.format,n[4]=c,n[5]=s,n[6]=""}if(e<t.availableMen.length){const a=t.availableMen[e];n[7]=a.name,n[8]=translateGrade(a.grade),n[9]=a.nhc?"y":"",n[10]=a.resting?"y":"",n[11]=a.plusMinus||"",n[12]=a.pso?"y":""}if(n[13]="",e<t.availableWomen.length){const a=t.availableWomen[e];n[14]=a.name,n[15]=translateGrade(a.grade),n[16]=a.nhc?"y":"",n[17]=a.resting?"y":"",n[18]=a.plusMinus||"",n[19]=a.pso?"y":""}o.push(n)}const s=XLSX.utils.aoa_to_sheet(o);s["!cols"]=[{wch:20},{wch:50},{wch:50},{wch:25},{wch:10},{wch:20},{wch:3},{wch:20},{wch:8},{wch:6},{wch:8},{wch:6},{wch:6},{wch:3},{wch:20},{wch:8},{wch:6},{wch:8},{wch:6},{wch:6}],XLSX.utils.book_append_sheet(e,s,"Set "+n+" Summary")}function exportAsInputFiles(){try{const e=Object.keys(allSetsData).sort((e,t)=>parseInt(e)-parseInt(t));if(0===e.length)return void alert("No completed sets to export.");alert(`Preparing to export ${e.length} input file(s). Files will download with a short delay between each.`),e.forEach((t,a)=>{setTimeout(()=>{const n=allSetsData[t];createInputFileForSet(t,n),a===e.length-1&&setTimeout(()=>{alert(`Export complete! ${e.length} file(s) should now be in your Downloads folder.`)},500)},1e3*a)})}catch(e){alert(`Error creating input files: ${e.message}`),console.error("Export error:",e)}}function createInputFileForSet(e,t){const a=XLSX.utils.book_new(),n=[["Men's Name","Men's Grade","Men's NHC","Men's NXD","Men's +/-","","Women's Name","Women's Grade","Women's NHC","Women's NXD","Women's +/-"]],r=[],o=[];t.matches.forEach(e=>{[...e.team1,...e.team2].forEach(e=>{const a=findPlayerFullData(e.name,t.data);a&&("M"!==a.gender||r.some(t=>t.name===e.name)?"F"!==a.gender||o.some(t=>t.name===e.name)||o.push(a):r.push(a))})}),t.satOffPlayers&&t.satOffPlayers.forEach(e=>{const a=findPlayerFullData(e,t.data);a&&("M"!==a.gender||r.some(t=>t.name===e)?"F"!==a.gender||o.some(t=>t.name===e)||o.push(a):r.push(a))}),r.sort((e,t)=>t.grade-e.grade),o.sort((e,t)=>t.grade-e.grade);const l=Math.max(r.length,o.length);for(let e=0;e<l;e++){const t=[];if(e<r.length){const a=r[e];t.push(a.name),t.push(translateGrade(a.grade)),t.push(a.nhc?"y":""),t.push(a.nxd?"y":""),t.push(a.plusMinus||"")}else t.push("","","","","");if(t.push(""),e<o.length){const a=o[e];t.push(a.name),t.push(translateGrade(a.grade)),t.push(a.nhc?"y":""),t.push(a.nxd?"y":""),t.push(a.plusMinus||"")}else t.push("","","","","");n.push(t)}const s=XLSX.utils.aoa_to_sheet(n);s["!cols"]=[{wch:20},{wch:10},{wch:8},{wch:8},{wch:6},{wch:3},{wch:20},{wch:10},{wch:8},{wch:8},{wch:6}],XLSX.utils.book_append_sheet(a,s,"Today's Players");const c=[["Priority","Court"]];t.data&&t.data.courts?t.data.courts.forEach((e,t)=>{c.push([t+1,e.court])}):availableCourts&&availableCourts.length>0&&availableCourts.forEach((e,t)=>{c.push([t+1,e])});const i=XLSX.utils.aoa_to_sheet(c);i["!cols"]=[{wch:10},{wch:15}],XLSX.utils.book_append_sheet(a,i,"Available Courts");const d=`Tennis_Set_${e}_Input_${(new Date).toISOString().slice(0,10)}.xlsx`;XLSX.writeFile(a,d),console.log(`Exported input file for Set ${e}: ${d}`)}function findPlayerFullData(e,t){if(t.availableMen){const a=t.availableMen.find(t=>t.name===e);if(a)return{...a,gender:"M"}}if(t.availableWomen){const a=t.availableWomen.find(t=>t.name===e);if(a)return{...a,gender:"F"}}if(t.sortedMen){const a=t.sortedMen.find(t=>t.name===e);if(a)return{...a,gender:"M"}}if(t.sortedWomen){const a=t.sortedWomen.find(t=>t.name===e);if(a)return{...a,gender:"F"}}const a=playerRows.find(t=>t.name===e);return a||null}function parseGrade(e){return e?reverseTranslateGrade(e.toString().trim()):null}function parseBoolean(e){if(!e)return!1;if("boolean"==typeof e)return e;if("string"==typeof e){const t=e.toString().trim().toLowerCase();return"y"===t||"yes"===t||"true"===t||"1"===t}return"number"==typeof e&&1===e}function parsePlusMinus(e){if(!e)return"";if("string"==typeof e){const t=e.toString().trim();if("+"===t||"-"===t)return t}return""}function refreshPlayerTable(){document.getElementById("playerTableBody").innerHTML="",playerRows.forEach((e,t)=>{addPlayerRowAtIndex(t),e.name&&(document.querySelector(`[data-row="${t}"]`).value=e.name,document.getElementById(`grade-${t}`).value=e.grade,document.getElementById(`gender-${t}`).value=e.gender,document.getElementById(`nhc-${t}`).checked=e.nhc,document.getElementById(`nxd-${t}`).checked=e.nxd,document.getElementById(`plusminus-${t}`).value=e.plusMinus||"",document.getElementById(`resting-${t}`).checked=e.resting,document.getElementById(`pso-${t}`).checked=e.pso,document.getElementById(`so-${t}`).checked=e.so,e.name&&e.grade&&e.gender&&(document.querySelector(`[data-row="${t}"].delete-player-btn`).style.display="block"))})}availableCourtsDiv.addEventListener("dragover",e=>{e.preventDefault(),availableCourtsDiv.classList.add("drag-over")}),availableCourtsDiv.addEventListener("dragleave",e=>{availableCourtsDiv.classList.remove("drag-over")}),availableCourtsDiv.addEventListener("drop",e=>{e.preventDefault(),availableCourtsDiv.classList.remove("drag-over");const t=e.dataTransfer.getData("text/plain");if(t&&!availableCourts.includes(t)){availableCourts.push(t),updateAvailableCourtsDisplay();const e=document.querySelector(`[data-court="${t}"]`);e&&"courtPool"===e.parentElement.id&&e.remove()}}),document.getElementById("clearCourts").addEventListener("click",()=>{availableCourts=[],updateAvailableCourtsDisplay(),initializeCourts(),updateSitOffCalculation(),updateProceedButton(),saveDataToStorage(),checkForPlayerChangesAfterMatches()}),document.getElementById("addMoreRows").addEventListener("click",()=>{for(let e=0;e<10;e++)addPlayerRow()}),document.getElementById("sortPlayersBtn").addEventListener("click",()=>{toggleSortOrder()}),document.getElementById("updateMasterList").addEventListener("click",generateUpdatedMasterList),document.getElementById("setNumberSelector").addEventListener("change",function(){const e=parseInt(this.value),t=e-1;if(document.getElementById("formatSelector").value="Same-Sex",document.querySelectorAll(".format-btn").forEach(e=>{e.classList.remove("active"),"Same-Sex"===e.dataset.format&&e.classList.add("active")}),manualMatches=[],updateManualMatchDisplay(),selectedManualPlayers=[],selectedCourt=null,manualTeam1=[],manualTeam2=[],updateTeamDisplay(),updateAddMatchButton(),e>1&&allSetsData[t]){const a=allSetsData[t].satOffPlayers||[];playerRows.forEach((e,t)=>{if(a.includes(e.name)){e.so=!1,e.pso=!0;const a=document.getElementById(`so-${t}`),n=document.getElementById(`pso-${t}`);a&&(a.checked=!1),n&&(n.checked=!0)}}),console.log(`Moved ${a.length} players from SO to PSO for Set ${e}`),allSetsData[t].matches&&allSetsData[t].matches.forEach(e=>{e.court&&e.court.toString().toUpperCase().startsWith("H")&&[...e.team1,...e.team2].forEach(a=>{const n=playerRows.findIndex(e=>e.name===a.name);if(n>=0&&!playerRows[n].nhc){playerRows[n].nhc=!0;const r=document.getElementById(`nhc-${n}`);r&&(r.checked=!0),console.log(`Set NHC=true for ${a.name} (played on hard court ${e.court} in Set ${t})`)}})})}playerRows.forEach((e,t)=>{if(!e.pso){e.so=!1;const a=document.getElementById(`so-${t}`);a&&(a.checked=!1)}}),updateSitOffCalculation(),updateProceedButton(),document.getElementById("matches").style.display="none"}),document.getElementById("generateMatchesBtn").addEventListener("click",e=>{const t=e.target.dataset.action;if("generate"===t)processPlayersAndGenerateMatches();else if("suggest"===t)autoSelectSitOffPlayers();else if("clear-so"===t)playerRows.forEach((e,t)=>{if(e.so){e.so=!1;const a=document.getElementById(`so-${t}`);a&&(a.checked=!1)}}),updateSitOffCalculation(),updateProceedButton(),saveDataToStorage();else if("clear-excess"===t){const e=playerRows.filter(e=>e.name&&""!==e.name.trim()&&""!==e.grade&&""!==e.gender&&!e.resting),t=4*availableCourts.length,a=e.length%4,n=Math.max(0,e.length-t),r=Math.max(a,n);let o=0;playerRows.forEach((e,t)=>{if(e.so&&(o++,o>r)){e.so=!1;const a=document.getElementById(`so-${t}`);a&&(a.checked=!1)}}),updateSitOffCalculation(),updateProceedButton(),saveDataToStorage()}}),document.addEventListener("DOMContentLoaded",()=>{initializeCourts(),loadMemberListOnStartup(),setTimeout(()=>{loadDataFromStorage()},500)}),document.getElementById("downloadBtn").onclick=function(){currentData&&currentMatches?downloadResults(currentData,currentMatches):alert("No matches to download. Please generate matches first.")},document.getElementById("printBtn").onclick=function(){currentData&&currentMatches?printMatchSheet(currentData,currentMatches):alert("No matches to print. Please generate matches first.")},document.getElementById("fullScreenBtn").onclick=function(){openFullScreenDisplay()},document.getElementById("exportInputBtn").onclick=function(){currentData&&currentMatches?exportAsInputFiles():alert("No matches to export. Please generate matches first.")},document.getElementById("importExcelBtn").addEventListener("click",()=>{document.getElementById("excelFileInput").click()}),document.getElementById("excelFileInput").addEventListener("change",async e=>{const t=e.target.files[0];if(t){try{const e=await t.arrayBuffer(),a=XLSX.read(e,{type:"array"});if(!a.SheetNames.includes("Today's Players"))return void alert('Error: Excel file must contain a sheet named "Today\'s Players"');if(!a.SheetNames.includes("Available Courts"))return void alert('Error: Excel file must contain a sheet named "Available Courts"');const n=a.Sheets["Today's Players"],r=XLSX.utils.sheet_to_json(n,{header:1}),o=a.Sheets["Available Courts"],l=XLSX.utils.sheet_to_json(o,{header:1}),s=[];for(let e=1;e<r.length;e++){const t=r[e];if(t&&0!==t.length){if(t[0]&&"string"==typeof t[0]&&""!==t[0].trim()){const e=parseGrade(t[1]);null!==e&&s.push({name:t[0].trim(),grade:e,gender:"M",nhc:parseBoolean(t[2]),nxd:parseBoolean(t[3]),plusMinus:parsePlusMinus(t[4]),resting:!1,pso:!1,so:!1})}if(t[6]&&"string"==typeof t[6]&&""!==t[6].trim()){const e=parseGrade(t[7]);null!==e&&s.push({name:t[6].trim(),grade:e,gender:"F",nhc:parseBoolean(t[8]),nxd:parseBoolean(t[9]),plusMinus:parsePlusMinus(t[10]),resting:!1,pso:!1,so:!1})}}}const c=[];console.log("Courts sheet data:",l);for(let e=1;e<l.length;e++){const t=l[e];if(console.log(`Row ${e}:`,t),!t||t.length<2){console.log(`Skipping row ${e} - insufficient data`);continue}const a=parseInt(t[0]),n=t[1];console.log(`Row ${e}: priority=${a}, courtName="${n}"`);const r=!isNaN(a)&&a>0,o=null!=n&&""!==n.toString().trim();if(r&&o){const e={priority:a,court:n.toString().trim()};console.log("Adding court:",e),c.push(e)}else console.log(`Skipping row ${e} - invalid data: priority=${a}, courtName="${n}"`)}console.log("Final imported courts:",c),c.sort((e,t)=>e.priority-t.priority),playerRows=[],availableCourts=[],playerRows=[...s];const i=parseInt(document.getElementById("setNumberSelector").value);for(let e=1;e<i;e++)if(allSetsData[e]&&allSetsData[e].satOffPlayers){const t=allSetsData[e].satOffPlayers;playerRows.forEach(e=>{t.includes(e.name)&&(e.pso=!0)})}for(;playerRows.length<10;)playerRows.push({name:"",grade:"",gender:"",nhc:!1,nxd:!1,plusMinus:"",resting:!1,pso:!1,so:!1});availableCourts=c.map(e=>e.court),refreshPlayerTable(),updateAvailableCourtsDisplay(),initializeCourts(),availableCourts.forEach(e=>{const t=document.querySelector(`[data-court="${e}"]`);t&&"courtPool"===t.parentElement.id&&t.remove()}),updateSitOffCalculation(),updateProceedButton(),document.getElementById("memberLoadStatus").innerHTML=`<div class="success">✓ Imported ${s.length} players and ${c.length} courts from Excel file</div>`,saveDataToStorage(),checkForPlayerChangesAfterMatches()}catch(e){alert(`Error reading Excel file: ${e.message}`),console.error("Excel import error:",e)}e.target.value=""}}),document.addEventListener("DOMContentLoaded",function(){document.querySelectorAll(".format-btn").forEach(e=>{e.addEventListener("click",function(){document.querySelectorAll(".format-btn").forEach(e=>e.classList.remove("active")),this.classList.add("active"),document.getElementById("formatSelector").value=this.dataset.format,document.getElementById("formatSelector").dispatchEvent(new Event("change")),checkForPlayerChangesAfterMatches()})}),document.querySelectorAll(".set-btn").forEach(e=>{e.addEventListener("click",function(){document.querySelectorAll(".set-btn").forEach(e=>e.classList.remove("active")),this.classList.add("active"),document.getElementById("setNumberSelector").value=this.dataset.set,document.getElementById("setNumberSelector").dispatchEvent(new Event("change"))})})})</script></div></body></html>